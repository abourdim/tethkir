<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tethkir ‚Äî Task Memo v1.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Scheherazade+New:wght@400;700&family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style>
/* ===== CSS VARIABLES / THEME SYSTEM ===== */
:root {
  /* Default: Alhambra */
  --bg-primary: #1a0f0a;
  --bg-secondary: #2d1810;
  --bg-card: #3a2218;
  --bg-input: #4a3020;
  --text-primary: #f5e6d3;
  --text-secondary: #c4a882;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #f39c12;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
  --border: rgba(212,160,74,0.2);
  --shadow: rgba(0,0,0,0.4);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.4);
  --pattern-opacity: 0.06;
  --font-body: 'Poppins', sans-serif;
  --font-arabic: 'Amiri', 'Scheherazade New', serif;
  --font-display: 'Playfair Display', serif;
  --radius: 12px;
  --radius-lg: 20px;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== THEME: ALHAMBRA / ANDALUSIAN ===== */
[data-theme="alhambra"] {
  --bg-primary: #1a0f0a;
  --bg-secondary: #2d1810;
  --bg-card: #3a2218;
  --bg-input: #4a3020;
  --text-primary: #f5e6d3;
  --text-secondary: #c4a882;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --border: rgba(212,160,74,0.2);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.5);
  --pattern-opacity: 0.06;
}

/* ===== THEME: OTTOMAN ===== */
[data-theme="ottoman"] {
  --bg-primary: #0a1628;
  --bg-secondary: #122040;
  --bg-card: #1a2d54;
  --bg-input: #233a66;
  --text-primary: #e8e4df;
  --text-secondary: #8bacc4;
  --accent: #c9a84c;
  --accent-hover: #dbb960;
  --accent-glow: rgba(201,168,76,0.3);
  --border: rgba(201,168,76,0.2);
  --bismillah-color: #c9a84c;
  --bismillah-glow: rgba(201,168,76,0.5);
  --pattern-opacity: 0.08;
}

/* ===== THEME: MOROCCAN ZELLIGE ===== */
[data-theme="moroccan"] {
  --bg-primary: #0a1a12;
  --bg-secondary: #12291c;
  --bg-card: #1a3828;
  --bg-input: #224832;
  --text-primary: #f0ece4;
  --text-secondary: #8cc4a0;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --border: rgba(140,196,160,0.2);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.5);
  --pattern-opacity: 0.08;
}

/* ===== THEME: CALLIGRAPHY ===== */
[data-theme="calligraphy"] {
  --bg-primary: #f5f0e8;
  --bg-secondary: #ebe4d6;
  --bg-card: #fff9f0;
  --bg-input: #f0e8d8;
  --text-primary: #1a1408;
  --text-secondary: #5a4e3a;
  --accent: #8b6914;
  --accent-hover: #a07c1c;
  --accent-glow: rgba(139,105,20,0.2);
  --border: rgba(139,105,20,0.2);
  --bismillah-color: #2a1e0a;
  --bismillah-glow: rgba(42,30,10,0.15);
  --pattern-opacity: 0.04;
}

/* ===== THEME: RAMADAN NIGHT ===== */
[data-theme="ramadan"] {
  --bg-primary: #0a0a1e;
  --bg-secondary: #12122e;
  --bg-card: #1a1a3e;
  --bg-input: #24244e;
  --text-primary: #e8e4f0;
  --text-secondary: #9a8ec4;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.4);
  --border: rgba(212,160,74,0.15);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.6);
  --pattern-opacity: 0.05;
}

/* ===== THEME: DESERT OASIS ===== */
[data-theme="desert"] {
  --bg-primary: #f8f0e0;
  --bg-secondary: #efe4cc;
  --bg-card: #fff8ec;
  --bg-input: #f0e4d0;
  --text-primary: #2a2218;
  --text-secondary: #6a5e4a;
  --accent: #2e8b57;
  --accent-hover: #3aa06a;
  --accent-glow: rgba(46,139,87,0.2);
  --border: rgba(46,139,87,0.2);
  --bismillah-color: #8b6914;
  --bismillah-glow: rgba(139,105,20,0.2);
  --pattern-opacity: 0.04;
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
  overflow-x: hidden;
}

/* ===== GEOMETRIC PATTERN OVERLAY ===== */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 40px, var(--accent) 40px, var(--accent) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, var(--accent) 40px, var(--accent) 41px),
    repeating-linear-gradient(45deg, transparent, transparent 28px, var(--accent) 28px, var(--accent) 29px),
    repeating-linear-gradient(-45deg, transparent, transparent 28px, var(--accent) 28px, var(--accent) 29px);
  opacity: var(--pattern-opacity);
  pointer-events: none;
  z-index: 0;
}

/* ===== STARS for Ramadan theme ===== */
[data-theme="ramadan"] body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: 
    radial-gradient(1px 1px at 10% 15%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 25% 35%, rgba(212,160,74,0.6), transparent),
    radial-gradient(1px 1px at 40% 10%, rgba(212,160,74,0.7), transparent),
    radial-gradient(2px 2px at 55% 45%, rgba(212,160,74,0.5), transparent),
    radial-gradient(1px 1px at 70% 20%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 85% 55%, rgba(212,160,74,0.6), transparent),
    radial-gradient(1px 1px at 15% 65%, rgba(212,160,74,0.7), transparent),
    radial-gradient(2px 2px at 90% 80%, rgba(212,160,74,0.5), transparent),
    radial-gradient(1px 1px at 50% 75%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 35% 90%, rgba(212,160,74,0.6), transparent);
  pointer-events: none;
  z-index: 0;
  animation: twinkle 4s ease-in-out infinite alternate;
}

@keyframes twinkle {
  0% { opacity: 0.4; }
  100% { opacity: 0.8; }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

/* ===== APP CONTAINER ===== */
.app-container {
  position: relative;
  z-index: 1;
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
}

/* ===== BISMILLAH HEADER ===== */
.bismillah-inline {
  font-family: 'Aref Ruqaa', 'Amiri', serif;
  font-size: 0.75em;
  color: var(--bismillah-color);
  opacity: 0.35;
  direction: rtl;
  white-space: nowrap;
  user-select: none;
}

/* ===== SIMPLE MODE ===== */
body.simple-mode .profiles-bar { display: none !important; }
body.simple-mode .task-form-grid .form-group:not(.full-width) { display: none !important; }
body.simple-mode .search-filter-bar { display: none !important; }
body.simple-mode .task-meta { display: none !important; }
body.simple-mode .kb-toggle-btn { display: none !important; }
body.simple-mode .help-toggle-btn { display: none !important; }
body.simple-mode .secure-notes-section { display: none !important; }
body.simple-mode .simple-notes-section { display: block !important; }
body.simple-mode .task-form-grid { grid-template-columns: 1fr !important; }
body.simple-mode .task-item { padding-left: 16px; }
body.simple-mode .bismillah-inline { display: none; }

body:not(.simple-mode) .simple-notes-section { display: none !important; }

.simple-notes-section .simple-note-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 10px;
}
.simple-notes-section .simple-note-card h4 {
  color: var(--accent);
  font-size: 1em;
  margin: 0 0 6px 0;
}
.simple-notes-section .simple-note-card p {
  color: var(--text-secondary);
  font-size: 0.9em;
  margin: 0;
  white-space: pre-wrap;
  line-height: 1.5;
}
.simple-notes-section .simple-note-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  justify-content: flex-end;
}

/* ===== TOP BAR ===== */
.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  margin-bottom: 20px;
  border: 1px solid var(--border);
}

.top-bar-left, .top-bar-right {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.app-title {
  font-family: var(--font-display);
  font-size: 1.3em;
  font-weight: 700;
  color: var(--accent);
}

/* ===== BUTTONS ===== */
.btn {
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85em;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.btn:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px var(--accent-glow);
}

.btn-accent {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  font-weight: 600;
}

.btn-accent:hover {
  background: var(--accent-hover);
  border-color: var(--accent-hover);
}

.btn-danger {
  border-color: var(--danger);
  color: var(--danger);
}
.btn-danger:hover {
  background: var(--danger);
  color: white;
  border-color: var(--danger);
}

.btn-sm {
  padding: 5px 10px;
  font-size: 0.8em;
}

.btn-icon {
  padding: 6px 8px;
  min-width: 34px;
  justify-content: center;
}

/* ===== SELECT / INPUT ===== */
select, input, textarea {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.9em;
  transition: border-color var(--transition), box-shadow var(--transition);
  outline: none;
}

select:focus, input:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

textarea { resize: vertical; min-height: 80px; }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  padding: 4px;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  margin-bottom: 20px;
  border: 1px solid var(--border);
  overflow-x: auto;
}

.tab {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: calc(var(--radius) - 2px);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.9em;
  font-weight: 500;
  transition: all var(--transition);
  white-space: nowrap;
  text-align: center;
}

.tab:hover { color: var(--text-primary); background: var(--bg-card); }
.tab.active {
  background: var(--accent);
  color: var(--bg-primary);
  font-weight: 600;
  box-shadow: 0 2px 8px var(--accent-glow);
}

/* ===== TASK FORM ===== */
.task-form {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  transition: all var(--transition);
}

.task-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.task-form-grid .full-width { grid-column: 1 / -1; }

.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group label {
  font-size: 0.8em;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  justify-content: flex-end;
}

/* ===== SEARCH & FILTER BAR ===== */
.search-filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.search-input-wrapper {
  flex: 1;
  min-width: 200px;
  position: relative;
}

.search-input-wrapper input {
  width: 100%;
  padding-left: 36px;
}

.search-input-wrapper .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  font-size: 0.9em;
}

/* ===== TASK LIST ===== */
.task-list { display: flex; flex-direction: column; gap: 8px; }

.task-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: all var(--transition);
  animation: slideIn 0.3s ease-out;
  cursor: grab;
  position: relative;
  overflow: hidden;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.task-item:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 12px var(--shadow);
}

.task-item.done { opacity: 0.6; }
.task-item.done .task-title { text-decoration: line-through; }

.task-item.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.task-priority-indicator {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
}

.task-priority-indicator.high { background: var(--priority-high); }
.task-priority-indicator.medium { background: var(--priority-med); }
.task-priority-indicator.low { background: var(--priority-low); }

.task-checkbox {
  width: 22px;
  height: 22px;
  border: 2px solid var(--accent);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
  transition: all var(--transition);
  background: transparent;
  color: transparent;
  font-size: 14px;
}

.task-checkbox.checked {
  background: var(--accent);
  color: var(--bg-primary);
}

.task-checkbox:hover { box-shadow: 0 0 0 3px var(--accent-glow); }

.task-content { flex: 1; min-width: 0; }

.task-title {
  font-weight: 600;
  font-size: 1em;
  margin-bottom: 4px;
  word-break: break-word;
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 0.78em;
  color: var(--text-secondary);
}

.task-meta-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  background: var(--bg-input);
  border-radius: 20px;
}

.task-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state .icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
.empty-state h3 { margin-bottom: 8px; color: var(--text-primary); }

/* ===== SECURE NOTES ===== */
.secure-notes-section {
  margin-top: 20px;
}

.note-item {
  padding: 14px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  transition: all var(--transition);
}

.note-item:hover { border-color: var(--accent); }

.note-locked {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  font-style: italic;
}

/* ===== PIN LOCK OVERLAY ===== */
.pin-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg-primary);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.pin-overlay .bismillah-text { font-size: 2em; }

.pin-input-group {
  display: flex;
  gap: 10px;
}

.pin-digit {
  width: 50px;
  height: 60px;
  text-align: center;
  font-size: 1.5em;
  font-weight: 700;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}

.pin-digit:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

/* ===== MODAL ===== */
.modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  animation: scaleIn 0.2s ease;
}

@keyframes scaleIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal h2 { margin-bottom: 16px; font-family: var(--font-display); color: var(--accent); }
.modal .form-group { margin-bottom: 12px; }

/* ===== SETTINGS PANEL ===== */
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 10px;
  overflow: hidden;
}

.settings-section h3 {
  color: var(--accent);
  margin: 0;
  font-size: 1.05em;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Collapsible settings header */
.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.settings-header:hover { background: rgba(255,255,255,0.04); }
.settings-arrow {
  font-size: 0.7em;
  color: var(--text-secondary);
  transition: transform 0.2s;
}
.settings-header.open .settings-arrow { transform: rotate(180deg); }
.settings-body {
  display: none;
  padding: 0 18px 16px;
}
.settings-body.open { display: block; animation: fadeIn 0.2s ease; }

/* Non-collapsible (About section) */
.settings-section-static { padding: 20px; }

.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  gap: 10px;
}

.setting-row:last-child { border-bottom: none; }

.setting-label { font-size: 0.9em; color: var(--text-secondary); }

/* Speech-to-Text Mic Button */
.stt-input-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
}
.stt-input-wrap input,
.stt-input-wrap textarea { flex: 1; min-width: 0; }
.btn-mic {
  flex-shrink: 0;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.btn-mic:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-mic.listening {
  background: #e74c3c;
  color: #fff;
  border-color: #e74c3c;
  animation: micPulse 1s ease infinite;
}
@keyframes micPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 48px;
  height: 26px;
  background: var(--bg-input);
  border-radius: 13px;
  cursor: pointer;
  transition: background var(--transition);
  border: 1px solid var(--border);
}

.toggle.active { background: var(--accent); border-color: var(--accent); }

.toggle::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: var(--text-primary);
  border-radius: 50%;
  transition: transform var(--transition);
}

.toggle.active::after { transform: translateX(22px); background: var(--bg-primary); }

/* Theme Grid */
.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
}

.theme-card {
  padding: 12px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  text-align: center;
  font-size: 0.85em;
  transition: all var(--transition);
}

.theme-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.theme-card.active { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

.theme-card .theme-icon { font-size: 1.8em; margin-bottom: 6px; }

/* ===== PROFILES ===== */
.profiles-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.profile-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}

.profile-chip.active {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

/* ===== FIREBASE STATUS ===== */
.sync-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8em;
  color: var(--text-secondary);
}

.sync-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-secondary);
}

.sync-dot.online { background: var(--success); }
.sync-dot.warning { background: var(--warning); }
.sync-dot.offline { background: var(--danger); }

/* Language Picker */
.lang-picker { position: relative; }
.lang-picker-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85em;
  font-weight: 500;
  transition: all 0.15s;
}
.lang-picker-btn:hover { border-color: var(--accent); }
.lang-picker-btn svg { border-radius: 2px; flex-shrink: 0; }
.lang-picker-menu {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  z-index: 100;
  min-width: 90px;
  overflow: hidden;
}
[dir="rtl"] .lang-picker-menu { right: auto; left: 0; }
.lang-picker-menu.open { display: block; animation: fadeIn 0.15s ease; }
.lang-option {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: transparent;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85em;
  font-weight: 500;
  transition: background 0.1s;
}
.lang-option:hover { background: rgba(255,255,255,0.08); }
.lang-option svg { border-radius: 2px; flex-shrink: 0; }

/* ===== RTL SUPPORT ===== */
[dir="rtl"] .task-priority-indicator { left: auto; right: 0; }
[dir="rtl"] .search-input-wrapper input { padding-left: 12px; padding-right: 36px; }
[dir="rtl"] .search-input-wrapper .search-icon { left: auto; right: 12px; }
[dir="rtl"] .task-item { padding-left: 16px; padding-right: 20px; }
[dir="rtl"] .bismillah-text { direction: rtl; }

/* ===== RESPONSIVE ===== */
@media (max-width: 640px) {
  .app-container { padding: 10px; }
  .bismillah-text { font-size: 1.6em; }
  .bismillah-inline { display: none; }
  .task-form-grid { grid-template-columns: 1fr; }
  .top-bar { flex-direction: column; align-items: stretch; }
  .top-bar-left, .top-bar-right { justify-content: center; }
  .search-filter-bar { flex-direction: column; }
  .theme-grid { grid-template-columns: repeat(3, 1fr); }
  .tabs { flex-wrap: nowrap; overflow-x: auto; }
  .tab { min-width: fit-content; flex: unset; padding: 10px 14px; }

  /* Mobile simple mode: bigger targets, more breathing room */
  body.simple-mode .task-form { padding: 12px; }
  body.simple-mode .task-form input,
  body.simple-mode .task-form textarea { font-size: 16px; padding: 12px; }
  body.simple-mode .btn { min-height: 44px; font-size: 0.95em; }
  body.simple-mode .task-item { padding: 14px 16px; }
  body.simple-mode .task-title { font-size: 1em; }
  body.simple-mode .simple-note-card { padding: 14px; }
  body.simple-mode .tabs { justify-content: center; }
  body.simple-mode .tab { flex: 1; text-align: center; padding: 12px 8px; font-size: 1em; }
  body.simple-mode .top-bar-right { gap: 6px; }
}

/* ===== NOTIFICATION TOAST ===== */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--accent);
  color: var(--bg-primary);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.9em;
  z-index: 2000;
  transition: transform 0.3s ease;
  box-shadow: 0 4px 20px var(--accent-glow);
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== ISLAMIC SHORTCUTS DRAWER ===== */
.shortcuts-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 450;
  display: none;
  animation: fadeIn 0.2s ease;
}

.shortcuts-backdrop.open { display: block; }

.shortcuts-drawer {
  position: fixed;
  top: 0;
  right: 0;
  width: 300px;
  max-width: 85vw;
  height: 100vh;
  background: var(--bg-secondary);
  border-left: 2px solid var(--accent);
  z-index: 451;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: -8px 0 30px rgba(0,0,0,0.4);
}

[dir="rtl"] .shortcuts-drawer {
  right: auto;
  left: 0;
  border-left: none;
  border-right: 2px solid var(--accent);
  transform: translateX(-100%);
  box-shadow: 8px 0 30px rgba(0,0,0,0.4);
}

.shortcuts-drawer.open { transform: translateX(0); }

/* Settings Sidebar */
.settings-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 500;
  display: none;
  animation: fadeIn 0.2s ease;
}
.settings-backdrop.open { display: block; }

.settings-sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  max-width: 90vw;
  height: 100vh;
  background: var(--bg-primary);
  border-left: 2px solid var(--accent);
  z-index: 501;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: -8px 0 30px rgba(0,0,0,0.4);
  overflow: hidden;
}

[dir="rtl"] .settings-sidebar {
  right: auto;
  left: 0;
  border-left: none;
  border-right: 2px solid var(--accent);
  transform: translateX(-100%);
  box-shadow: 8px 0 30px rgba(0,0,0,0.4);
}

.settings-sidebar.open { transform: translateX(0); }

.settings-sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.settings-sidebar-header h3 {
  color: var(--accent);
  font-size: 1.1em;
  margin: 0;
}

.settings-sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.shortcuts-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.shortcuts-header h3 {
  color: var(--accent);
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-body);
}

.shortcuts-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 1.3em;
  cursor: pointer;
  padding: 4px;
  transition: color var(--transition);
}

.shortcuts-close:hover { color: var(--accent); }

.shortcuts-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.shortcuts-add-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  background: transparent;
  color: var(--accent);
  font-family: inherit;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}

.shortcuts-add-btn:hover {
  border-color: var(--accent);
  background: rgba(212,160,74,0.05);
}

/* Custom shortcut form */
.shortcuts-form {
  display: none;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 10px;
}

.shortcuts-form.open { display: block; animation: fadeIn 0.2s ease; }

.shortcuts-form .form-group { margin-bottom: 8px; }
.shortcuts-form .form-group label { font-size: 0.75em; }
.shortcuts-form input { width: 100%; font-size: 0.85em; padding: 6px 10px; }
.shortcuts-form .form-actions { margin-top: 8px; }

/* Phrase card */
.phrase-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}

.phrase-card:hover {
  border-color: var(--accent);
  transform: translateX(-3px);
  box-shadow: 0 2px 12px var(--shadow);
}

[dir="rtl"] .phrase-card:hover { transform: translateX(3px); }

.phrase-card:active {
  background: rgba(212,160,74,0.08);
}

.phrase-arabic {
  font-family: 'Amiri', 'Aref Ruqaa', serif;
  font-size: 1.15em;
  color: var(--text-primary);
  direction: rtl;
  text-align: right;
  line-height: 1.6;
  margin-bottom: 4px;
}

.phrase-translit {
  font-size: 0.78em;
  color: var(--accent);
  font-style: italic;
  margin-bottom: 2px;
}

.phrase-meaning {
  font-size: 0.75em;
  color: var(--text-secondary);
}

.phrase-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 6px;
}

.phrase-insert-hint {
  font-size: 0.7em;
  color: var(--text-secondary);
  opacity: 0.6;
}

.phrase-delete-btn {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 0.85em;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0;
  transition: opacity var(--transition);
}

.phrase-card:hover .phrase-delete-btn.visible { opacity: 1; }
.phrase-delete-btn:hover { background: rgba(192,57,43,0.1); }

/* Section divider in drawer */
.shortcuts-divider {
  font-size: 0.7em;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 8px 4px 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}

@media (max-width: 640px) {
  .shortcuts-drawer { width: 260px; }
  .phrase-arabic { font-size: 1em; }
}

/* ===== HELP WIDGET ===== */
.help-toggle-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 400;
  box-shadow: 0 4px 16px var(--accent-glow);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

.help-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 24px var(--accent-glow);
}

.help-toggle-btn.active {
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border);
  box-shadow: 0 4px 12px var(--shadow);
}

.help-toggle-btn.active:hover {
  color: var(--accent);
  border-color: var(--accent);
}

[dir="rtl"] .help-toggle-btn { left: auto; right: 20px; }
[dir="rtl"] .kb-toggle-btn { right: auto; left: 20px; }

body.help-open .help-toggle-btn { bottom: calc(65vh + 10px); }

.help-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 65vh;
  background: var(--bg-secondary);
  border-top: 2px solid var(--accent);
  z-index: 398;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.5);
}

.help-panel.open { transform: translateY(0); }

.help-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.help-header h3 {
  color: var(--accent);
  font-size: 1.1em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-search {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.85em;
  outline: none;
  width: 180px;
  transition: border-color var(--transition);
}

.help-search:focus { border-color: var(--accent); }

.help-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* Quick Tips Cards */
.help-quick-tips {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.help-tip-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  transition: all var(--transition);
}

.help-tip-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow);
}

.help-tip-icon {
  font-size: 1.8em;
  margin-bottom: 6px;
}

.help-tip-title {
  font-weight: 600;
  color: var(--accent);
  font-size: 0.95em;
  margin-bottom: 4px;
}

.help-tip-desc {
  font-size: 0.82em;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* Section Label */
.help-section-label {
  font-size: 0.8em;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 16px 0 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border);
}

/* Accordion */
.help-accordion { margin-bottom: 8px; }

.help-accordion-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
  font-size: 0.9em;
  color: var(--text-primary);
  width: 100%;
  text-align: left;
}

[dir="rtl"] .help-accordion-header { text-align: right; }

.help-accordion-header:hover {
  border-color: var(--accent);
  background: rgba(212,160,74,0.05);
}

.help-accordion-header.active {
  border-color: var(--accent);
  border-radius: var(--radius) var(--radius) 0 0;
  background: rgba(212,160,74,0.08);
}

.help-accordion-icon {
  font-size: 0.8em;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-accordion-arrow {
  transition: transform 0.2s ease;
  font-size: 0.9em;
}

.help-accordion-header.active .help-accordion-arrow {
  transform: rotate(180deg);
}

.help-accordion-body {
  display: none;
  padding: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  font-size: 0.85em;
  color: var(--text-secondary);
  line-height: 1.7;
}

.help-accordion-body.open { display: block; animation: fadeIn 0.2s ease; }

.help-accordion-body ul {
  padding-left: 18px;
  margin: 6px 0;
}

.help-accordion-body li { margin: 4px 0; }
.help-accordion-body li::marker { color: var(--accent); }
.help-accordion-body strong { color: var(--text-primary); }

/* Step-by-step guide */
.help-steps { counter-reset: step-counter; padding: 0; list-style: none; margin: 8px 0; }
.help-steps li {
  counter-increment: step-counter;
  position: relative;
  padding: 10px 12px 10px 44px;
  margin: 6px 0;
  background: var(--bg-input);
  border-radius: 8px;
  border-left: 3px solid var(--accent);
  font-size: 0.88em;
  line-height: 1.5;
}
[dir="rtl"] .help-steps li { padding: 10px 44px 10px 12px; border-left: none; border-right: 3px solid var(--accent); }
.help-steps li::before {
  content: counter(step-counter);
  position: absolute;
  left: 10px; top: 10px;
  width: 24px; height: 24px;
  background: var(--accent);
  color: #fff;
  border-radius: 50%;
  font-size: 0.78em;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
}
[dir="rtl"] .help-steps li::before { left: auto; right: 10px; }
.help-steps code {
  background: rgba(255,255,255,0.08);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 0.9em;
  color: var(--accent);
  word-break: break-all;
}
.help-sub-accordion { margin: 8px 0 4px; }
.help-sub-accordion summary {
  cursor: pointer;
  color: var(--accent);
  font-weight: 600;
  font-size: 0.9em;
  padding: 4px 0;
}
.help-sub-accordion summary:hover { text-decoration: underline; }
.help-note {
  background: rgba(255,193,7,0.1);
  border-left: 3px solid #ffc107;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.85em;
  margin: 8px 0;
  color: var(--text-secondary);
}
[dir="rtl"] .help-note { border-left: none; border-right: 3px solid #ffc107; }

/* Contextual Tooltips */
.tooltip-trigger {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: transparent;
  border: 1px solid var(--text-secondary);
  color: var(--text-secondary);
  font-size: 0.65em;
  font-weight: 700;
  cursor: help;
  position: relative;
  vertical-align: middle;
  margin-left: 4px;
  transition: all var(--transition);
  font-family: inherit;
  padding: 0;
  line-height: 1;
}

[dir="rtl"] .tooltip-trigger { margin-left: 0; margin-right: 4px; }

.tooltip-trigger:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

.tooltip-bubble {
  display: none;
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-secondary);
  white-space: normal;
  width: 220px;
  z-index: 600;
  box-shadow: 0 4px 16px var(--shadow);
  line-height: 1.5;
  text-align: left;
}

[dir="rtl"] .tooltip-bubble { text-align: right; }

.tooltip-bubble::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--accent);
}

.tooltip-trigger:hover .tooltip-bubble,
.tooltip-trigger:focus .tooltip-bubble { display: block; }

/* Help panel responsive */
@media (max-width: 640px) {
  .help-panel { height: 75vh; }
  .help-quick-tips { grid-template-columns: 1fr; }
  .help-search { width: 120px; }
  body.help-open .help-toggle-btn { bottom: calc(75vh + 10px); }
  .tooltip-bubble { width: 180px; left: auto; right: -10px; transform: none; }
  .tooltip-bubble::after { left: auto; right: 14px; transform: none; }
}

/* ===== ARABIC VIRTUAL KEYBOARD ===== */
.kb-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 400;
  box-shadow: 0 4px 16px var(--accent-glow);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.kb-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 24px var(--accent-glow);
}

.kb-toggle-btn.active {
  right: auto;
  left: 20px;
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border);
  box-shadow: 0 4px 12px var(--shadow);
}

.kb-toggle-btn.active:hover {
  color: var(--accent);
  border-color: var(--accent);
}

[dir="rtl"] .kb-toggle-btn { right: auto; left: 20px; }
[dir="rtl"] .kb-toggle-btn.active { left: auto; right: 20px; }

.arabic-keyboard {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border-top: 2px solid var(--accent);
  z-index: 399;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 0;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
}

.arabic-keyboard.open {
  transform: translateY(0);
}

.kb-toolbar {
  display: flex;
  flex-direction: column;
  padding: 6px 8px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  gap: 4px;
}

.kb-toolbar-row1 {
  display: flex;
  align-items: center;
  gap: 5px;
}

.kb-toolbar-row2 {
  display: flex;
  justify-content: center;
  gap: 4px;
}

.kb-preview {
  flex: 1;
  min-width: 0;
  padding: 6px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: 'Amiri', serif;
  font-size: 1.1em;
  direction: rtl;
  text-align: right;
  min-height: 36px;
  line-height: 24px;
  outline: none;
}

.kb-preview:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.kb-toolbar-btns {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

.kb-tool-btn {
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-input);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8em;
  font-family: inherit;
  transition: all var(--transition);
  white-space: nowrap;
  min-height: 32px;
}

.kb-tool-btn:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

.kb-rows {
  padding: 6px 4px 10px;
}

.kb-row {
  display: flex;
  justify-content: center;
  gap: 3px;
  margin-bottom: 3px;
}

.kb-key {
  min-width: 32px;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-card);
  color: var(--text-primary);
  font-family: 'Amiri', serif;
  font-size: 1.15em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  user-select: none;
  -webkit-user-select: none;
  position: relative;
}

.kb-key:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 3px 8px var(--accent-glow);
}

.kb-key:active {
  transform: translateY(0);
  background: var(--accent-hover);
}

.kb-key.pressed {
  background: var(--accent);
  color: var(--bg-primary);
  transform: scale(1.15);
}

.kb-key-wide {
  min-width: 52px;
  font-size: 0.85em;
  font-family: var(--font-body);
}

.kb-key-space {
  flex: 1;
  max-width: 220px;
  font-size: 0.8em;
  font-family: var(--font-body);
}

.kb-key-haraka {
  min-width: 34px;
  height: 38px;
  font-size: 1.3em;
  color: var(--accent);
  background: transparent;
  border-color: rgba(212,160,74,0.15);
}

.kb-key-haraka:hover {
  color: var(--bg-primary);
}

.kb-section-label {
  font-size: 0.7em;
  color: var(--text-secondary);
  text-align: center;
  margin: 4px 0 2px;
  font-family: var(--font-body);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Responsive keyboard */
@media (max-width: 640px) {
  .kb-key { min-width: 26px; height: 38px; font-size: 1em; }
  .kb-key-wide { min-width: 40px; }
  .kb-key-haraka { min-width: 28px; height: 34px; }
  .kb-tool-btn { padding: 4px 8px; font-size: 0.75em; }
}

/* When keyboard is open, add padding to body */
body.kb-open {
  padding-bottom: 300px;
}

body.kb-open .kb-toggle-btn {
  bottom: 310px;
}

/* ===== PASSWORD WRAPPER ===== */
.password-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
}

.password-wrapper input {
  flex: 1;
  padding-right: 44px;
}

.password-wrapper .toggle-pass {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  padding: 4px 8px;
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 1.1em;
  font-family: 'Amiri', serif;
  cursor: pointer;
  opacity: 0.7;
  min-width: auto;
}

.password-wrapper .toggle-pass:hover {
  opacity: 1;
  background: transparent;
  color: var(--text-primary);
  transform: translateY(-50%);
  box-shadow: none;
}

/* ===== PAGE SECTIONS ===== */
.page { display: none; }
.page.active { display: block; animation: fadeIn 0.3s ease; }
</style>
</head>
<body data-theme="alhambra">

<!-- PIN LOCK OVERLAY -->
<div class="pin-overlay" id="pinOverlay" style="display:none;">
  <div class="bismillah-text">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
  <h2 id="pinTitle" style="color:var(--accent)">Enter PIN</h2>
  <div class="pin-input-group" id="pinInputGroup">
    <input class="pin-digit" type="password" maxlength="1" data-index="0" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="1" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="2" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="3" inputmode="numeric">
  </div>
  <p id="pinError" style="color:var(--danger);display:none;font-size:0.9em;"></p>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- HELP WIDGET TOGGLE -->
<button class="help-toggle-btn" id="helpToggleBtn" onclick="toggleHelp()" title="Help">‚ùì</button>

<!-- HELP PANEL -->
<div class="help-panel" id="helpPanel">
  <div class="help-header">
    <h3>‚ùì <span data-i18n="helpTitle">Help & Guide</span></h3>
    <input type="text" class="help-search" id="helpSearch" data-i18n-placeholder="helpSearchPlaceholder" placeholder="Search help..." oninput="filterHelp()">
  </div>
  <div class="help-body" id="helpBody">
    <!-- Quick Tips -->
    <div class="help-section-label" data-i18n="helpQuickStart">üöÄ QUICK START</div>
    <div class="help-quick-tips" id="helpQuickTips">
      <div class="help-tip-card" data-help-keywords="add task create new">
        <div class="help-tip-icon">üìù</div>
        <div class="help-tip-title" data-i18n="helpTip1Title">Add a Task</div>
        <div class="help-tip-desc" data-i18n="helpTip1Desc">Type a title in the Tasks tab and click "+ Add Task". Set priority, due date, and category.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="done complete check finish">
        <div class="help-tip-icon">‚úÖ</div>
        <div class="help-tip-title" data-i18n="helpTip2Title">Complete a Task</div>
        <div class="help-tip-desc" data-i18n="helpTip2Desc">Click the checkbox on any task to mark it done.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="theme style design color">
        <div class="help-tip-icon">üïå</div>
        <div class="help-tip-title" data-i18n="helpTip3Title">Change Theme</div>
        <div class="help-tip-desc" data-i18n="helpTip3Desc">Go to Settings ‚Üí Themes and pick from 7 beautiful Islamic-inspired designs.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="language arabic french english rtl">
        <div class="help-tip-icon">üåç</div>
        <div class="help-tip-title" data-i18n="helpTip4Title">Switch Language</div>
        <div class="help-tip-desc" data-i18n="helpTip4Desc">Use the language dropdown (EN/FR/AR) in the top bar. Arabic automatically enables RTL layout.</div>
      </div>
    </div>

    <!-- Feature Guide -->
    <div class="help-section-label" data-i18n="helpFeatures">üìö FEATURE GUIDE</div>

    <div class="help-accordion" data-help-keywords="task add edit delete priority date category tag search filter reorder drag">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">üìù <span data-i18n="helpFeatTasks">Tasks</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatTasksAdd">Add tasks</strong> ‚Äî <span data-i18n="helpFeatTasksAddDesc">Type a title, set priority/date/category/tags, click "+ Add Task"</span></li>
          <li><strong data-i18n="helpFeatTasksEdit">Edit</strong> ‚Äî <span data-i18n="helpFeatTasksEditDesc">Click ‚úèÔ∏è on any task to edit it</span></li>
          <li><strong data-i18n="helpFeatTasksDel">Delete</strong> ‚Äî <span data-i18n="helpFeatTasksDelDesc">Click üóëÔ∏è to remove a task</span></li>
          <li><strong data-i18n="helpFeatTasksPriority">Priority</strong> ‚Äî <span data-i18n="helpFeatTasksPriorityDesc">High (red), Medium (yellow), Low (green) ‚Äî shown as a colored bar on the left</span></li>
          <li><strong data-i18n="helpFeatTasksSearch">Search & Filter</strong> ‚Äî <span data-i18n="helpFeatTasksSearchDesc">Use the search bar and dropdowns to find tasks by text, priority, category, or status</span></li>
          <li><strong data-i18n="helpFeatTasksDrag">Reorder</strong> ‚Äî <span data-i18n="helpFeatTasksDragDesc">Drag and drop tasks to change their order</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="secure notes encrypt password passphrase aes lock">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">üîí <span data-i18n="helpFeatNotes">Secure Notes</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatNotesHow">How it works</strong> ‚Äî <span data-i18n="helpFeatNotesHowDesc">Notes are encrypted with AES-256 using your passphrase before saving. Nobody can read them without the passphrase.</span></li>
          <li><strong data-i18n="helpFeatNotesFirst">First time</strong> ‚Äî <span data-i18n="helpFeatNotesFirstDesc">Set a passphrase and confirm it. Remember it ‚Äî there's no recovery!</span></li>
          <li><strong data-i18n="helpFeatNotesReturn">Returning</strong> ‚Äî <span data-i18n="helpFeatNotesReturnDesc">Enter your passphrase to unlock. If wrong, you'll see an error message.</span></li>
          <li><strong data-i18n="helpFeatNotesChange">Change passphrase</strong> ‚Äî <span data-i18n="helpFeatNotesChangeDesc">Click üîë Change Passphrase (when unlocked). All notes are re-encrypted with the new one.</span></li>
          <li>‚ö†Ô∏è <strong data-i18n="helpFeatNotesWarn">Warning</strong> ‚Äî <span data-i18n="helpFeatNotesWarnDesc">Don't store critical passwords here. Use Bitwarden (free) for that.</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="arabic keyboard type harakat diacritics virtual">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">‚å®Ô∏è <span data-i18n="helpFeatKeyboard">Arabic Keyboard</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatKbOpen">Open/Close</strong> ‚Äî <span data-i18n="helpFeatKbOpenDesc">Tap the ‚å®Ô∏è button (bottom-right corner)</span></li>
          <li><strong data-i18n="helpFeatKbPreview">How to use</strong> ‚Äî <span data-i18n="helpFeatKbPreviewDesc">Type in the preview bar, then ‚ûú Insert to send text into the last clicked field. Or üìã Copy then Ctrl+V.</span></li>
          <li><strong data-i18n="helpFeatKbHarakat">Harakat</strong> ‚Äî <span data-i18n="helpFeatKbHarakatDesc">Top row has diacritics: ŸÅÿ™ÿ≠ÿ©ÿå ÿ∂ŸÖÿ©ÿå ŸÉÿ≥ÿ±ÿ©ÿå ÿ™ŸÜŸàŸäŸÜÿå ÿ¥ÿØŸëÿ©ÿå ÿ≥ŸÉŸàŸÜ</span></li>
          <li><strong data-i18n="helpFeatKbNumbers">Numbers</strong> ‚Äî <span data-i18n="helpFeatKbNumbersDesc">Arabic numerals: Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="theme alhambra ottoman moroccan calligraphy ramadan desert style">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">üïå <span data-i18n="helpFeatThemes">Themes</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li>üè∞ <strong>Alhambra</strong> ‚Äî <span data-i18n="helpThemeAlhambra">Warm gold & terracotta, inspired by Granada's Alhambra</span></li>
          <li>üîµ <strong>Ottoman</strong> ‚Äî <span data-i18n="helpThemeOttoman">Turquoise, cobalt blue & gold, Iznik tile inspired</span></li>
          <li>üíé <strong>Moroccan</strong> ‚Äî <span data-i18n="helpThemeMoroccan">Emerald, saffron & royal blue, zellige mosaic style</span></li>
          <li>‚úíÔ∏è <strong>Calligraphy</strong> ‚Äî <span data-i18n="helpThemeCalligraphy">Cream & black ink, manuscript aesthetic</span></li>
          <li>üåô <strong>Ramadan</strong> ‚Äî <span data-i18n="helpThemeRamadan">Deep navy with twinkling gold stars</span></li>
          <li>üèúÔ∏è <strong>Desert</strong> ‚Äî <span data-i18n="helpThemeDesert">Sandy beige & palm green, calm oasis feel</span></li>
        </ul>
        <p data-i18n="helpThemeHow">Go to Settings ‚Üí Themes to switch. Your choice is saved automatically.</p>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="pin lock security password">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">üî¢ <span data-i18n="helpFeatPin">PIN Lock</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatPinEnable">Enable</strong> ‚Äî <span data-i18n="helpFeatPinEnableDesc">Settings ‚Üí PIN Lock ‚Üí Toggle on ‚Üí Set a 4-digit PIN</span></li>
          <li><strong data-i18n="helpFeatPinUse">How it works</strong> ‚Äî <span data-i18n="helpFeatPinUseDesc">On app load, you'll need to enter the PIN before accessing your data</span></li>
          <li><strong data-i18n="helpFeatPinChange">Change PIN</strong> ‚Äî <span data-i18n="helpFeatPinChangeDesc">Settings ‚Üí Click üîë Change PIN ‚Üí Enter old and new PIN</span></li>
        </ul>
      </div>
    </div>

    <!-- FAQ -->
    <div class="help-section-label" data-i18n="helpFAQ">‚ùì FREQUENTLY ASKED QUESTIONS</div>

    <div class="help-accordion" data-help-keywords="password store safe bitwarden">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq1Q">Can I store my passwords here?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq1A">
        <strong>Not recommended.</strong> This app is for tasks and light memos. For passwords, use a proper password manager like <strong>Bitwarden</strong> (free) or <strong>KeePass</strong>. Secure Notes are encrypted but not designed for critical credentials.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="forget passphrase recovery lost">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq2Q">What if I forget my passphrase?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq2A">
        <strong>Your notes cannot be recovered.</strong> AES encryption means without the passphrase, the data is unreadable. Always remember your passphrase or write it down in a safe place.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="offline internet connection work">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq3Q">Does it work offline?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq3A">
        <strong>Yes!</strong> In local mode, everything works without internet. Tasks are saved in your browser's localStorage. Cloud sync (Firebase) requires internet only when syncing.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="sync device phone laptop computer access everywhere">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq4Q">How do I sync across devices?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq4A">
        Set up Firebase Cloud Sync: scroll up to the <strong>‚òÅÔ∏è Cloud Sync (Firebase)</strong> section above for a full step-by-step guide. Alternatively, use <strong>Export/Import</strong> in Settings to manually transfer data via JSON files.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="data secure safe privacy">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq5Q">Is my data secure?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq5A">
        <strong>Local mode:</strong> Data is in your browser's localStorage ‚Äî private but not encrypted (except Secure Notes). <strong>Secure Notes:</strong> AES-256 encrypted, safe with a strong passphrase. <strong>Firebase:</strong> Protected by Google authentication, only you can access your data.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="github pages deploy host website publish">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq6Q">How do I deploy on GitHub Pages?</span></span>
        <span class="help-accordion-arrow">‚ñº</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq6A">
        Create a GitHub repo ‚Üí Upload files ‚Üí Settings ‚Üí Pages ‚Üí Select main branch ‚Üí Your app is live at https://username.github.io/repo-name/. Full guide in README.html.
      </div>
    </div>

  </div>
</div>

<!-- ISLAMIC SHORTCUTS DRAWER -->
<div class="shortcuts-backdrop" id="shortcutsBackdrop" onclick="toggleShortcutsDrawer()"></div>
<div class="shortcuts-drawer" id="shortcutsDrawer">
  <div class="shortcuts-header">
    <h3>ü§≤ <span data-i18n="shortcutsTitle">Islamic Phrases</span></h3>
    <button class="shortcuts-close" onclick="toggleShortcutsDrawer()">‚úï</button>
  </div>
  <div class="shortcuts-body">
    <!-- Add Custom Button -->
    <button class="shortcuts-add-btn" onclick="toggleCustomForm()" data-i18n="addCustomShortcut">+ Add Custom Phrase</button>

    <!-- Custom Form (hidden) -->
    <div class="shortcuts-form" id="customShortcutForm">
      <div class="form-group">
        <label data-i18n="scArabic">Arabic Text *</label>
        <input type="text" id="scArabicInput" dir="rtl" placeholder="ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê">
      </div>
      <div class="form-group">
        <label data-i18n="scTranslit">Transliteration</label>
        <input type="text" id="scTranslitInput" placeholder="Bismillah">
      </div>
      <div class="form-group">
        <label data-i18n="scMeaning">Meaning</label>
        <input type="text" id="scMeaningInput" placeholder="In the name of Allah">
      </div>
      <div class="form-actions">
        <button class="btn btn-sm" onclick="toggleCustomForm()" data-i18n="cancel">Cancel</button>
        <button class="btn btn-sm btn-accent" onclick="saveCustomShortcut()" data-i18n="scSave">Save</button>
      </div>
    </div>

    <!-- Phrase list rendered by JS -->
    <div id="shortcutsList"></div>
  </div>
</div>

<!-- ARABIC KEYBOARD TOGGLE -->
<button class="kb-toggle-btn" id="kbToggleBtn" onclick="toggleKeyboard()" title="Arabic Keyboard">‚å®Ô∏è</button>

<!-- ARABIC VIRTUAL KEYBOARD -->
<div class="arabic-keyboard" id="arabicKeyboard">
  <!-- Toolbar with preview, copy, paste, clear -->
  <div class="kb-toolbar">
    <div class="kb-toolbar-row1">
      <input type="text" class="kb-preview" id="kbPreview" dir="rtl" placeholder="Type here..." oninput="kbPreviewText = this.value">
      <button class="kb-tool-btn" onclick="toggleShortcutsDrawer()" title="Islamic Phrases">ü§≤</button>
    </div>
    <div class="kb-toolbar-row2">
      <button class="kb-tool-btn" onclick="kbCopyPreview()">üìã Copy</button>
      <button class="kb-tool-btn" onclick="kbPasteToField()">‚ûú Insert</button>
      <button class="kb-tool-btn" onclick="kbClearPreview()">‚úñ Clear</button>
    </div>
  </div>

  <div class="kb-rows">
    <!-- Harakat / Diacritics -->
    <div class="kb-section-label">Harakat</div>
    <div class="kb-row" id="kbHarakatRow">
      <div class="kb-key kb-key-haraka" data-char="Ÿé" title="Fatha">Ÿé</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿè" title="Damma">Ÿè</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿê" title="Kasra">Ÿê</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿã" title="Tanween Fatha">Ÿã</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿå" title="Tanween Damma">Ÿå</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿç" title="Tanween Kasra">Ÿç</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿë" title="Shadda">Ÿë</div>
      <div class="kb-key kb-key-haraka" data-char="Ÿí" title="Sukun">Ÿí</div>
    </div>

    <!-- Row 1: Arabic numbers -->
    <div class="kb-section-label">Numbers</div>
    <div class="kb-row" id="kbNumbersRow">
      <div class="kb-key" data-char="Ÿ°">Ÿ°</div>
      <div class="kb-key" data-char="Ÿ¢">Ÿ¢</div>
      <div class="kb-key" data-char="Ÿ£">Ÿ£</div>
      <div class="kb-key" data-char="Ÿ§">Ÿ§</div>
      <div class="kb-key" data-char="Ÿ•">Ÿ•</div>
      <div class="kb-key" data-char="Ÿ¶">Ÿ¶</div>
      <div class="kb-key" data-char="Ÿß">Ÿß</div>
      <div class="kb-key" data-char="Ÿ®">Ÿ®</div>
      <div class="kb-key" data-char="Ÿ©">Ÿ©</div>
      <div class="kb-key" data-char="Ÿ†">Ÿ†</div>
    </div>

    <!-- Row 2: Letters row 1 -->
    <div class="kb-row">
      <div class="kb-key" data-char="ÿ∂">ÿ∂</div>
      <div class="kb-key" data-char="ÿµ">ÿµ</div>
      <div class="kb-key" data-char="ÿ´">ÿ´</div>
      <div class="kb-key" data-char="ŸÇ">ŸÇ</div>
      <div class="kb-key" data-char="ŸÅ">ŸÅ</div>
      <div class="kb-key" data-char="ÿ∫">ÿ∫</div>
      <div class="kb-key" data-char="ÿπ">ÿπ</div>
      <div class="kb-key" data-char="Ÿá">Ÿá</div>
      <div class="kb-key" data-char="ÿÆ">ÿÆ</div>
      <div class="kb-key" data-char="ÿ≠">ÿ≠</div>
      <div class="kb-key" data-char="ÿ¨">ÿ¨</div>
    </div>

    <!-- Row 3: Letters row 2 -->
    <div class="kb-row">
      <div class="kb-key" data-char="ÿ¥">ÿ¥</div>
      <div class="kb-key" data-char="ÿ≥">ÿ≥</div>
      <div class="kb-key" data-char="Ÿä">Ÿä</div>
      <div class="kb-key" data-char="ÿ®">ÿ®</div>
      <div class="kb-key" data-char="ŸÑ">ŸÑ</div>
      <div class="kb-key" data-char="ÿß">ÿß</div>
      <div class="kb-key" data-char="ÿ™">ÿ™</div>
      <div class="kb-key" data-char="ŸÜ">ŸÜ</div>
      <div class="kb-key" data-char="ŸÖ">ŸÖ</div>
      <div class="kb-key" data-char="ŸÉ">ŸÉ</div>
      <div class="kb-key" data-char="ÿ©">ÿ©</div>
    </div>

    <!-- Row 4: Letters row 3 -->
    <div class="kb-row">
      <div class="kb-key" data-char="ÿ¶">ÿ¶</div>
      <div class="kb-key" data-char="ÿ°">ÿ°</div>
      <div class="kb-key" data-char="ÿ§">ÿ§</div>
      <div class="kb-key" data-char="ÿ±">ÿ±</div>
      <div class="kb-key" data-char="ŸÑÿß">ŸÑÿß</div>
      <div class="kb-key" data-char="Ÿâ">Ÿâ</div>
      <div class="kb-key" data-char="Ÿà">Ÿà</div>
      <div class="kb-key" data-char="ÿ≤">ÿ≤</div>
      <div class="kb-key" data-char="ÿ∏">ÿ∏</div>
      <div class="kb-key" data-char="ÿ∑">ÿ∑</div>
      <div class="kb-key" data-char="ÿ∞">ÿ∞</div>
      <div class="kb-key" data-char="ÿØ">ÿØ</div>
    </div>

    <!-- Row 5: Space, backspace, symbols -->
    <div class="kb-row">
      <div class="kb-key kb-key-wide" data-action="backspace">‚å´</div>
      <div class="kb-key" data-char="ÿå">ÿå</div>
      <div class="kb-key" data-char="ÿõ">ÿõ</div>
      <div class="kb-key kb-key-space" data-char=" ">ŸÖÿ≥ÿßŸÅÿ©</div>
      <div class="kb-key" data-char="ÿü">ÿü</div>
      <div class="kb-key" data-char=".">.</div>
      <div class="kb-key kb-key-wide" data-action="enter">‚Üµ</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app-container" id="appContainer">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-bar-left">
      <span class="app-title" data-i18n="appTitle">üìù Tethkir</span>
      <div class="sync-status" id="syncStatus">
        <span class="sync-dot offline" id="syncDot"></span>
        <span id="syncLabel">Offline</span>
      </div>
    </div>
    <span class="bismillah-inline">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</span>
    <div class="top-bar-right">
      <div class="lang-picker" id="langPicker">
        <button class="lang-picker-btn" onclick="toggleLangPicker()" id="langPickerBtn">
          <span id="langFlag" style="display:inline-flex;align-items:center;"></span>
          <span id="langCode">EN</span>
          <span style="font-size:0.6em;opacity:0.6;">‚ñº</span>
        </button>
        <div class="lang-picker-menu" id="langPickerMenu">
          <button class="lang-option" onclick="selectLang('en')">
            <svg width="24" height="16" viewBox="0 0 60 30"><clipPath id="ukc"><rect width="60" height="30" rx="2"/></clipPath><g clip-path="url(#ukc)"><rect width="60" height="30" fill="#012169"/><path d="M0,0L60,30M60,0L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0L60,30M60,0L0,30" stroke="#C8102E" stroke-width="4" clip-path="url(#ukc)"/><path d="M30,0V30M0,15H60" stroke="#fff" stroke-width="10"/><path d="M30,0V30M0,15H60" stroke="#C8102E" stroke-width="6"/></g></svg>
            EN
          </button>
          <button class="lang-option" onclick="selectLang('fr')">
            <svg width="24" height="16" viewBox="0 0 60 30"><rect width="20" height="30" fill="#002395"/><rect x="20" width="20" height="30" fill="#fff"/><rect x="40" width="20" height="30" fill="#ED2939"/></svg>
            FR
          </button>
          <button class="lang-option" onclick="selectLang('ar')">
            <svg width="24" height="16" viewBox="0 0 60 30"><rect width="30" height="30" fill="#006233"/><rect x="30" width="30" height="30" fill="#fff"/><circle cx="30" cy="15" r="7" fill="#D21034"/><circle cx="32" cy="15" r="5.8" fill="#fff"/><polygon points="33.5,9.5 34.8,13 38.5,13 35.5,15.3 36.5,19 33.5,16.5 30.5,19 31.5,15.3 28.5,13 32.2,13" fill="#D21034"/></svg>
            AR
          </button>
        </div>
      </div>
      <button class="btn" id="authBtn" onclick="toggleAuth()" data-i18n="signIn">‚òÅÔ∏è Sign In</button>
      <button class="btn btn-icon" onclick="toggleSettingsSidebar()" title="Settings" style="font-size:1.1em;">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- PROFILES BAR -->
  <div class="profiles-bar" id="profilesBar">
    <button class="profile-chip active" data-profile="default" onclick="switchProfile('default')">üë§ <span data-i18n="defaultProfile">Default</span></button>
    <button class="btn btn-sm" onclick="showAddProfileModal()">+ <span data-i18n="addProfile">Profile</span></button>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="tasks" onclick="switchTab('tasks')">üìù <span data-i18n="tabTasks">Tasks</span></button>
    <button class="tab" data-tab="notes" onclick="switchTab('notes')">üîí <span data-i18n="tabNotes">Secure Notes</span></button>
  </div>

  <!-- ===== TASKS PAGE ===== -->
  <div class="page active" id="page-tasks">
    <!-- Add Task Form -->
    <div class="task-form" id="taskForm">
      <div class="task-form-grid">
        <div class="form-group full-width">
          <label data-i18n="taskTitle">Task Title</label>
          <div class="stt-input-wrap">
            <input type="text" id="taskTitleInput" data-i18n-placeholder="taskTitlePlaceholder" placeholder="What do you need to do?">
            <button type="button" class="btn-mic" onclick="toggleSTT('taskTitleInput', this)" title="Voice input">üé§</button>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="priority">Priority</label><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipPriority">High = urgent (red), Medium = normal (yellow), Low = can wait (green). Color bar shows on each task.</span></button>
          <select id="taskPriority">
            <option value="low" data-i18n="low">Low</option>
            <option value="medium" data-i18n="medium">Medium</option>
            <option value="high" data-i18n="high">High</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="dueDate">Due Date</label>
          <input type="date" id="taskDueDate">
        </div>
        <div class="form-group">
          <label data-i18n="category">Category</label>
          <select id="taskCategory">
            <option value="general" data-i18n="catGeneral">General</option>
            <option value="work" data-i18n="catWork">Work</option>
            <option value="personal" data-i18n="catPersonal">Personal</option>
            <option value="homework" data-i18n="catHomework">üìö Homework</option>
            <option value="chores" data-i18n="catChores">üßπ Chores</option>
            <option value="dua" data-i18n="catDua">ü§≤ Dua / Quran</option>
            <option value="activities" data-i18n="catActivities">üèÉ Activities</option>
            <option value="fun" data-i18n="catFun">üé® Fun</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="tags">Tags</label><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipTags">Add labels separated by commas (e.g. "urgent, school, home"). Use search to find tasks by tag.</span></button>
          <input type="text" id="taskTags" data-i18n-placeholder="tagsPlaceholder" placeholder="comma separated">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn" onclick="clearForm()" data-i18n="clear">Clear</button>
        <button class="btn btn-accent" onclick="addTask()" id="addTaskBtn" data-i18n="addTask">+ Add Task</button>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="search-filter-bar">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Search tasks..." oninput="renderTasks()">
      </div>
      <select id="filterPriority" onchange="renderTasks()">
        <option value="all" data-i18n="allPriorities">All Priorities</option>
        <option value="high" data-i18n="high">High</option>
        <option value="medium" data-i18n="medium">Medium</option>
        <option value="low" data-i18n="low">Low</option>
      </select>
      <select id="filterCategory" onchange="renderTasks()">
        <option value="all" data-i18n="allCategories">All Categories</option>
        <option value="general" data-i18n="catGeneral">General</option>
        <option value="work" data-i18n="catWork">Work</option>
        <option value="personal" data-i18n="catPersonal">Personal</option>
        <option value="homework" data-i18n="catHomework">Homework</option>
        <option value="chores" data-i18n="catChores">Chores</option>
        <option value="dua" data-i18n="catDua">Dua / Quran</option>
        <option value="activities" data-i18n="catActivities">Activities</option>
        <option value="fun" data-i18n="catFun">Fun</option>
      </select>
      <select id="filterStatus" onchange="renderTasks()">
        <option value="all" data-i18n="allStatus">All</option>
        <option value="active" data-i18n="active">Active</option>
        <option value="done" data-i18n="done">Done</option>
      </select>
    </div>

    <!-- Task List -->
    <div class="task-list" id="taskList"></div>
  </div>

  <!-- ===== SECURE NOTES PAGE ===== -->
  <div class="page" id="page-notes">
    <!-- SIMPLE MODE NOTES -->
    <div class="simple-notes-section">
      <div id="simpleNotesList" style="margin-bottom:16px;"></div>
      <div class="task-form">
        <div class="form-group">
          <label data-i18n="noteTitle">Note Title</label>
          <div class="stt-input-wrap">
            <input type="text" id="simpleNoteTitleInput" data-i18n-placeholder="noteTitlePlaceholder" placeholder="Note title...">
            <button type="button" class="btn-mic" onclick="toggleSTT('simpleNoteTitleInput', this)" title="Voice input">üé§</button>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="noteContent">Content</label>
          <div class="stt-input-wrap" style="align-items:flex-start;">
            <textarea id="simpleNoteContentInput" rows="3" data-i18n-placeholder="noteContentPlaceholder" placeholder="Your note..."></textarea>
            <button type="button" class="btn-mic" style="margin-top:4px;" onclick="toggleSTT('simpleNoteContentInput', this)" title="Voice input">üé§</button>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-accent" onclick="addSimpleNote()" data-i18n="saveNote">üíæ Save Note</button>
        </div>
      </div>
    </div>

    <!-- ADVANCED MODE NOTES (encrypted) -->
    <div class="secure-notes-section">
      <div id="notePasswordSection">
        <div class="task-form">
          <h3 style="color:var(--accent);margin-bottom:12px;" data-i18n="secureNotesTitle">üîê Secure Notes (AES Encrypted)</h3>
          <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:14px;" data-i18n="secureNotesDesc">Notes are encrypted with your passphrase. Without it, nobody can read them.</p>
          <p id="noteCountHint" style="color:var(--accent);font-size:0.9em;margin-bottom:14px;display:none;"></p>
          <div class="form-group">
            <label data-i18n="passphrase">Master Passphrase</label>
            <div class="password-wrapper">
              <input type="password" id="notePassphrase" data-i18n-placeholder="passphrasePlaceholder" placeholder="Enter your secret passphrase">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('notePassphrase', this)" title="Show/Hide">ÿπŸÄ</button>
            </div>
          </div>
          <!-- Confirm passphrase (only shown if no notes exist yet) -->
          <div class="form-group" id="confirmPassGroup" style="display:none;">
            <label data-i18n="confirmPassphrase">Confirm Passphrase</label>
            <div class="password-wrapper">
              <input type="password" id="notePassphraseConfirm" data-i18n-placeholder="confirmPassphrasePlaceholder" placeholder="Re-enter your passphrase">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('notePassphraseConfirm', this)" title="Show/Hide">ÿπŸÄ</button>
            </div>
            <small id="passMismatch" style="color:var(--danger);display:none;" data-i18n="passMismatch">Passphrases don't match</small>
          </div>
          <div class="form-actions" style="margin-top:10px;">
            <button class="btn btn-accent" onclick="unlockNotes()" id="unlockBtn" data-i18n="unlock">üîì Unlock</button>
          </div>
        </div>
      </div>

      <div id="noteEditorSection" style="display:none;">
        <!-- Saved Notes List (shown first) -->
        <div id="notesList" style="margin-bottom:16px;"></div>

        <!-- New Note Form (collapsible) -->
        <div id="newNoteFormWrapper">
          <button class="btn btn-accent" id="showNewNoteBtn" onclick="showNewNoteForm()" style="width:100%;padding:12px;margin-bottom:12px;">
            ‚úèÔ∏è <span data-i18n="writeNewNote">Write New Note</span>
          </button>
          <div class="task-form" id="newNoteForm" style="display:none;">
            <h3 style="color:var(--accent);margin-bottom:12px;">‚úèÔ∏è <span data-i18n="newNoteTitle">New Note</span></h3>
            <div class="form-group">
              <label data-i18n="noteTitle">Note Title</label>
              <div class="stt-input-wrap">
                <input type="text" id="noteTitleInput" data-i18n-placeholder="noteTitlePlaceholder" placeholder="Note title...">
                <button type="button" class="btn-mic" onclick="toggleSTT('noteTitleInput', this)" title="Voice input">üé§</button>
              </div>
            </div>
            <div class="form-group">
              <label data-i18n="noteContent">Content</label>
              <div class="stt-input-wrap" style="align-items:flex-start;">
                <textarea id="noteContentInput" rows="4" data-i18n-placeholder="noteContentPlaceholder" placeholder="Your secret note..."></textarea>
                <button type="button" class="btn-mic" style="margin-top:4px;" onclick="toggleSTT('noteContentInput', this)" title="Voice input">üé§</button>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn" onclick="cancelNewNote()" data-i18n="cancel">Cancel</button>
              <button class="btn btn-accent" onclick="addNote()" data-i18n="saveNote">üîê Encrypt & Save</button>
            </div>
          </div>
        </div>

        <!-- Lock & Change Passphrase buttons -->
        <div style="display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap;">
          <button class="btn" onclick="lockNotes()" data-i18n="lock">üîí Lock</button>
          <button class="btn" onclick="showChangePassphraseModal()" data-i18n="changePassphrase">üîë Change Passphrase</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ===== SETTINGS SIDEBAR ===== -->
<div class="settings-backdrop" id="settingsBackdrop" onclick="toggleSettingsSidebar()"></div>
<div class="settings-sidebar" id="settingsSidebar">
  <div class="settings-sidebar-header">
    <h3>‚öôÔ∏è <span data-i18n="tabSettings">Settings</span></h3>
    <button class="btn btn-icon" onclick="toggleSettingsSidebar()" style="font-size:1.2em;">‚úï</button>
  </div>
  <div class="settings-sidebar-body">
    <!-- Mode Toggle -->
    <div class="settings-section">
      <div class="settings-section-static">
        <div class="setting-row">
          <span class="setting-label" style="font-weight:600;color:var(--accent);" data-i18n="modeLabel">Simple Mode</span>
          <div class="toggle active" id="simpleModeToggle" onclick="toggleSimpleMode()"></div>
        </div>
        <p style="color:var(--text-secondary);font-size:0.8em;margin-top:4px;" data-i18n="modeDesc">Hide advanced features (profiles, filters, encryption)</p>
      </div>
    </div>

    <!-- Themes ‚Äî open by default -->
    <div class="settings-section">
      <div class="settings-header open" onclick="toggleSettingsSection(this)">
        <h3>üïå <span data-i18n="themesTitle">Themes</span></h3>
        <span class="settings-arrow">‚ñº</span>
      </div>
      <div class="settings-body open">
        <div class="theme-grid" id="themeGrid">
          <div class="theme-card active" data-themeid="alhambra" onclick="setTheme('alhambra')">
            <div class="theme-icon">üè∞</div>
            <div>Alhambra</div>
          </div>
          <div class="theme-card" data-themeid="ottoman" onclick="setTheme('ottoman')">
            <div class="theme-icon">üîµ</div>
            <div>Ottoman</div>
          </div>
          <div class="theme-card" data-themeid="moroccan" onclick="setTheme('moroccan')">
            <div class="theme-icon">üíé</div>
            <div>Moroccan</div>
          </div>
          <div class="theme-card" data-themeid="calligraphy" onclick="setTheme('calligraphy')">
            <div class="theme-icon">‚úíÔ∏è</div>
            <div>Calligraphy</div>
          </div>
          <div class="theme-card" data-themeid="ramadan" onclick="setTheme('ramadan')">
            <div class="theme-icon">üåô</div>
            <div>Ramadan</div>
          </div>
          <div class="theme-card" data-themeid="desert" onclick="setTheme('desert')">
            <div class="theme-icon">üèúÔ∏è</div>
            <div>Desert</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PIN Lock -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>üîí <span data-i18n="pinLockTitle">PIN Lock</span></h3>
        <span class="settings-arrow">‚ñº</span>
      </div>
      <div class="settings-body">
        <div class="setting-row">
          <span class="setting-label" data-i18n="enablePin">Enable PIN Lock</span><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipPin">Locks the app with a 4-digit code on startup. Prevents casual access but not bulletproof security.</span></button>
          <div class="toggle" id="pinToggle" onclick="togglePinSetting()"></div>
        </div>
        <div id="pinSetupArea" style="display:none;margin-top:12px;">
          <div class="form-group">
            <label data-i18n="setPin">Set 4-digit PIN</label>
            <div class="password-wrapper" style="max-width:160px;">
              <input type="password" id="pinSetInput" maxlength="4" inputmode="numeric" placeholder="0000">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('pinSetInput', this)" title="Show/Hide">ÿπŸÄ</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn btn-accent btn-sm" onclick="savePin()" data-i18n="savePin">Save PIN</button>
            <button class="btn btn-sm" id="changePinBtn" onclick="showChangePinModal()" style="display:none;" data-i18n="changePin">üîë Change PIN</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import / Export -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>üì¶ <span data-i18n="dataTitle">Data Management</span></h3>
        <span class="settings-arrow">‚ñº</span>
      </div>
      <div class="settings-body">
        <div class="setting-row">
          <span class="setting-label" data-i18n="syncDesc">Sync data to/from cloud</span>
          <button class="btn btn-sm btn-accent" onclick="manualSync()" data-i18n="syncNow">‚òÅÔ∏è Sync Now</button>
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="exportDesc">Export all data as JSON</span>
          <button class="btn btn-sm" onclick="exportData()" data-i18n="export">üì• Export</button>
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="importDesc">Import data from JSON</span>
          <button class="btn btn-sm" onclick="document.getElementById('importFile').click()" data-i18n="import">üì§ Import</button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="clearCacheDesc">Clear all local data &amp; cache</span>
          <button class="btn btn-sm btn-danger" onclick="clearAllData()" data-i18n="clearCache">üóëÔ∏è Clear Cache</button>
        </div>
      </div>
    </div>

    <!-- Firebase Config ‚Äî collapsed by default -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>‚òÅÔ∏è <span data-i18n="firebaseTitle">Firebase Cloud Sync</span></h3>
        <span class="settings-arrow">‚ñº</span>
      </div>
      <div class="settings-body">
        <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:12px;" data-i18n="firebaseDesc">
          To enable cloud sync, create a Firebase project and paste your config below.
        </p>
        <div class="form-group">
          <label>Firebase Config (JSON)</label>
          <textarea id="firebaseConfigInput" rows="5" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
        </div>
        <div class="form-actions" style="margin-top:8px;">
          <button class="btn btn-accent btn-sm" onclick="saveFirebaseConfig()" data-i18n="saveConfig">Save Config</button>
          <button class="btn btn-sm btn-danger" onclick="clearFirebaseConfig()" data-i18n="clearConfig">Clear Config</button>
        </div>
      </div>
    </div>

    <!-- About / Version ‚Äî always visible -->
    <div class="settings-section">
      <div class="settings-section-static" style="text-align:center;">
        <p style="color:var(--accent);font-weight:600;font-size:1em;display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;">
          üìù Tethkir ‚Äî ÿ™ÿ∞ŸÉŸäÿ±
          <span id="appVersion" style="color:var(--text-secondary);font-size:0.8em;font-weight:400;"></span>
          <a href="CHANGES.html" target="_blank" style="color:var(--accent);font-size:0.8em;text-decoration:underline;cursor:pointer;font-weight:400;" data-i18n="viewChangelog">View Changelog</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL CONTAINER ===== -->
<div class="modal-backdrop" id="modalBackdrop" style="display:none;" onclick="closeModal(event)">
  <div class="modal" id="modalContent" onclick="event.stopPropagation()"></div>
</div>

<script>
// ===== VERSION =====
const APP_VERSION = 'v1.0';

// ===== TRANSLATIONS =====
const i18n = {
  en: {
    appTitle: 'üìù Tethkir',
    modeLabel: 'Simple Mode', modeDesc: 'Hide advanced features (profiles, filters, encryption)',
    noNotesYet: 'No notes yet!', noteSaved: 'Note saved! ‚úÖ',
    offline: 'Offline', online: 'Synced', syncing: 'Syncing...',
    signIn: '‚òÅÔ∏è Sign In', signOut: '‚òÅÔ∏è Sign Out',
    tabTasks: 'Tasks', tabNotes: 'Secure Notes', tabNotesSimple: 'Notes', tabSettings: 'Settings',
    taskTitle: 'Task Title', taskTitlePlaceholder: 'What do you need to do?',
    priority: 'Priority', dueDate: 'Due Date', category: 'Category', tags: 'Tags',
    tagsPlaceholder: 'comma separated',
    low: 'Low', medium: 'Medium', high: 'High',
    catGeneral: 'General', catWork: 'Work', catPersonal: 'Personal',
    catHomework: 'üìö Homework', catChores: 'üßπ Chores', catDua: 'ü§≤ Dua / Quran',
    catActivities: 'üèÉ Activities', catFun: 'üé® Fun',
    clear: 'Clear', addTask: '+ Add Task', editTask: 'Save Edit',
    searchPlaceholder: 'Search tasks...',
    allPriorities: 'All Priorities', allCategories: 'All Categories',
    allStatus: 'All', active: 'Active', done: 'Done',
    emptyTitle: 'No tasks yet!', emptyDesc: 'Add your first task above',
    secureNotesTitle: 'üîê Secure Notes (AES Encrypted)',
    secureNotesDesc: 'Notes are encrypted with your passphrase. Without it, nobody can read them.',
    passphrase: 'Master Passphrase', passphrasePlaceholder: 'Enter your secret passphrase',
    confirmPassphrase: 'Confirm Passphrase', confirmPassphrasePlaceholder: 'Re-enter your passphrase',
    passMismatch: "Passphrases don't match", enterConfirm: 'Please confirm your passphrase',
    wrongPassphrase: '‚ùå Wrong passphrase. Cannot decrypt notes.',
    unlock: 'üîì Unlock', lock: 'üîí Lock',
    noteTitle: 'Note Title', noteTitlePlaceholder: 'Note title...',
    noteContent: 'Content', noteContentPlaceholder: 'Your secret note...',
    addNote: '+ Add Note',
    saveNote: 'üîê Encrypt & Save',
    writeNewNote: '‚úèÔ∏è Write New Note',
    newNoteTitle: 'New Note',
    cancel: 'Cancel',
    themesTitle: 'Themes', pinLockTitle: 'PIN Lock',
    enablePin: 'Enable PIN Lock', setPin: 'Set 4-digit PIN', savePin: 'Save PIN',
    dataTitle: 'Data Management',
    syncDesc: 'Sync data to/from cloud', syncNow: '‚òÅÔ∏è Sync Now',
    syncing: 'Syncing...', syncDone: 'Sync complete! ‚úÖ', syncError: 'Sync failed ‚ùå', syncNotSignedIn: 'Sign in to Firebase first ‚òÅÔ∏è',
    exportDesc: 'Export all data as JSON', export: 'üì• Export',
    importDesc: 'Import data from JSON', import: 'üì§ Import',
    clearCacheDesc: 'Clear local data & cache', clearCache: 'üóëÔ∏è Clear Cache',
    clearAllConfirm: 'This will delete ALL local data (tasks, notes, settings). Cloud data is not affected.\n\nAre you sure?',
    clearAllDone: 'Cache cleared! üóëÔ∏è',
    firebaseTitle: 'Firebase Cloud Sync',
    firebaseDesc: 'To enable cloud sync, create a Firebase project and paste your config below.',
    saveConfig: 'Save Config', clearConfig: 'Clear Config',
    defaultProfile: 'Default',
    enterPin: 'Enter PIN', wrongPin: 'Wrong PIN, try again',
    taskAdded: 'Task added! ‚ú®', taskDone: 'Ma Shaa Allah! ‚úÖ',
    taskDeleted: 'Task deleted', noteAdded: 'Note encrypted & saved üîê',
    dataExported: 'Data exported! üì¶', dataImported: 'Data imported! ‚úÖ',
    confirmDelete: 'Delete this?',
    kbCopied: 'Copied to clipboard! üìã',
    kbPasted: 'Inserted into field',
    kbNoField: 'Click on an input field first',
    kbNothingToPaste: 'Nothing to insert ‚Äî type something first',
    kbDirectOn: 'Direct mode: typing into focused field',
    kbPreviewOn: 'Preview mode: type in keyboard preview',
    kbPhrases: 'Phrases', kbCopy: 'Copy', kbPaste: 'Paste to field', kbClear: 'Clear',
    kbDirect: 'Direct mode', kbSwitchPreview: 'Preview mode', kbSwitchDirect: 'Direct mode',
    changePassphrase: 'üîë Change Passphrase',
    changePassDesc: 'All notes will be re-encrypted with the new passphrase.',
    currentPassphrase: 'Current Passphrase',
    newPassphrase: 'New Passphrase', newPassPlaceholder: 'Enter new passphrase',
    confirmNewPassphrase: 'Confirm New Passphrase',
    enterCurrent: 'Enter your current passphrase',
    enterNew: 'Enter a new passphrase',
    passTooShort: 'Passphrase must be at least 3 characters',
    passSameAsOld: 'New passphrase must be different from current',
    confirmChange: 'Change & Re-encrypt',
    passChanged: 'Passphrase changed! All notes re-encrypted üîê',
    reEncryptError: '‚ùå Error re-encrypting. Some notes may use a different passphrase.',
    changePin: 'üîë Change PIN',
    currentPin: 'Current PIN', newPin: 'New PIN', confirmNewPin: 'Confirm New PIN',
    enterValidPin: 'Enter your current 4-digit PIN',
    enterNewPin: 'Enter a new 4-digit PIN',
    pinMismatch: "PINs don't match",
    pinSameAsOld: 'New PIN must be different from current',
    confirmPinChange: 'Change PIN',
    pinChanged: 'PIN changed! üîí',
    viewChangelog: 'View Changelog',
    helpTitle: 'Help & Guide', helpSearchPlaceholder: 'Search help...',
    helpQuickStart: 'üöÄ QUICK START', helpFeatures: 'üìö FEATURE GUIDE', helpFAQ: '‚ùì FREQUENTLY ASKED QUESTIONS',
    helpTip1Title: 'Add a Task', helpTip1Desc: 'Type a title in the Tasks tab and click "+ Add Task". Set priority, due date, and category.',
    helpTip2Title: 'Complete a Task', helpTip2Desc: 'Click the checkbox on any task to mark it done.',
    helpTip3Title: 'Change Theme', helpTip3Desc: 'Go to Settings ‚Üí Themes and pick from 7 beautiful Islamic-inspired designs.',
    helpTip4Title: 'Switch Language', helpTip4Desc: 'Use the language dropdown (EN/FR/AR) in the top bar. Arabic enables RTL layout.',
    tooltipPriority: 'High = urgent (red), Medium = normal (yellow), Low = can wait (green).',
    tooltipTags: 'Add labels separated by commas. Use search to find tasks by tag.',
    tooltipPin: 'Locks the app with a 4-digit code on startup.',
    shortcutsTitle: 'Islamic Phrases', addCustomShortcut: '+ Add Custom Phrase',
    scArabic: 'Arabic Text *', scTranslit: 'Transliteration', scMeaning: 'Meaning', scSave: 'Save',
    scCustomLabel: '‚úèÔ∏è YOUR CUSTOM PHRASES', scBuiltinLabel: 'ü§≤ ISLAMIC PHRASES',
    scSaved: 'Custom phrase saved! ü§≤', scDeleted: 'Phrase deleted',
    scInserted: 'Phrase added to preview ‚úÖ', scTapToInsert: 'Tap to add to preview',
    profileName: 'Profile Name', profileNamePlaceholder: 'Enter name...',
    createProfile: 'Create',
  },
  fr: {
    appTitle: 'üìù Tethkir',
    modeLabel: 'Mode Simple', modeDesc: 'Masquer les fonctions avanc√©es (profils, filtres, chiffrement)',
    noNotesYet: 'Aucune note !', noteSaved: 'Note enregistr√©e ! ‚úÖ',
    offline: 'Hors ligne', online: 'Synchronis√©', syncing: 'Synchronisation...',
    signIn: '‚òÅÔ∏è Connexion', signOut: '‚òÅÔ∏è D√©connexion',
    tabTasks: 'T√¢ches', tabNotes: 'Notes S√©curis√©es', tabNotesSimple: 'Notes', tabSettings: 'Param√®tres',
    taskTitle: 'Titre de la t√¢che', taskTitlePlaceholder: 'Que devez-vous faire?',
    priority: 'Priorit√©', dueDate: 'Date limite', category: 'Cat√©gorie', tags: '√âtiquettes',
    tagsPlaceholder: 's√©par√©es par des virgules',
    low: 'Basse', medium: 'Moyenne', high: 'Haute',
    catGeneral: 'G√©n√©ral', catWork: 'Travail', catPersonal: 'Personnel',
    catHomework: 'üìö Devoirs', catChores: 'üßπ Corv√©es', catDua: 'ü§≤ Dua / Coran',
    catActivities: 'üèÉ Activit√©s', catFun: 'üé® Amusement',
    clear: 'Effacer', addTask: '+ Ajouter', editTask: 'Sauvegarder',
    searchPlaceholder: 'Rechercher...',
    allPriorities: 'Toutes priorit√©s', allCategories: 'Toutes cat√©gories',
    allStatus: 'Tout', active: 'Actif', done: 'Fait',
    emptyTitle: 'Aucune t√¢che!', emptyDesc: 'Ajoutez votre premi√®re t√¢che',
    secureNotesTitle: 'üîê Notes S√©curis√©es (Chiffrement AES)',
    secureNotesDesc: 'Les notes sont chiffr√©es avec votre mot de passe.',
    passphrase: 'Mot de passe ma√Ætre', passphrasePlaceholder: 'Entrez votre mot de passe secret',
    confirmPassphrase: 'Confirmer le mot de passe', confirmPassphrasePlaceholder: 'R√©-entrez votre mot de passe',
    passMismatch: 'Les mots de passe ne correspondent pas', enterConfirm: 'Veuillez confirmer votre mot de passe',
    wrongPassphrase: '‚ùå Mot de passe incorrect. Impossible de d√©chiffrer.',
    unlock: 'üîì D√©verrouiller', lock: 'üîí Verrouiller',
    noteTitle: 'Titre', noteTitlePlaceholder: 'Titre de la note...',
    noteContent: 'Contenu', noteContentPlaceholder: 'Votre note secr√®te...',
    addNote: '+ Ajouter',
    saveNote: 'üîê Chiffrer & Sauver',
    writeNewNote: '‚úèÔ∏è √âcrire une note',
    newNoteTitle: 'Nouvelle note',
    cancel: 'Annuler',
    themesTitle: 'Th√®mes', pinLockTitle: 'Verrouillage PIN',
    enablePin: 'Activer le PIN', setPin: 'PIN √† 4 chiffres', savePin: 'Sauvegarder',
    dataTitle: 'Gestion des donn√©es',
    syncDesc: 'Synchroniser avec le cloud', syncNow: '‚òÅÔ∏è Synchroniser',
    syncing: 'Synchronisation...', syncDone: 'Synchronisation termin√©e ! ‚úÖ', syncError: '√âchec de la sync ‚ùå', syncNotSignedIn: 'Connectez-vous √† Firebase d\'abord ‚òÅÔ∏è',
    exportDesc: 'Exporter en JSON', export: 'üì• Exporter',
    importDesc: 'Importer depuis JSON', import: 'üì§ Importer',
    clearCacheDesc: 'Effacer les donn√©es locales', clearCache: 'üóëÔ∏è Vider le cache',
    clearAllConfirm: 'Cela supprimera TOUTES les donn√©es locales (t√¢ches, notes, param√®tres). Les donn√©es cloud ne sont pas affect√©es.\n\n√ätes-vous s√ªr ?',
    clearAllDone: 'Cache vid√© ! üóëÔ∏è',
    firebaseTitle: 'Firebase Synchronisation',
    firebaseDesc: 'Cr√©ez un projet Firebase et collez la configuration.',
    saveConfig: 'Sauvegarder', clearConfig: 'Effacer',
    defaultProfile: 'Par d√©faut',
    enterPin: 'Entrez le PIN', wrongPin: 'PIN incorrect, r√©essayez',
    taskAdded: 'T√¢che ajout√©e! ‚ú®', taskDone: 'Ma Shaa Allah! ‚úÖ',
    taskDeleted: 'T√¢che supprim√©e', noteAdded: 'Note chiffr√©e et sauv√©e üîê',
    dataExported: 'Donn√©es export√©es! üì¶', dataImported: 'Donn√©es import√©es! ‚úÖ',
    confirmDelete: 'Supprimer?',
    kbCopied: 'Copi√©! üìã',
    kbPasted: 'Ins√©r√© dans le champ',
    kbNoField: 'Cliquez sur un champ de saisie d\'abord',
    kbNothingToPaste: 'Rien √† ins√©rer ‚Äî tapez quelque chose d\'abord',
    kbDirectOn: 'Mode direct: saisie dans le champ actif',
    kbPreviewOn: 'Mode aper√ßu: saisie dans l\'aper√ßu clavier',
    kbPhrases: 'Phrases', kbCopy: 'Copier', kbPaste: 'Coller dans le champ', kbClear: 'Effacer',
    kbDirect: 'Mode direct', kbSwitchPreview: 'Mode aper√ßu', kbSwitchDirect: 'Mode direct',
    changePassphrase: 'üîë Changer le mot de passe',
    changePassDesc: 'Toutes les notes seront re-chiffr√©es avec le nouveau mot de passe.',
    currentPassphrase: 'Mot de passe actuel',
    newPassphrase: 'Nouveau mot de passe', newPassPlaceholder: 'Entrez le nouveau mot de passe',
    confirmNewPassphrase: 'Confirmer le nouveau mot de passe',
    enterCurrent: 'Entrez votre mot de passe actuel',
    enterNew: 'Entrez un nouveau mot de passe',
    passTooShort: 'Le mot de passe doit avoir au moins 3 caract√®res',
    passSameAsOld: 'Le nouveau mot de passe doit √™tre diff√©rent',
    confirmChange: 'Changer & Re-chiffrer',
    passChanged: 'Mot de passe chang√©! Notes re-chiffr√©es üîê',
    reEncryptError: '‚ùå Erreur de re-chiffrement.',
    changePin: 'üîë Changer le PIN',
    currentPin: 'PIN actuel', newPin: 'Nouveau PIN', confirmNewPin: 'Confirmer le nouveau PIN',
    enterValidPin: 'Entrez votre PIN actuel √† 4 chiffres',
    enterNewPin: 'Entrez un nouveau PIN √† 4 chiffres',
    pinMismatch: 'Les PINs ne correspondent pas',
    pinSameAsOld: 'Le nouveau PIN doit √™tre diff√©rent',
    confirmPinChange: 'Changer le PIN',
    pinChanged: 'PIN chang√©! üîí',
    viewChangelog: 'Voir les changements',
    helpTitle: 'Aide & Guide', helpSearchPlaceholder: 'Rechercher...',
    helpQuickStart: 'üöÄ D√âMARRAGE RAPIDE', helpFeatures: 'üìö GUIDE DES FONCTIONNALIT√âS', helpFAQ: '‚ùì QUESTIONS FR√âQUENTES',
    helpTip1Title: 'Ajouter une t√¢che', helpTip1Desc: 'Tapez un titre dans l\'onglet T√¢ches et cliquez "+ Ajouter". D√©finissez priorit√©, date et cat√©gorie.',
    helpTip2Title: 'Terminer une t√¢che', helpTip2Desc: 'Cliquez la case √† cocher pour marquer une t√¢che comme termin√©e. En mode enfants, gagnez une √©toile! ‚≠ê',
    helpTip3Title: 'Changer le th√®me', helpTip3Desc: 'Allez dans Param√®tres ‚Üí Th√®mes et choisissez parmi 7 designs islamiques.',
    helpTip4Title: 'Changer la langue', helpTip4Desc: 'Utilisez le menu d√©roulant (EN/FR/AR) dans la barre sup√©rieure. L\'arabe active le mode RTL.',
    tooltipPriority: 'Haute = urgent (rouge), Moyenne = normal (jaune), Basse = peut attendre (vert).',
    tooltipTags: 'Ajoutez des √©tiquettes s√©par√©es par des virgules.',
    tooltipPin: 'Verrouille l\'appli avec un code √† 4 chiffres au d√©marrage.',
    shortcutsTitle: 'Phrases Islamiques', addCustomShortcut: '+ Ajouter une phrase',
    scArabic: 'Texte arabe *', scTranslit: 'Translitt√©ration', scMeaning: 'Signification', scSave: 'Sauver',
    scCustomLabel: '‚úèÔ∏è VOS PHRASES PERSONNALIS√âES', scBuiltinLabel: 'ü§≤ PHRASES ISLAMIQUES',
    scSaved: 'Phrase sauvegard√©e! ü§≤', scDeleted: 'Phrase supprim√©e',
    scInserted: 'Phrase ajout√©e √† l\'aper√ßu ‚úÖ', scTapToInsert: 'Appuyez pour ajouter',
    profileName: 'Nom du profil', profileNamePlaceholder: 'Entrez le nom...',
    createProfile: 'Cr√©er',
  },
  ar: {
    appTitle: 'üìù ÿ™ÿ∞ŸÉŸäÿ±',
    modeLabel: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ®ÿ≥Ÿäÿ∑', modeDesc: 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© (ÿßŸÑŸÖŸÑŸÅÿßÿ™ÿå ÿßŸÑŸÅŸÑÿßÿ™ÿ±ÿå ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±)',
    noNotesYet: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™!', noteSaved: 'ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©! ‚úÖ',
    offline: 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ', online: 'ŸÖÿ™ÿµŸÑ', syncing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...',
    signIn: '‚òÅÔ∏è ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ', signOut: '‚òÅÔ∏è ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
    tabTasks: 'ÿßŸÑŸÖŸáÿßŸÖ', tabNotes: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ¢ŸÖŸÜÿ©', tabNotesSimple: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', tabSettings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
    taskTitle: 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸáŸÖÿ©', taskTitlePlaceholder: 'ŸÖÿßÿ∞ÿß ÿ™ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ŸÅÿπŸÑÿü',
    priority: 'ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©', dueDate: 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ', category: 'ÿßŸÑŸÅÿ¶ÿ©', tags: 'ÿßŸÑÿπŸÑÿßŸÖÿßÿ™',
    tagsPlaceholder: 'ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ',
    low: 'ŸÖŸÜÿÆŸÅÿ∂ÿ©', medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©', high: 'ÿπÿßŸÑŸäÿ©',
    catGeneral: 'ÿπÿßŸÖ', catWork: 'ÿπŸÖŸÑ', catPersonal: 'ÿ¥ÿÆÿµŸä',
    catHomework: 'üìö Ÿàÿßÿ¨ÿ®ÿßÿ™', catChores: 'üßπ ÿ£ÿπŸÖÿßŸÑ ŸÖŸÜÿ≤ŸÑŸäÿ©', catDua: 'ü§≤ ÿØÿπÿßÿ° / ŸÇÿ±ÿ¢ŸÜ',
    catActivities: 'üèÉ ÿ£ŸÜÿ¥ÿ∑ÿ©', catFun: 'üé® ÿ™ÿ±ŸÅŸäŸá',
    clear: 'ŸÖÿ≥ÿ≠', addTask: '+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ©', editTask: 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ',
    searchPlaceholder: 'ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸáÿßŸÖ...',
    allPriorities: 'ŸÉŸÑ ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™', allCategories: 'ŸÉŸÑ ÿßŸÑŸÅÿ¶ÿßÿ™',
    allStatus: 'ÿßŸÑŸÉŸÑ', active: 'ŸÜÿ¥ÿ∑', done: 'ŸÖŸÉÿ™ŸÖŸÑ',
    emptyTitle: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸáÿßŸÖ!', emptyDesc: 'ÿ£ÿ∂ŸÅ ŸÖŸáŸÖÿ™ŸÉ ÿßŸÑÿ£ŸàŸÑŸâ',
    secureNotesTitle: 'üîê ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ¢ŸÖŸÜÿ© (ÿ™ÿ¥ŸÅŸäÿ± AES)',
    secureNotesDesc: 'ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖÿ¥ŸÅÿ±ÿ© ÿ®ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ.',
    passphrase: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', passphrasePlaceholder: 'ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≥ÿ±Ÿäÿ©',
    confirmPassphrase: 'ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', confirmPassphrasePlaceholder: 'ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    passMismatch: 'ŸÉŸÑŸÖÿ™ÿß ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ™ŸäŸÜ', enterConfirm: 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    wrongPassphrase: '‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©. ŸÑÿß ŸäŸÖŸÉŸÜ ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±.',
    unlock: 'üîì ŸÅÿ™ÿ≠', lock: 'üîí ŸÇŸÅŸÑ',
    noteTitle: 'ÿßŸÑÿπŸÜŸàÿßŸÜ', noteTitlePlaceholder: 'ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©...',
    noteContent: 'ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ', noteContentPlaceholder: 'ŸÖŸÑÿßÿ≠ÿ∏ÿ™ŸÉ ÿßŸÑÿ≥ÿ±Ÿäÿ©...',
    addNote: '+ ÿ•ÿ∂ÿßŸÅÿ©',
    saveNote: 'üîê ÿ™ÿ¥ŸÅŸäÿ± Ÿàÿ≠ŸÅÿ∏',
    writeNewNote: '‚úèÔ∏è ŸÉÿ™ÿßÿ®ÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©',
    newNoteTitle: 'ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©',
    cancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
    themesTitle: 'ÿßŸÑÿ≥ŸÖÿßÿ™', pinLockTitle: 'ŸÇŸÅŸÑ PIN',
    enablePin: 'ÿ™ŸÅÿπŸäŸÑ ŸÇŸÅŸÑ PIN', setPin: 'PIN ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ', savePin: 'ÿ≠ŸÅÿ∏',
    dataTitle: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
    syncDesc: 'ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©', syncNow: '‚òÅÔ∏è ŸÖÿ≤ÿßŸÖŸÜÿ©',
    syncing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...', syncDone: 'ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©! ‚úÖ', syncError: 'ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ‚ùå', syncNotSignedIn: 'ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ‚òÅÔ∏è',
    exportDesc: 'ÿ™ÿµÿØŸäÿ± ŸÉŸÖŸÑŸÅ JSON', export: 'üì• ÿ™ÿµÿØŸäÿ±',
    importDesc: 'ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ JSON', import: 'üì§ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ',
    clearCacheDesc: 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©', clearCache: 'üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©',
    clearAllConfirm: 'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© (ÿßŸÑŸÖŸáÿßŸÖÿå ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ÿå ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™). ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ© ŸÑŸÜ ÿ™ÿ™ÿ£ÿ´ÿ±.\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü',
    clearAllDone: 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©! üóëÔ∏è',
    firebaseTitle: 'ŸÖÿ≤ÿßŸÖŸÜÿ© Firebase ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©',
    firebaseDesc: 'ÿ£ŸÜÿ¥ÿ¶ ŸÖÿ¥ÿ±Ÿàÿπ Firebase ŸàÿßŸÑÿµŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™.',
    saveConfig: 'ÿ≠ŸÅÿ∏', clearConfig: 'ŸÖÿ≥ÿ≠',
    defaultProfile: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä',
    enterPin: 'ÿ£ÿØÿÆŸÑ PIN', wrongPin: 'PIN ÿÆÿßÿ∑ÿ¶ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ',
    taskAdded: 'ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ©! ‚ú®', taskDone: 'ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá! ‚úÖ',
    taskDeleted: 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸáŸÖÿ©', noteAdded: 'ÿ™ŸÖ ÿ™ÿ¥ŸÅŸäÿ± Ÿàÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© üîê',
    dataExported: 'ÿ™ŸÖ ÿßŸÑÿ™ÿµÿØŸäÿ±! üì¶', dataImported: 'ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ! ‚úÖ',
    confirmDelete: 'ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿßÿü',
    kbCopied: 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ! üìã',
    kbPasted: 'ÿ™ŸÖ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ',
    kbNoField: 'ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ≠ŸÇŸÑ ÿ•ÿØÿÆÿßŸÑ ÿ£ŸàŸÑÿßŸã',
    kbNothingToPaste: 'ŸÑÿß ÿ¥Ÿäÿ° ŸÑŸÑÿ•ÿØÿ±ÿßÿ¨ ‚Äî ÿßŸÉÿ™ÿ® ÿ¥Ÿäÿ¶ÿßŸã ÿ£ŸàŸÑÿßŸã',
    kbDirectOn: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±: ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿ≠ÿØÿØ',
    kbPreviewOn: 'Ÿàÿ∂ÿπ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©: ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠',
    kbPhrases: 'ÿπÿ®ÿßÿ±ÿßÿ™', kbCopy: 'ŸÜÿ≥ÿÆ', kbPaste: 'ŸÑÿµŸÇ ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ', kbClear: 'ŸÖÿ≥ÿ≠',
    kbDirect: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±', kbSwitchPreview: 'Ÿàÿ∂ÿπ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©', kbSwitchDirect: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±',
    changePassphrase: 'üîë ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    changePassDesc: 'ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ®ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©.',
    currentPassphrase: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©',
    newPassphrase: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©', newPassPlaceholder: 'ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©',
    confirmNewPassphrase: 'ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©',
    enterCurrent: 'ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©',
    enterNew: 'ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿ¨ÿØŸäÿØÿ©',
    passTooShort: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 3 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ',
    passSameAsOld: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿÆÿ™ŸÑŸÅÿ©',
    confirmChange: 'ÿ™ÿ∫ŸäŸäÿ± Ÿàÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±',
    passChanged: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±! ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ üîê',
    reEncryptError: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±.',
    changePin: 'üîë ÿ™ÿ∫ŸäŸäÿ± PIN',
    currentPin: 'PIN ÿßŸÑÿ≠ÿßŸÑŸä', newPin: 'PIN ÿßŸÑÿ¨ÿØŸäÿØ', confirmNewPin: 'ÿ™ÿ£ŸÉŸäÿØ PIN ÿßŸÑÿ¨ÿØŸäÿØ',
    enterValidPin: 'ÿ£ÿØÿÆŸÑ PIN ÿßŸÑÿ≠ÿßŸÑŸä ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ',
    enterNewPin: 'ÿ£ÿØÿÆŸÑ PIN ÿ¨ÿØŸäÿØ ŸÖŸÉŸàŸÜ ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ',
    pinMismatch: 'ÿ£ÿ±ŸÇÿßŸÖ PIN ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©',
    pinSameAsOld: 'PIN ÿßŸÑÿ¨ÿØŸäÿØ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÖÿÆÿ™ŸÑŸÅÿßŸã',
    confirmPinChange: 'ÿ™ÿ∫ŸäŸäÿ± PIN',
    pinChanged: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± PIN! üîí',
    viewChangelog: 'ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™',
    helpTitle: 'ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸàÿßŸÑÿØŸÑŸäŸÑ', helpSearchPlaceholder: 'ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©...',
    helpQuickStart: 'üöÄ ÿßŸÑÿ®ÿØÿßŸäÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©', helpFeatures: 'üìö ÿØŸÑŸäŸÑ ÿßŸÑŸÖŸäÿ≤ÿßÿ™', helpFAQ: '‚ùì ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©',
    helpTip1Title: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ©', helpTip1Desc: 'ÿßŸÉÿ™ÿ® ÿπŸÜŸàÿßŸÜÿßŸã ŸÅŸä ÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÖŸáÿßŸÖ ŸàÿßŸÜŸÇÿ± "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ©". ÿ≠ÿØÿØ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÅÿ¶ÿ©.',
    helpTip2Title: 'ÿ•ŸÉŸÖÿßŸÑ ŸÖŸáŸÖÿ©', helpTip2Desc: 'ÿßŸÜŸÇÿ± ÿπŸÑŸâ ŸÖÿ±ÿ®ÿπ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸáŸÖÿ© ŸÉŸÖŸÉÿ™ŸÖŸÑÿ©. ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑÿå ÿ≥ÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÜÿ¨ŸÖÿ©! ‚≠ê',
    helpTip3Title: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≥ŸÖÿ©', helpTip3Desc: 'ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚Üí ÿßŸÑÿ≥ŸÖÿßÿ™ ŸàÿßÿÆÿ™ÿ± ŸÖŸÜ 7 ÿ™ÿµÿßŸÖŸäŸÖ ÿ•ÿ≥ŸÑÿßŸÖŸäÿ© ÿ¨ŸÖŸäŸÑÿ©.',
    helpTip4Title: 'ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©', helpTip4Desc: 'ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÑÿ∫ÿßÿ™ (EN/FR/AR) ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä. ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ™ŸÅÿπŸëŸÑ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ŸÖŸÜ ÿßŸÑŸäŸÖŸäŸÜ ŸÑŸÑŸäÿ≥ÿßÿ±.',
    tooltipPriority: 'ÿπÿßŸÑŸäÿ© = ÿπÿßÿ¨ŸÑ (ÿ£ÿ≠ŸÖÿ±)ÿå ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© = ÿπÿßÿØŸä (ÿ£ÿµŸÅÿ±)ÿå ŸÖŸÜÿÆŸÅÿ∂ÿ© = ŸäŸÖŸÉŸÜ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± (ÿ£ÿÆÿ∂ÿ±).',
    tooltipTags: 'ÿ£ÿ∂ŸÅ ÿπŸÑÿßŸÖÿßÿ™ ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸáÿßŸÖ.',
    tooltipPin: 'ŸäŸÇŸÅŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿ±ŸÖÿ≤ ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ®ÿØÿ°.',
    shortcutsTitle: 'ÿπÿ®ÿßÿ±ÿßÿ™ ÿ•ÿ≥ŸÑÿßŸÖŸäÿ©', addCustomShortcut: '+ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ®ÿßÿ±ÿ© ŸÖÿÆÿµÿµÿ©',
    scArabic: 'ÿßŸÑŸÜÿµ ÿßŸÑÿπÿ±ÿ®Ÿä *', scTranslit: 'ÿßŸÑŸÜŸÇŸÑ ÿßŸÑÿ≠ÿ±ŸÅŸä', scMeaning: 'ÿßŸÑŸÖÿπŸÜŸâ', scSave: 'ÿ≠ŸÅÿ∏',
    scCustomLabel: '‚úèÔ∏è ÿπÿ®ÿßÿ±ÿßÿ™ŸÉ ÿßŸÑŸÖÿÆÿµÿµÿ©', scBuiltinLabel: 'ü§≤ ÿπÿ®ÿßÿ±ÿßÿ™ ÿ•ÿ≥ŸÑÿßŸÖŸäÿ©',
    scSaved: 'ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπÿ®ÿßÿ±ÿ©! ü§≤', scDeleted: 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿπÿ®ÿßÿ±ÿ©',
    scInserted: 'ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπÿ®ÿßÿ±ÿ© ŸÑŸÑŸÖÿπÿßŸäŸÜÿ© ‚úÖ', scTapToInsert: 'ÿßŸÜŸÇÿ± ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©',
    profileName: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä', profileNamePlaceholder: 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ...',
    createProfile: 'ÿ•ŸÜÿ¥ÿßÿ°',
  }
};

// ===== STATE =====
let state = {
  lang: 'en',
  theme: 'alhambra',
  pinEnabled: false,
  pin: '',
  currentProfile: 'default',
  profiles: ['default'],
  tasks: {},        // { profileId: [ task, ... ] }
  notes: [],        // encrypted notes
  simpleNotes: {},  // { profileId: [ {id, title, content, created}, ... ] }
  simpleMode: true, // default simple
  firebaseConfig: null,
  notePassphrase: null,
  editingTaskId: null,
};

// ===== INIT =====
function init() {
  loadState();
  // Default to simple mode for new users
  if (state.simpleMode === undefined) state.simpleMode = true;
  applySimpleMode();
  applyLang(state.lang);
  setTheme(state.theme);
  if (state.pinEnabled && state.pin) showPinLock();
  renderProfiles();
  renderTasks();
  // Set initial connection status
  updateSyncUI(false);
  // Load firebase config
  const fc = localStorage.getItem('tethkir_firebase');
  if (fc) {
    state.firebaseConfig = JSON.parse(fc);
    document.getElementById('firebaseConfigInput').value = fc;
    // Auto-load Firebase SDK and init
    loadFirebaseSDK().then(() => {
      initFirebase(state.firebaseConfig);
    }).catch(e => console.error('Firebase auto-load failed:', e));
  }
  if (state.pinEnabled) {
    document.getElementById('pinToggle').classList.add('active');
  }
  updateChangePinBtn();
  document.getElementById('appVersion').textContent = APP_VERSION;
}

function loadState() {
  try {
    const saved = localStorage.getItem('tethkir_state');
    if (saved) {
      const parsed = JSON.parse(saved);
      state = { ...state, ...parsed };
    }
    if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
  } catch(e) { console.error('Load error', e); }
}

function saveState() {
  try {
    // Exclude notePassphrase from storage for security
    const toSave = { ...state, notePassphrase: null };
    localStorage.setItem('tethkir_state', JSON.stringify(toSave));
    // Auto-sync to cloud if signed in
    if (firebaseReady && firebaseAuth?.currentUser) syncToCloud();
  } catch(e) { console.error('Save error', e); }
}

// ===== LANGUAGE =====
function applyLang(lang) {
  state.lang = lang;
  updateLangPicker(lang);
  const dir = lang === 'ar' ? 'rtl' : 'ltr';
  document.documentElement.setAttribute('lang', lang);
  document.documentElement.setAttribute('dir', dir);

  // Apply translations
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[lang] && i18n[lang][key]) {
      el.textContent = i18n[lang][key];
    }
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (i18n[lang] && i18n[lang][key]) {
      el.setAttribute('placeholder', i18n[lang][key]);
    }
  });
  saveState();
}

// ===== LANGUAGE PICKER =====
const langFlags = {
  en: '<svg width="22" height="16" viewBox="0 0 60 30"><clipPath id="ukc2"><rect width="60" height="30" rx="2"/></clipPath><g clip-path="url(#ukc2)"><rect width="60" height="30" fill="#012169"/><path d="M0,0L60,30M60,0L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0L60,30M60,0L0,30" stroke="#C8102E" stroke-width="4"/><path d="M30,0V30M0,15H60" stroke="#fff" stroke-width="10"/><path d="M30,0V30M0,15H60" stroke="#C8102E" stroke-width="6"/></g></svg>',
  fr: '<svg width="22" height="16" viewBox="0 0 60 30"><rect width="20" height="30" fill="#002395"/><rect x="20" width="20" height="30" fill="#fff"/><rect x="40" width="20" height="30" fill="#ED2939"/></svg>',
  ar: '<svg width="22" height="16" viewBox="0 0 60 30"><rect width="30" height="30" fill="#006233"/><rect x="30" width="30" height="30" fill="#fff"/><circle cx="30" cy="15" r="7" fill="#D21034"/><circle cx="32" cy="15" r="5.8" fill="#fff"/><polygon points="33.5,9.5 34.8,13 38.5,13 35.5,15.3 36.5,19 33.5,16.5 30.5,19 31.5,15.3 28.5,13 32.2,13" fill="#D21034"/></svg>'
};

function updateLangPicker(lang) {
  document.getElementById('langFlag').innerHTML = langFlags[lang] || langFlags.en;
  document.getElementById('langCode').textContent = lang.toUpperCase();
}

function toggleLangPicker() {
  document.getElementById('langPickerMenu').classList.toggle('open');
}

function selectLang(lang) {
  document.getElementById('langPickerMenu').classList.remove('open');
  applyLang(lang);
  applySimpleMode();
  renderTasks();
  updateSyncUI(firebaseAuth?.currentUser != null, firebaseAuth?.currentUser?.displayName);
}

// Close picker on outside click
document.addEventListener('click', (e) => {
  const picker = document.getElementById('langPicker');
  if (picker && !picker.contains(e.target)) {
    document.getElementById('langPickerMenu').classList.remove('open');
  }
});

// ===== THEMES =====
function setTheme(themeId) {
  state.theme = themeId;
  document.body.setAttribute('data-theme', themeId);
  document.querySelectorAll('.theme-card').forEach(c => {
    c.classList.toggle('active', c.dataset.themeid === themeId);
  });
  saveState();
}

// ===== TABS =====
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === `page-${tabName}`));
  if (tabName === 'notes' && state.simpleMode) renderSimpleNotes();
}

// ===== PROFILES =====
function switchProfile(profileId) {
  state.currentProfile = profileId;
  if (!state.tasks[profileId]) state.tasks[profileId] = [];
  renderProfiles();
  renderTasks();
  saveState();
}

function renderProfiles() {
  const bar = document.getElementById('profilesBar');
  let html = '';
  state.profiles.forEach(p => {
    const icon = 'üë§';
    const active = p === state.currentProfile ? 'active' : '';
    const label = p === 'default' ? (i18n[state.lang]?.defaultProfile || 'Default') :
                  p;
    html += `<button class="profile-chip ${active}" onclick="switchProfile('${p}')">${icon} ${label}</button>`;
  });
  html += `<button class="btn btn-sm" onclick="showAddProfileModal()">+ ${i18n[state.lang]?.addProfile || 'Profile'}</button>`;
  bar.innerHTML = html;
}

function showAddProfileModal() {
  const lang = state.lang;
  const t = i18n[lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>${t.addProfile}</h2>
    <div class="form-group">
      <label>${t.profileName}</label>
      <input type="text" id="newProfileName" placeholder="${t.profileNamePlaceholder}">
    </div>
    <div class="form-actions" style="margin-top:12px;">
      <button class="btn" onclick="closeModal()">${t.clear}</button>
      <button class="btn btn-accent" onclick="createProfile()">${t.createProfile}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function createProfile() {
  const name = document.getElementById('newProfileName').value.trim();
  if (!name || state.profiles.includes(name)) return;
  state.profiles.push(name);
  state.tasks[name] = [];
  switchProfile(name);
  closeModal();
  saveState();
}

function closeModal(e) {
  if (e && e.target && e.target !== document.getElementById('modalBackdrop')) return;
  document.getElementById('modalBackdrop').style.display = 'none';
}

// ===== TASKS =====
function getTasks() {
  return state.tasks[state.currentProfile] || [];
}

function addTask() {
  const title = document.getElementById('taskTitleInput').value.trim();
  if (!title) return;

  const task = {
    id: state.editingTaskId || Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    title,
    priority: document.getElementById('taskPriority').value,
    dueDate: document.getElementById('taskDueDate').value,
    category: document.getElementById('taskCategory').value,
    tags: document.getElementById('taskTags').value.split(',').map(t=>t.trim()).filter(Boolean),
    done: false,
    createdAt: new Date().toISOString(),
  };

  if (state.editingTaskId) {
    const idx = getTasks().findIndex(t => t.id === state.editingTaskId);
    if (idx >= 0) {
      task.done = getTasks()[idx].done;
      task.createdAt = getTasks()[idx].createdAt;
      state.tasks[state.currentProfile][idx] = task;
    }
    state.editingTaskId = null;
    document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.addTask || '+ Add Task';
  } else {
    if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
    state.tasks[state.currentProfile].unshift(task);
  }

  clearForm();
  saveState();
  renderTasks();
  showToast(i18n[state.lang]?.taskAdded || 'Task added! ‚ú®');
}

function toggleTaskDone(id) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  task.done = !task.done;
  saveState();
  renderTasks();

  if (task.done) {
    showToast(i18n[state.lang]?.taskDone || 'Ma Shaa Allah! ‚úÖ');
  }
}

function editTask(id) {
  const task = getTasks().find(t => t.id === id);
  if (!task) return;
  state.editingTaskId = id;
  document.getElementById('taskTitleInput').value = task.title;
  document.getElementById('taskPriority').value = task.priority;
  document.getElementById('taskDueDate').value = task.dueDate || '';
  document.getElementById('taskCategory').value = task.category;
  document.getElementById('taskTags').value = (task.tags||[]).join(', ');
  document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.editTask || 'Save Edit';
  document.getElementById('taskTitleInput').focus();
  switchTab('tasks');
}

function deleteTask(id) {
  state.tasks[state.currentProfile] = getTasks().filter(t => t.id !== id);
  saveState();
  renderTasks();
  showToast(i18n[state.lang]?.taskDeleted || 'Task deleted');
}

function clearForm() {
  document.getElementById('taskTitleInput').value = '';
  document.getElementById('taskPriority').value = 'low';
  document.getElementById('taskDueDate').value = '';
  document.getElementById('taskCategory').value = 'general';
  document.getElementById('taskTags').value = '';
  state.editingTaskId = null;
  document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.addTask || '+ Add Task';
}

function renderTasks() {
  const container = document.getElementById('taskList');
  let tasks = [...getTasks()];
  const lang = state.lang;
  const t = i18n[lang];

  // Filter
  const search = document.getElementById('searchInput').value.toLowerCase();
  const fPriority = document.getElementById('filterPriority').value;
  const fCategory = document.getElementById('filterCategory').value;
  const fStatus = document.getElementById('filterStatus').value;

  if (search) tasks = tasks.filter(t => t.title.toLowerCase().includes(search) || (t.tags||[]).some(tag=>tag.toLowerCase().includes(search)));
  if (fPriority !== 'all') tasks = tasks.filter(t => t.priority === fPriority);
  if (fCategory !== 'all') tasks = tasks.filter(t => t.category === fCategory);
  if (fStatus === 'active') tasks = tasks.filter(t => !t.done);
  if (fStatus === 'done') tasks = tasks.filter(t => t.done);

  if (tasks.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">üìù</div>
        <h3>${t.emptyTitle}</h3>
        <p>${t.emptyDesc}</p>
      </div>`;
    return;
  }

  container.innerHTML = tasks.map(task => {
    const priorityLabel = t[task.priority] || task.priority;
    const catLabel = t['cat' + task.category.charAt(0).toUpperCase() + task.category.slice(1)] || task.category;
    const dueStr = task.dueDate ? `üìÖ ${task.dueDate}` : '';
    const tagsStr = (task.tags||[]).map(tg => `<span class="task-meta-item">üè∑Ô∏è ${tg}</span>`).join('');

    return `
      <div class="task-item ${task.done?'done':''}" draggable="true" data-id="${task.id}"
        ondragstart="onDragStart(event)" ondragover="onDragOver(event)" ondrop="onDrop(event)">
        <div class="task-priority-indicator ${task.priority}"></div>
        <div class="task-checkbox ${task.done?'checked':''}" onclick="toggleTaskDone('${task.id}')">
          ${task.done ? '‚úì' : ''}
        </div>
        <div class="task-content">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">
            <span class="task-meta-item">${priorityLabel}</span>
            <span class="task-meta-item">${catLabel}</span>
            ${dueStr ? `<span class="task-meta-item">${dueStr}</span>` : ''}
            ${tagsStr}
          </div>
        </div>
        <div class="task-actions">
          <button class="btn btn-sm btn-icon" onclick="editTask('${task.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-icon btn-danger" onclick="deleteTask('${task.id}')" title="Delete">üóëÔ∏è</button>
        </div>
      </div>`;
  }).join('');
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== DRAG & DROP =====
let dragId = null;
function onDragStart(e) {
  dragId = e.currentTarget.dataset.id;
  e.currentTarget.classList.add('dragging');
}
function onDragOver(e) { e.preventDefault(); }
function onDrop(e) {
  e.preventDefault();
  const targetId = e.currentTarget.dataset.id;
  if (!dragId || dragId === targetId) return;
  const tasks = getTasks();
  const fromIdx = tasks.findIndex(t => t.id === dragId);
  const toIdx = tasks.findIndex(t => t.id === targetId);
  if (fromIdx < 0 || toIdx < 0) return;
  const [moved] = tasks.splice(fromIdx, 1);
  tasks.splice(toIdx, 0, moved);
  state.tasks[state.currentProfile] = tasks;
  saveState();
  renderTasks();
  document.querySelectorAll('.task-item').forEach(el => el.classList.remove('dragging'));
  dragId = null;
}

// ===== SECURE NOTES (AES) =====
function unlockNotes() {
  const pass = document.getElementById('notePassphrase').value;
  if (!pass) return;

  const hasNotes = state.notes && state.notes.length > 0;

  // If first time (no notes), require confirmation
  if (!hasNotes) {
    const confirm = document.getElementById('notePassphraseConfirm').value;
    if (!confirm) {
      document.getElementById('passMismatch').textContent = i18n[state.lang]?.enterConfirm || 'Please confirm your passphrase';
      document.getElementById('passMismatch').style.display = 'block';
      return;
    }
    if (pass !== confirm) {
      document.getElementById('passMismatch').textContent = i18n[state.lang]?.passMismatch || "Passphrases don't match";
      document.getElementById('passMismatch').style.display = 'block';
      return;
    }
  }

  // If has notes, verify passphrase can decrypt at least one
  if (hasNotes) {
    try {
      const test = CryptoJS.AES.decrypt(state.notes[0].encrypted, pass);
      const result = test.toString(CryptoJS.enc.Utf8);
      if (!result) throw new Error('Bad passphrase');
      JSON.parse(result); // must be valid JSON
    } catch(e) {
      document.getElementById('passMismatch').style.display = 'block';
      document.getElementById('passMismatch').textContent = i18n[state.lang]?.wrongPassphrase || '‚ùå Wrong passphrase. Cannot decrypt notes.';
      // Show the mismatch element in the unlock section
      if (!document.getElementById('passErrorHint')) {
        const err = document.createElement('small');
        err.id = 'passErrorHint';
        err.style.cssText = 'color:var(--danger);display:block;margin-top:6px;';
        err.textContent = i18n[state.lang]?.wrongPassphrase || '‚ùå Wrong passphrase. Cannot decrypt notes.';
        document.getElementById('notePassphrase').parentElement.after(err);
      }
      return;
    }
  }

  state.notePassphrase = pass;
  document.getElementById('notePasswordSection').style.display = 'none';
  document.getElementById('noteEditorSection').style.display = 'block';
  document.getElementById('passMismatch').style.display = 'none';
  // Clean up error hints
  const errHint = document.getElementById('passErrorHint');
  if (errHint) errHint.remove();
  renderNotes();
}

function togglePasswordVisibility(inputId, btn) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ÿ∫ŸÄ';
  } else {
    input.type = 'password';
    btn.textContent = 'ÿπŸÄ';
  }
}

function lockNotes() {
  state.notePassphrase = null;
  document.getElementById('notePasswordSection').style.display = 'block';
  document.getElementById('noteEditorSection').style.display = 'none';
  document.getElementById('notePassphrase').value = '';
  document.getElementById('notePassphraseConfirm').value = '';
  document.getElementById('notePassphrase').type = 'password';
  document.getElementById('notePassphraseConfirm').type = 'password';
  document.getElementById('passMismatch').style.display = 'none';
  updateNoteCountHint();
}

function addNote() {
  const title = document.getElementById('noteTitleInput').value.trim();
  const content = document.getElementById('noteContentInput').value.trim();
  if (!title || !content || !state.notePassphrase) return;

  const encrypted = CryptoJS.AES.encrypt(JSON.stringify({ title, content }), state.notePassphrase).toString();
  state.notes.push({ id: Date.now().toString(36), encrypted, createdAt: new Date().toISOString() });
  document.getElementById('noteTitleInput').value = '';
  document.getElementById('noteContentInput').value = '';
  saveState();
  renderNotes();
  cancelNewNote();
  showToast(i18n[state.lang]?.noteAdded || 'Note encrypted & saved üîê');
}

function showNewNoteForm() {
  document.getElementById('newNoteForm').style.display = 'block';
  document.getElementById('showNewNoteBtn').style.display = 'none';
  document.getElementById('noteTitleInput').focus();
}

function cancelNewNote() {
  document.getElementById('newNoteForm').style.display = 'none';
  document.getElementById('showNewNoteBtn').style.display = 'block';
  document.getElementById('noteTitleInput').value = '';
  document.getElementById('noteContentInput').value = '';
}

function deleteNote(id) {
  state.notes = state.notes.filter(n => n.id !== id);
  saveState();
  renderNotes();
}

function renderNotes() {
  const container = document.getElementById('notesList');
  if (!state.notePassphrase || !state.notes.length) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üîê</div><p>No notes yet</p></div>';
    return;
  }

  container.innerHTML = state.notes.map(note => {
    try {
      const decrypted = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
      const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
      return `
        <div class="note-item">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <div style="flex:1;min-width:0;">
              <strong>${escapeHtml(data.title)}</strong>
              <p style="color:var(--text-secondary);font-size:0.9em;margin-top:6px;white-space:pre-wrap;">${escapeHtml(data.content)}</p>
              <small style="color:var(--text-secondary);opacity:0.6;">${new Date(note.createdAt).toLocaleDateString()}</small>
            </div>
            <div style="display:flex;gap:4px;flex-shrink:0;">
              <button class="btn btn-sm btn-icon" onclick="speakNote('${note.id}')" title="Listen">üîä</button>
              <button class="btn btn-sm btn-icon btn-danger" onclick="deleteNote('${note.id}')">üóëÔ∏è</button>
            </div>
          </div>
        </div>`;
    } catch(e) {
      return `<div class="note-item"><div class="note-locked">üîí Cannot decrypt (wrong passphrase?)</div></div>`;
    }
  }).join('');
}

// ===== PIN LOCK =====
function togglePinSetting() {
  const toggle = document.getElementById('pinToggle');
  const area = document.getElementById('pinSetupArea');
  state.pinEnabled = !state.pinEnabled;
  toggle.classList.toggle('active', state.pinEnabled);
  area.style.display = state.pinEnabled ? 'block' : 'none';
  if (!state.pinEnabled) { state.pin = ''; }
  saveState();
  updateChangePinBtn();
}

function savePin() {
  const pin = document.getElementById('pinSetInput').value;
  if (pin.length !== 4 || !/^\d{4}$/.test(pin)) return;
  state.pin = CryptoJS.SHA256(pin).toString();
  document.getElementById('pinSetInput').value = '';
  saveState();
  updateChangePinBtn();
  showToast('PIN saved! üîí');
}

function updateChangePinBtn() {
  const btn = document.getElementById('changePinBtn');
  if (state.pin && state.pinEnabled) {
    btn.style.display = 'inline-flex';
  } else {
    btn.style.display = 'none';
  }
}

function showPinLock() {
  document.getElementById('pinOverlay').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
  const digits = document.querySelectorAll('.pin-digit');
  digits.forEach((d, i) => {
    d.value = '';
    d.addEventListener('input', (e) => {
      if (e.target.value && i < 3) digits[i+1].focus();
      if (i === 3 && e.target.value) checkPin();
    });
    d.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !d.value && i > 0) digits[i-1].focus();
    });
  });
  setTimeout(() => digits[0].focus(), 100);
}

function checkPin() {
  const digits = document.querySelectorAll('.pin-digit');
  const entered = [...digits].map(d => d.value).join('');
  if (entered.length !== 4) return;
  const hash = CryptoJS.SHA256(entered).toString();
  if (hash === state.pin) {
    document.getElementById('pinOverlay').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
  } else {
    document.getElementById('pinError').textContent = i18n[state.lang]?.wrongPin || 'Wrong PIN';
    document.getElementById('pinError').style.display = 'block';
    digits.forEach(d => d.value = '');
    digits[0].focus();
  }
}

// ===== IMPORT / EXPORT =====
function exportData() {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    state: { ...state, notePassphrase: null }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tethkir-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(i18n[state.lang]?.dataExported || 'Data exported! üì¶');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.state) {
        state = { ...state, ...data.state, notePassphrase: null };
        saveState();
        applyLang(state.lang);
        setTheme(state.theme);
        renderProfiles();
        renderTasks();
              showToast(i18n[state.lang]?.dataImported || 'Data imported! ‚úÖ');
      }
    } catch(err) { showToast('Invalid file ‚ùå'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

async function manualSync() {
  if (!firebaseReady || !firebaseAuth?.currentUser) {
    showToast(i18n[state.lang]?.syncNotSignedIn || 'Sign in to Firebase first ‚òÅÔ∏è');
    return;
  }
  const t = i18n[state.lang] || i18n.en;
  showToast(t.syncing || 'Syncing...');
  try {
    await syncToCloud();
    await syncFromCloud();
    showToast(t.syncDone || 'Sync complete! ‚úÖ');
  } catch(e) {
    console.error('Manual sync error:', e);
    showToast(t.syncError || 'Sync failed ‚ùå');
  }
}

function clearAllData() {
  const t = i18n[state.lang] || i18n.en;
  const msg = t.clearAllConfirm || 'This will delete ALL your tasks, notes, profiles, and settings. This cannot be undone!\n\nAre you sure?';
  if (!confirm(msg)) return;
  // Sign out of Firebase if connected
  if (firebaseAuth?.currentUser) {
    firebaseAuth.signOut();
  }
  // Clear all localStorage
  localStorage.removeItem('tethkir_state');
  localStorage.removeItem('tethkir_firebase');
  localStorage.removeItem('tethkir_custom_shortcuts');
  // Reload the page to reset everything
  showToast(t.clearAllDone || 'All data cleared! üóëÔ∏è');
  setTimeout(() => location.reload(), 800);
}

// ===== FIREBASE =====
let firebaseReady = false;
let firebaseAuth = null;
let firebaseDb = null;
let syncInProgress = false;

function loadFirebaseSDK() {
  return new Promise((resolve, reject) => {
    if (firebaseReady) { resolve(); return; }
    if (typeof firebase !== 'undefined' && firebase.apps) { resolve(); return; }
    const scripts = [
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js',
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js'
    ];
    let loaded = 0;
    scripts.forEach(src => {
      if (document.querySelector('script[src="' + src + '"]')) {
        loaded++; if (loaded === scripts.length) resolve(); return;
      }
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => { loaded++; if (loaded === scripts.length) resolve(); };
      s.onerror = () => reject(new Error('Failed to load Firebase SDK'));
      document.head.appendChild(s);
    });
  });
}

function initFirebase(config) {
  try {
    if (typeof firebase === 'undefined') return;
    if (firebase.apps && firebase.apps.length) {
      // Already initialized ‚Äî just grab references
      firebaseAuth = firebase.auth();
      firebaseDb = firebase.firestore();
      firebaseReady = true;
      setupAuthListener();
      return;
    }
    firebase.initializeApp(config);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.firestore();
    firebaseReady = true;
    setupAuthListener();
  } catch(e) { console.error('Firebase init error:', e); }
}

function setupAuthListener() {
  // Handle redirect result (for iOS Safari sign-in)
  firebaseAuth.getRedirectResult().then(result => {
    if (result && result.user) {
      showToast('Welcome, ' + result.user.displayName + '! ‚òÅÔ∏è');
    }
  }).catch(e => {
    if (e.code !== 'auth/no-auth-event') {
      console.error('Redirect result error:', e);
    }
  });

  firebaseAuth.onAuthStateChanged(user => {
    if (user) {
      updateSyncUI(true, user.displayName);
      syncFromCloud();
    } else {
      updateSyncUI(false);
    }
  });
}

function updateSyncUI(firebaseOnline, name) {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  const btn = document.getElementById('authBtn');
  const lang = state.lang || 'en';
  const hasInternet = navigator.onLine;

  if (firebaseOnline && hasInternet) {
    dot.className = 'sync-dot online';
    label.textContent = name || (i18n[lang]?.synced || 'Synced');
    btn.textContent = i18n[lang]?.signOut || '‚òÅÔ∏è Sign Out';
  } else if (hasInternet) {
    dot.className = 'sync-dot warning';
    label.textContent = i18n[lang]?.online || 'Online';
    btn.textContent = i18n[lang]?.signIn || '‚òÅÔ∏è Sign In';
  } else {
    dot.className = 'sync-dot offline';
    label.textContent = i18n[lang]?.offline || 'Offline';
    btn.textContent = i18n[lang]?.signIn || '‚òÅÔ∏è Sign In';
  }
}

// Listen for internet connectivity changes
window.addEventListener('online', () => updateSyncUI(firebaseAuth?.currentUser != null, firebaseAuth?.currentUser?.displayName));
window.addEventListener('offline', () => updateSyncUI(false));

async function syncToCloud() {
  if (!firebaseReady || !firebaseAuth?.currentUser) return;
  if (syncInProgress) return;
  syncInProgress = true;
  try {
    const user = firebaseAuth.currentUser;
    await firebaseDb.collection('users').doc(user.uid).set({
      tasks: state.tasks,
      profiles: state.profiles,
      notes: state.notes,
      theme: state.theme,
      lang: state.lang,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log('‚úÖ Synced to cloud');
  } catch(e) {
    console.error('Sync to cloud error:', e);
    showToast('Sync error ‚Äî check console');
  } finally {
    syncInProgress = false;
  }
}

async function syncFromCloud() {
  if (!firebaseReady || !firebaseAuth?.currentUser) return;
  try {
    const user = firebaseAuth.currentUser;
    const doc = await firebaseDb.collection('users').doc(user.uid).get();
    if (doc.exists) {
      const data = doc.data();
      state.tasks = data.tasks || state.tasks;
      state.profiles = data.profiles || state.profiles;
      state.notes = data.notes || state.notes;
      if (data.theme) { state.theme = data.theme; setTheme(data.theme); }
      if (data.lang) { state.lang = data.lang; applyLang(data.lang); }
      if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
      const toSave = { ...state, notePassphrase: null };
      localStorage.setItem('tethkir_state', JSON.stringify(toSave));
      renderProfiles();
      renderTasks();
          updateNoteCountHint();
      showToast('‚òÅÔ∏è Synced from cloud!');
    } else {
      await syncToCloud();
      showToast('‚òÅÔ∏è Data uploaded to cloud!');
    }
  } catch(e) {
    console.error('Sync from cloud error:', e);
    showToast('Cloud fetch error ‚Äî check console');
  }
}

function saveFirebaseConfig() {
  const val = document.getElementById('firebaseConfigInput').value.trim();
  try {
    const config = JSON.parse(val);
    state.firebaseConfig = config;
    localStorage.setItem('tethkir_firebase', val);
    saveState();
    showToast('Firebase config saved! Loading SDK... ‚òÅÔ∏è');
    loadFirebaseSDK().then(() => {
      initFirebase(config);
      showToast('Firebase ready! Click Sign In ‚òÅÔ∏è');
    }).catch(e => {
      showToast('Failed to load Firebase SDK ‚ùå');
      console.error(e);
    });
  } catch(e) { showToast('Invalid JSON ‚ùå'); }
}

function clearFirebaseConfig() {
  if (firebaseAuth?.currentUser) firebaseAuth.signOut();
  state.firebaseConfig = null;
  firebaseReady = false;
  firebaseAuth = null;
  firebaseDb = null;
  localStorage.removeItem('tethkir_firebase');
  document.getElementById('firebaseConfigInput').value = '';
  saveState();
  updateSyncUI(false);
  showToast('Firebase config cleared');
}

function toggleAuth() {
  if (!state.firebaseConfig) {
    showToast('Set Firebase config in Settings first ‚òÅÔ∏è');
    toggleSettingsSidebar();
    return;
  }
  if (!firebaseReady) {
    showToast('Loading Firebase...');
    loadFirebaseSDK().then(() => {
      initFirebase(state.firebaseConfig);
      doSignIn();
    }).catch(() => showToast('Failed to load Firebase SDK ‚ùå'));
    return;
  }
  if (firebaseAuth?.currentUser) {
    firebaseAuth.signOut().then(() => {
      updateSyncUI(false);
      showToast('Signed out ‚òÅÔ∏è');
    });
  } else {
    doSignIn();
  }
}

async function doSignIn() {
  try {
    // Guard: ensure auth module is ready
    if (!firebase.auth || !firebase.auth.GoogleAuthProvider) {
      showToast('Firebase auth not ready ‚Äî try again');
      return;
    }
    const provider = new firebase.auth.GoogleAuthProvider();

    // iOS Safari doesn't support popups well ‚Äî use redirect
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (isIOS || (isSafari && 'ontouchstart' in window)) {
      await firebaseAuth.signInWithRedirect(provider);
    } else {
      const result = await firebaseAuth.signInWithPopup(provider);
      showToast('Welcome, ' + result.user.displayName + '! ‚òÅÔ∏è');
    }
  } catch(e) {
    if (e.code === 'auth/popup-closed-by-user') {
      showToast('Sign-in cancelled');
    } else if (e.code === 'auth/unauthorized-domain') {
      showToast('Add this domain to Firebase Authorized Domains ‚ö†Ô∏è');
    } else {
      console.error('Sign-in error:', e);
      showToast('Sign-in failed: ' + e.message);
    }
  }
}

// ===== TOAST =====
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ===== KEYBOARD SHORTCUT =====
document.getElementById('taskTitleInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') addTask();
});

document.getElementById('notePassphrase').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const hasNotes = state.notes && state.notes.length > 0;
    if (hasNotes) unlockNotes();
    else document.getElementById('notePassphraseConfirm').focus();
  }
});

document.getElementById('notePassphraseConfirm').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') unlockNotes();
});

// ===== HELP WIDGET =====
let helpOpen = false;

function toggleHelp() {
  helpOpen = !helpOpen;
  document.getElementById('helpPanel').classList.toggle('open', helpOpen);
  document.getElementById('helpToggleBtn').classList.toggle('active', helpOpen);
  document.body.classList.toggle('help-open', helpOpen);
  document.getElementById('helpToggleBtn').textContent = helpOpen ? '‚ùì ‚ñæ' : '‚ùì';
}

function toggleAccordion(header) {
  const body = header.nextElementSibling;
  const isOpen = body.classList.contains('open');

  // Close all other accordions (optional ‚Äî remove for multi-open)
  // document.querySelectorAll('.help-accordion-body.open').forEach(b => b.classList.remove('open'));
  // document.querySelectorAll('.help-accordion-header.active').forEach(h => h.classList.remove('active'));

  header.classList.toggle('active', !isOpen);
  body.classList.toggle('open', !isOpen);
}

function toggleSettingsSection(header) {
  const body = header.nextElementSibling;
  const isOpen = body.classList.contains('open');
  header.classList.toggle('open', !isOpen);
  body.classList.toggle('open', !isOpen);
}

function toggleSettingsSidebar() {
  document.getElementById('settingsBackdrop').classList.toggle('open');
  document.getElementById('settingsSidebar').classList.toggle('open');
}

// ===== SIMPLE MODE =====
function toggleSimpleMode() {
  state.simpleMode = !state.simpleMode;
  applySimpleMode();
  saveState();
}

function applySimpleMode() {
  const on = state.simpleMode !== false; // default true
  document.body.classList.toggle('simple-mode', on);
  const toggle = document.getElementById('simpleModeToggle');
  if (toggle) toggle.classList.toggle('active', on);
  // Update notes tab label
  const notesTab = document.querySelector('[data-tab="notes"] span');
  if (notesTab) {
    const t = i18n[state.lang] || i18n.en;
    notesTab.textContent = on ? (t.tabNotesSimple || 'Notes') : (t.tabNotes || 'Secure Notes');
  }
  if (on) renderSimpleNotes();
}

function addSimpleNote() {
  const title = document.getElementById('simpleNoteTitleInput').value.trim();
  const content = document.getElementById('simpleNoteContentInput').value.trim();
  if (!title && !content) { showToast('Write something first!'); return; }
  if (!state.simpleNotes) state.simpleNotes = {};
  if (!state.simpleNotes[state.currentProfile]) state.simpleNotes[state.currentProfile] = [];
  state.simpleNotes[state.currentProfile].push({
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    title: title || 'Untitled',
    content: content,
    created: Date.now()
  });
  document.getElementById('simpleNoteTitleInput').value = '';
  document.getElementById('simpleNoteContentInput').value = '';
  saveState();
  renderSimpleNotes();
  const t = i18n[state.lang] || i18n.en;
  showToast(t.noteSaved || 'Note saved! ‚úÖ');
}

function renderSimpleNotes() {
  const container = document.getElementById('simpleNotesList');
  if (!container) return;
  const notes = (state.simpleNotes && state.simpleNotes[state.currentProfile]) || [];
  if (notes.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px 10px;color:var(--text-secondary);"><div style="font-size:2em;margin-bottom:8px;">üìù</div><p data-i18n="noNotesYet"><b>No notes yet!</b></p></div>';
    return;
  }
  container.innerHTML = notes.map(n => `
    <div class="simple-note-card">
      <h4>${n.title}</h4>
      <p>${n.content}</p>
      <div class="simple-note-actions">
        <button class="btn btn-sm" onclick="speakSimpleNote('${n.id}')" title="Read aloud">üîä</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSimpleNote('${n.id}')" title="Delete">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function deleteSimpleNote(id) {
  if (!state.simpleNotes || !state.simpleNotes[state.currentProfile]) return;
  state.simpleNotes[state.currentProfile] = state.simpleNotes[state.currentProfile].filter(n => n.id !== id);
  saveState();
  renderSimpleNotes();
}

function speakSimpleNote(id) {
  const notes = (state.simpleNotes && state.simpleNotes[state.currentProfile]) || [];
  const note = notes.find(n => n.id === id);
  if (!note) return;
  if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); return; }
  const text = note.title + '. ' + note.content;
  const utter = new SpeechSynthesisUtterance(text);
  const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
  utter.lang = langMap[state.lang] || 'en-US';
  window.speechSynthesis.speak(utter);
}

function filterHelp() {
  const query = document.getElementById('helpSearch').value.toLowerCase().trim();
  const items = document.querySelectorAll('.help-accordion, .help-tip-card');

  items.forEach(item => {
    if (!query) {
      item.style.display = '';
      return;
    }
    const keywords = (item.dataset.helpKeywords || '').toLowerCase();
    const text = item.textContent.toLowerCase();
    const match = keywords.includes(query) || text.includes(query);
    item.style.display = match ? '' : 'none';
  });

  // Show/hide section labels based on visible children
  document.querySelectorAll('.help-section-label').forEach(label => {
    if (!query) { label.style.display = ''; return; }
    let next = label.nextElementSibling;
    let hasVisible = false;
    while (next && !next.classList.contains('help-section-label')) {
      if (next.style.display !== 'none') hasVisible = true;
      next = next.nextElementSibling;
    }
    label.style.display = hasVisible ? '' : 'none';
  });
}

// ===== CHANGE PASSPHRASE =====
function showChangePassphraseModal() {
  const t = i18n[state.lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>üîë ${t.changePassphrase || 'Change Passphrase'}</h2>
    <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:16px;">${t.changePassDesc || 'All notes will be re-encrypted with the new passphrase.'}</p>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.currentPassphrase || 'Current Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpOldPass" placeholder="${t.passphrasePlaceholder || 'Enter current passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpOldPass', this)">ÿπŸÄ</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.newPassphrase || 'New Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpNewPass" placeholder="${t.newPassPlaceholder || 'Enter new passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpNewPass', this)">ÿπŸÄ</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.confirmNewPassphrase || 'Confirm New Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpConfirmPass" placeholder="${t.confirmPassphrasePlaceholder || 'Re-enter new passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpConfirmPass', this)">ÿπŸÄ</button>
      </div>
    </div>
    <p id="cpError" style="color:var(--danger);font-size:0.85em;display:none;margin-bottom:10px;"></p>
    <div class="form-actions">
      <button class="btn" onclick="closeModal()">${t.cancel || 'Cancel'}</button>
      <button class="btn btn-accent" onclick="changePassphrase()">üîê ${t.confirmChange || 'Change & Re-encrypt'}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function changePassphrase() {
  const t = i18n[state.lang];
  const oldPass = document.getElementById('cpOldPass').value;
  const newPass = document.getElementById('cpNewPass').value;
  const confirmPass = document.getElementById('cpConfirmPass').value;
  const errEl = document.getElementById('cpError');

  // Validate current passphrase
  if (!oldPass) {
    errEl.textContent = t.enterCurrent || 'Enter your current passphrase';
    errEl.style.display = 'block';
    return;
  }

  // Verify old passphrase can decrypt
  if (state.notes.length > 0) {
    try {
      const test = CryptoJS.AES.decrypt(state.notes[0].encrypted, oldPass);
      const result = test.toString(CryptoJS.enc.Utf8);
      if (!result) throw new Error();
      JSON.parse(result);
    } catch(e) {
      errEl.textContent = t.wrongPassphrase || '‚ùå Current passphrase is wrong';
      errEl.style.display = 'block';
      return;
    }
  }

  // Validate new passphrase
  if (!newPass) {
    errEl.textContent = t.enterNew || 'Enter a new passphrase';
    errEl.style.display = 'block';
    return;
  }

  if (newPass.length < 3) {
    errEl.textContent = t.passTooShort || 'Passphrase must be at least 3 characters';
    errEl.style.display = 'block';
    return;
  }

  if (newPass !== confirmPass) {
    errEl.textContent = t.passMismatch || "Passphrases don't match";
    errEl.style.display = 'block';
    return;
  }

  if (oldPass === newPass) {
    errEl.textContent = t.passSameAsOld || 'New passphrase must be different from current';
    errEl.style.display = 'block';
    return;
  }

  // Re-encrypt all notes
  try {
    const reEncrypted = state.notes.map(note => {
      const decrypted = CryptoJS.AES.decrypt(note.encrypted, oldPass);
      const data = decrypted.toString(CryptoJS.enc.Utf8);
      JSON.parse(data); // validate
      const newEncrypted = CryptoJS.AES.encrypt(data, newPass).toString();
      return { ...note, encrypted: newEncrypted };
    });

    state.notes = reEncrypted;
    state.notePassphrase = newPass;
    saveState();
    renderNotes();
    closeModal();
    showToast(t.passChanged || 'Passphrase changed! All notes re-encrypted üîê');
  } catch(e) {
    errEl.textContent = t.reEncryptError || '‚ùå Error re-encrypting. Some notes may use a different passphrase.';
    errEl.style.display = 'block';
  }
}

// ===== CHANGE PIN =====
function showChangePinModal() {
  const t = i18n[state.lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>üîë ${t.changePin || 'Change PIN'}</h2>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.currentPin || 'Current PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpOldPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpOldPin', this)">ÿπŸÄ</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.newPin || 'New PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpNewPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpNewPin', this)">ÿπŸÄ</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.confirmNewPin || 'Confirm New PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpConfirmPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpConfirmPin', this)">ÿπŸÄ</button>
      </div>
    </div>
    <p id="cpPinError" style="color:var(--danger);font-size:0.85em;display:none;margin-bottom:10px;"></p>
    <div class="form-actions">
      <button class="btn" onclick="closeModal()">${t.cancel || 'Cancel'}</button>
      <button class="btn btn-accent" onclick="changePin()">üîí ${t.confirmPinChange || 'Change PIN'}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function changePin() {
  const t = i18n[state.lang];
  const oldPin = document.getElementById('cpOldPin').value;
  const newPin = document.getElementById('cpNewPin').value;
  const confirmPin = document.getElementById('cpConfirmPin').value;
  const errEl = document.getElementById('cpPinError');

  if (!oldPin || oldPin.length !== 4 || !/^\d{4}$/.test(oldPin)) {
    errEl.textContent = t.enterValidPin || 'Enter your current 4-digit PIN';
    errEl.style.display = 'block';
    return;
  }

  // Verify old PIN
  if (CryptoJS.SHA256(oldPin).toString() !== state.pin) {
    errEl.textContent = t.wrongPin || 'Current PIN is wrong';
    errEl.style.display = 'block';
    return;
  }

  if (!newPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
    errEl.textContent = t.enterNewPin || 'Enter a new 4-digit PIN';
    errEl.style.display = 'block';
    return;
  }

  if (newPin !== confirmPin) {
    errEl.textContent = t.pinMismatch || "PINs don't match";
    errEl.style.display = 'block';
    return;
  }

  if (oldPin === newPin) {
    errEl.textContent = t.pinSameAsOld || 'New PIN must be different from current';
    errEl.style.display = 'block';
    return;
  }

  state.pin = CryptoJS.SHA256(newPin).toString();
  saveState();
  closeModal();
  showToast(t.pinChanged || 'PIN changed! üîí');
}

// ===== ISLAMIC SHORTCUTS DRAWER =====
const builtInPhrases = [
  { arabic: 'ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê', translit: 'Bismillah ir-Rahman ir-Raheem', meaning: { en: 'In the name of Allah, the Most Gracious, the Most Merciful', fr: 'Au nom d\'Allah, le Tout Mis√©ricordieux, le Tr√®s Mis√©ricordieux', ar: 'ÿ®ÿßÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ' }, builtin: true },
  { arabic: 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá', translit: 'Alhamdulillah', meaning: { en: 'Praise be to Allah', fr: 'Louange √† Allah', ar: 'ÿßŸÑÿ´ŸÜÿßÿ° ŸÑŸÑŸá' }, builtin: true },
  { arabic: 'ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá', translit: 'SubhanAllah', meaning: { en: 'Glory to Allah', fr: 'Gloire √† Allah', ar: 'ÿ™ŸÜÿ≤ŸäŸá ÿßŸÑŸÑŸá' }, builtin: true },
  { arabic: 'ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±', translit: 'Allahu Akbar', meaning: { en: 'Allah is the Greatest', fr: 'Allah est le Plus Grand', ar: 'ÿßŸÑŸÑŸá ŸáŸà ÿßŸÑÿ£ŸÉÿ®ÿ±' }, builtin: true },
  { arabic: 'ÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá', translit: 'In Shaa Allah', meaning: { en: 'If Allah wills', fr: 'Si Allah le veut', ar: 'ÿ®ŸÖÿ¥Ÿäÿ¶ÿ© ÿßŸÑŸÑŸá' }, builtin: true },
  { arabic: 'ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá', translit: 'Ma Shaa Allah', meaning: { en: 'What Allah has willed', fr: 'Ce qu\'Allah a voulu', ar: 'ŸÖÿß ÿ£ÿ±ÿßÿØŸá ÿßŸÑŸÑŸá' }, builtin: true },
  { arabic: 'ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá ÿÆŸäÿ±ÿßŸã', translit: 'JazakAllahu Khairan', meaning: { en: 'May Allah reward you with good', fr: 'Qu\'Allah vous r√©compense', ar: 'ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿ¨ÿ≤ÿßÿ°' }, builtin: true },
  { arabic: 'ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ', translit: 'Assalamu Alaikum', meaning: { en: 'Peace be upon you', fr: 'La paix soit sur vous', ar: 'ÿ™ÿ≠Ÿäÿ© ÿßŸÑÿ≥ŸÑÿßŸÖ' }, builtin: true },
  { arabic: 'ŸàÿπŸÑŸäŸÉŸÖ ÿßŸÑÿ≥ŸÑÿßŸÖ', translit: 'Wa Alaikum Assalam', meaning: { en: 'And upon you peace', fr: 'Et sur vous la paix', ar: 'ÿ±ÿØ ÿ™ÿ≠Ÿäÿ© ÿßŸÑÿ≥ŸÑÿßŸÖ' }, builtin: true },
  { arabic: 'ÿµŸÑŸâ ÿßŸÑŸÑŸá ÿπŸÑŸäŸá Ÿàÿ≥ŸÑŸÖ', translit: 'Sallallahu Alaihi Wasallam', meaning: { en: 'Peace and blessings be upon him', fr: 'Paix et b√©n√©dictions sur lui', ar: 'ÿßŸÑÿµŸÑÿßÿ© ŸàÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸâ ÿßŸÑŸÜÿ®Ÿä' }, builtin: true },
  { arabic: 'ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá', translit: 'Astaghfirullah', meaning: { en: 'I seek Allah\'s forgiveness', fr: 'Je demande pardon √† Allah', ar: 'ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ∫ŸÅÿ±ÿ© ŸÖŸÜ ÿßŸÑŸÑŸá' }, builtin: true },
  { arabic: 'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá', translit: 'La ilaha illAllah', meaning: { en: 'There is no god but Allah', fr: 'Il n\'y a de dieu qu\'Allah', ar: 'ÿ¥ŸáÿßÿØÿ© ÿßŸÑÿ™Ÿàÿ≠ŸäÿØ' }, builtin: true },
  { arabic: 'ÿ®ÿßÿ±ŸÉ ÿßŸÑŸÑŸá ŸÅŸäŸÉ', translit: 'Barakallahu Fik', meaning: { en: 'May Allah bless you', fr: 'Qu\'Allah vous b√©nisse', ar: 'ÿØÿπÿßÿ° ÿ®ÿßŸÑÿ®ÿ±ŸÉÿ©' }, builtin: true },
  { arabic: 'ÿ≠ÿ≥ÿ®ŸÜÿß ÿßŸÑŸÑŸá ŸàŸÜÿπŸÖ ÿßŸÑŸàŸÉŸäŸÑ', translit: 'Hasbunallahu wa ni\'mal Wakeel', meaning: { en: 'Allah is sufficient for us and the best Disposer of affairs', fr: 'Allah nous suffit, Il est le meilleur Garant', ar: 'ÿßŸÑÿ™ŸàŸÉŸÑ ÿπŸÑŸâ ÿßŸÑŸÑŸá' }, builtin: true },
];

let shortcutsDrawerOpen = false;
let customFormOpen = false;

function getCustomShortcuts() {
  try {
    return JSON.parse(localStorage.getItem('tethkir_custom_shortcuts') || '[]');
  } catch(e) { return []; }
}

function saveCustomShortcuts(list) {
  localStorage.setItem('tethkir_custom_shortcuts', JSON.stringify(list));
}

function toggleShortcutsDrawer() {
  shortcutsDrawerOpen = !shortcutsDrawerOpen;
  document.getElementById('shortcutsDrawer').classList.toggle('open', shortcutsDrawerOpen);
  document.getElementById('shortcutsBackdrop').classList.toggle('open', shortcutsDrawerOpen);
  if (shortcutsDrawerOpen) renderShortcuts();
}

function toggleCustomForm() {
  customFormOpen = !customFormOpen;
  document.getElementById('customShortcutForm').classList.toggle('open', customFormOpen);
  if (customFormOpen) document.getElementById('scArabicInput').focus();
}

function saveCustomShortcut() {
  const arabic = document.getElementById('scArabicInput').value.trim();
  const translit = document.getElementById('scTranslitInput').value.trim();
  const meaning = document.getElementById('scMeaningInput').value.trim();
  if (!arabic) return;

  const customs = getCustomShortcuts();
  customs.push({
    id: Date.now().toString(36),
    arabic,
    translit: translit || '',
    meaning: { en: meaning || '', fr: meaning || '', ar: meaning || '' },
    builtin: false
  });
  saveCustomShortcuts(customs);

  // Clear form
  document.getElementById('scArabicInput').value = '';
  document.getElementById('scTranslitInput').value = '';
  document.getElementById('scMeaningInput').value = '';
  toggleCustomForm();
  renderShortcuts();
  showToast(i18n[state.lang]?.scSaved || 'Custom phrase saved! ü§≤');
}

function deleteCustomShortcut(id) {
  const customs = getCustomShortcuts().filter(c => c.id !== id);
  saveCustomShortcuts(customs);
  renderShortcuts();
  showToast(i18n[state.lang]?.scDeleted || 'Phrase deleted');
}

function insertPhrase(arabic) {
  // Add space separator if preview already has text
  if (kbPreviewText.length > 0 && !kbPreviewText.endsWith(' ')) {
    kbPreviewText += ' ';
  }
  kbPreviewText += arabic;
  updateKbPreview();
  showToast(i18n[state.lang]?.scInserted || 'Phrase added to preview ‚úÖ');
}

function renderShortcuts() {
  const container = document.getElementById('shortcutsList');
  const lang = state.lang;
  const customs = getCustomShortcuts();

  let html = '';

  // Custom phrases first
  if (customs.length > 0) {
    html += `<div class="shortcuts-divider" data-i18n="scCustomLabel">${i18n[lang]?.scCustomLabel || '‚úèÔ∏è YOUR CUSTOM PHRASES'}</div>`;
    customs.forEach(p => {
      const meaningText = typeof p.meaning === 'object' ? (p.meaning[lang] || p.meaning.en || '') : (p.meaning || '');
      html += buildPhraseCard(p.arabic, p.translit, meaningText, p.id, false);
    });
  }

  // Built-in phrases
  html += `<div class="shortcuts-divider" data-i18n="scBuiltinLabel">${i18n[lang]?.scBuiltinLabel || 'ü§≤ ISLAMIC PHRASES'}</div>`;
  builtInPhrases.forEach(p => {
    const meaningText = p.meaning[lang] || p.meaning.en;
    html += buildPhraseCard(p.arabic, p.translit, meaningText, null, true);
  });

  container.innerHTML = html;
}

function buildPhraseCard(arabic, translit, meaning, id, isBuiltin) {
  const lang = state.lang;
  const deleteBtn = !isBuiltin ? `<button class="phrase-delete-btn visible" onclick="event.stopPropagation();deleteCustomShortcut('${id}')" title="Delete">üóëÔ∏è</button>` : '';
  const insertHint = i18n[lang]?.scTapToInsert || 'Tap to add to preview';

  return `
    <div class="phrase-card" onclick="insertPhrase('${arabic.replace(/'/g, "\\'")}')">
      <div class="phrase-arabic">${arabic}</div>
      ${translit ? `<div class="phrase-translit">${translit}</div>` : ''}
      ${meaning ? `<div class="phrase-meaning">${meaning}</div>` : ''}
      <div class="phrase-card-footer">
        <span class="phrase-insert-hint">‚ûú ${insertHint}</span>
        ${deleteBtn}
      </div>
    </div>`;
}

// ===== ARABIC VIRTUAL KEYBOARD =====
let kbOpen = false;
let kbPreviewText = '';
let lastFocusedInput = null;

// Track last focused input field (but not the keyboard preview)
document.addEventListener('focusin', (e) => {
  if (e.target.matches('input[type="text"], input[type="password"], textarea') && e.target.id !== 'kbPreview') {
    lastFocusedInput = e.target;
  }
});

function toggleKeyboard() {
  kbOpen = !kbOpen;
  document.getElementById('arabicKeyboard').classList.toggle('open', kbOpen);
  document.getElementById('kbToggleBtn').classList.toggle('active', kbOpen);
  document.body.classList.toggle('kb-open', kbOpen);
  document.getElementById('kbToggleBtn').textContent = kbOpen ? '‚å®Ô∏è ‚ñæ' : '‚å®Ô∏è';
}

function kbTypeChar(char) {
  const preview = document.getElementById('kbPreview');
  const start = preview.selectionStart || kbPreviewText.length;
  const end = preview.selectionEnd || kbPreviewText.length;
  kbPreviewText = kbPreviewText.slice(0, start) + char + kbPreviewText.slice(end);
  preview.value = kbPreviewText;
  preview.selectionStart = preview.selectionEnd = start + char.length;
}

function kbBackspace() {
  const preview = document.getElementById('kbPreview');
  const start = preview.selectionStart || kbPreviewText.length;
  const end = preview.selectionEnd || kbPreviewText.length;
  if (start === end && start > 0) {
    kbPreviewText = kbPreviewText.slice(0, start - 1) + kbPreviewText.slice(end);
    preview.value = kbPreviewText;
    preview.selectionStart = preview.selectionEnd = start - 1;
  } else if (start !== end) {
    kbPreviewText = kbPreviewText.slice(0, start) + kbPreviewText.slice(end);
    preview.value = kbPreviewText;
    preview.selectionStart = preview.selectionEnd = start;
  }
}

function kbEnter() {
  kbPasteToField();
}

function updateKbPreview() {
  document.getElementById('kbPreview').value = kbPreviewText || '';
}

function kbCopyPreview() {
  kbPreviewText = document.getElementById('kbPreview').value;
  if (!kbPreviewText) {
    showToast(i18n[state.lang]?.kbNothingToCopy || 'Nothing to copy');
    return;
  }
  // Select the text in preview for visual feedback
  const preview = document.getElementById('kbPreview');
  preview.select();
  // Try modern clipboard API, then fallback
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(kbPreviewText).then(() => {
      showToast(i18n[state.lang]?.kbCopied || 'Copied to clipboard!');
    }).catch(() => { kbCopyFallback(); });
  } else {
    kbCopyFallback();
  }
}

function kbCopyFallback() {
  try {
    document.execCommand('copy');
    showToast(i18n[state.lang]?.kbCopied || 'Copied to clipboard!');
  } catch(e) {
    showToast(i18n[state.lang]?.kbCopyFail || 'Select text in preview and use Ctrl+C');
  }
}

function kbPasteToField() {
  kbPreviewText = document.getElementById('kbPreview').value;
  if (!kbPreviewText) {
    showToast(i18n[state.lang]?.kbNothingToPaste || 'Nothing to paste ‚Äî type something first');
    return;
  }
  if (!lastFocusedInput) {
    showToast(i18n[state.lang]?.kbNoField || 'Click on an input field first');
    return;
  }
  const input = lastFocusedInput;
  const start = input.selectionStart || input.value.length;
  const end = input.selectionEnd || input.value.length;
  const val = input.value;
  input.value = val.slice(0, start) + kbPreviewText + val.slice(end);
  input.selectionStart = input.selectionEnd = start + kbPreviewText.length;
  input.focus();
  input.dispatchEvent(new Event('input', { bubbles: true }));
  kbPreviewText = '';
  document.getElementById('kbPreview').value = '';
  showToast(i18n[state.lang]?.kbPasted || 'Inserted into field');
}

function kbClearPreview() {
  kbPreviewText = '';
  document.getElementById('kbPreview').value = '';
}

// Attach keyboard key events
document.getElementById('arabicKeyboard').addEventListener('click', (e) => {
  const key = e.target.closest('.kb-key');
  if (!key) return;

  // Visual feedback
  key.classList.add('pressed');
  setTimeout(() => key.classList.remove('pressed'), 150);

  const action = key.dataset.action;
  const char = key.dataset.char;

  if (action === 'backspace') {
    kbBackspace();
  } else if (action === 'enter') {
    kbEnter();
  } else if (char) {
    kbTypeChar(char);
  }
});

// Prevent keyboard clicks from stealing focus from inputs (but allow preview input)
document.getElementById('arabicKeyboard').addEventListener('mousedown', (e) => {
  if (e.target.closest('.kb-key') || e.target.closest('.kb-tool-btn')) {
    e.preventDefault();
  }
});

// ===== UPDATE NOTE COUNT HINT ON LOAD =====
function updateNoteCountHint() {
  const hint = document.getElementById('noteCountHint');
  const confirmGroup = document.getElementById('confirmPassGroup');
  const unlockBtn = document.getElementById('unlockBtn');
  const hasNotes = state.notes && state.notes.length > 0;

  if (hasNotes) {
    const count = state.notes.length;
    const msgs = {
      en: `üîí You have ${count} encrypted note${count > 1 ? 's' : ''} saved. Enter your passphrase to view.`,
      fr: `üîí Vous avez ${count} note${count > 1 ? 's' : ''} chiffr√©e${count > 1 ? 's' : ''} sauvegard√©e${count > 1 ? 's' : ''}. Entrez votre mot de passe.`,
      ar: `üîí ŸÑÿØŸäŸÉ ${count} ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖÿ¥ŸÅÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©. ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂Ÿáÿß.`
    };
    hint.textContent = msgs[state.lang] || msgs.en;
    hint.style.display = 'block';
    confirmGroup.style.display = 'none';
    unlockBtn.textContent = i18n[state.lang]?.unlock || 'üîì Unlock';
  } else {
    hint.style.display = 'none';
    confirmGroup.style.display = 'block';
    const setLabels = { en: 'üîê Set Passphrase & Start', fr: 'üîê D√©finir & Commencer', ar: 'üîê ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±' };
    unlockBtn.textContent = setLabels[state.lang] || setLabels.en;
  }
}

// ===== TEXT-TO-SPEECH (Read Note Aloud) =====
let ttsUtterance = null;

function speakNote(noteId) {
  // If already speaking, stop
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    // If same note, just stop
    if (ttsUtterance && ttsUtterance._noteId === noteId) {
      ttsUtterance = null;
      return;
    }
  }

  const note = state.notes.find(n => n.id === noteId);
  if (!note || !state.notePassphrase) return;

  try {
    const decrypted = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
    const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    const text = data.title + '. ' + data.content;

    const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langMap[state.lang] || 'en-US';
    utterance.rate = 0.95;
    utterance._noteId = noteId;
    ttsUtterance = utterance;

    utterance.onend = () => { ttsUtterance = null; };
    utterance.onerror = () => { ttsUtterance = null; };

    speechSynthesis.speak(utterance);
  } catch(e) {
    showToast('Cannot read note ‚Äî wrong passphrase?');
  }
}

// ===== SPEECH-TO-TEXT =====
let sttRecognition = null;
let sttActiveBtn = null;

function toggleSTT(inputId, btn) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    showToast('Speech recognition not supported in this browser');
    return;
  }

  // If already listening on this button, stop
  if (sttActiveBtn === btn && sttRecognition) {
    sttRecognition.stop();
    return;
  }

  // If listening on another button, stop that first
  if (sttRecognition) {
    sttRecognition.stop();
  }

  const input = document.getElementById(inputId);
  const recognition = new SR();

  // Map app language to speech lang
  const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
  recognition.lang = langMap[state.lang] || 'en-US';
  recognition.continuous = false;
  recognition.interimResults = true;

  let finalText = '';

  recognition.onstart = () => {
    btn.classList.add('listening');
    sttActiveBtn = btn;
    sttRecognition = recognition;
  };

  recognition.onresult = (e) => {
    let interim = '';
    finalText = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        finalText += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Append to existing content
    const existing = input.dataset.sttBase || '';
    if (input.tagName === 'TEXTAREA') {
      input.value = existing + (existing ? ' ' : '') + (finalText || interim);
    } else {
      input.value = existing + (existing ? ' ' : '') + (finalText || interim);
    }
  };

  recognition.onend = () => {
    btn.classList.remove('listening');
    sttActiveBtn = null;
    sttRecognition = null;
    delete input.dataset.sttBase;
    input.focus();
  };

  recognition.onerror = (e) => {
    btn.classList.remove('listening');
    sttActiveBtn = null;
    sttRecognition = null;
    delete input.dataset.sttBase;
    if (e.error === 'not-allowed') {
      showToast('Microphone access denied ‚Äî check browser permissions');
    } else if (e.error !== 'aborted') {
      showToast('Speech error: ' + e.error);
    }
  };

  // Save current input value as base to append to
  input.dataset.sttBase = input.value;
  recognition.start();
}

// ===== START =====
init();
updateNoteCountHint();
</script>
</body>
</html>
