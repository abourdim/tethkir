<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tethkir â€” Task Memo v4.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Reem+Kufi:wght@400;500;600;700&family=Scheherazade+New:wght@400;700&family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style>
/* ===== CSS VARIABLES / THEME SYSTEM ===== */
:root {
  /* Default: Alhambra */
  --bg-primary: #1a0f0a;
  --bg-secondary: #2d1810;
  --bg-card: #3a2218;
  --bg-input: #4a3020;
  --text-primary: #f5e6d3;
  --text-secondary: #c4a882;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #f39c12;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
  --border: rgba(212,160,74,0.2);
  --shadow: rgba(0,0,0,0.4);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.4);
  --pattern-opacity: 0.06;
  --font-body: 'Poppins', sans-serif;
  --font-arabic: 'Amiri', 'Scheherazade New', serif;
  --font-display: 'Playfair Display', serif;
  --radius: 12px;
  --radius-lg: 20px;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== THEME: ALHAMBRA / ANDALUSIAN ===== */
[data-theme="alhambra"] {
  --bg-primary: #1a0f0a;
  --bg-secondary: #2d1810;
  --bg-card: #3a2218;
  --bg-input: #4a3020;
  --text-primary: #f5e6d3;
  --text-secondary: #c4a882;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --border: rgba(212,160,74,0.2);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.5);
  --pattern-opacity: 0.06;
}

/* ===== THEME: OTTOMAN ===== */
[data-theme="ottoman"] {
  --bg-primary: #0a1628;
  --bg-secondary: #122040;
  --bg-card: #1a2d54;
  --bg-input: #233a66;
  --text-primary: #e8e4df;
  --text-secondary: #8bacc4;
  --accent: #c9a84c;
  --accent-hover: #dbb960;
  --accent-glow: rgba(201,168,76,0.3);
  --border: rgba(201,168,76,0.2);
  --bismillah-color: #c9a84c;
  --bismillah-glow: rgba(201,168,76,0.5);
  --pattern-opacity: 0.08;
}

/* ===== THEME: MOROCCAN ZELLIGE ===== */
[data-theme="moroccan"] {
  --bg-primary: #0a1a12;
  --bg-secondary: #12291c;
  --bg-card: #1a3828;
  --bg-input: #224832;
  --text-primary: #f0ece4;
  --text-secondary: #8cc4a0;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.3);
  --border: rgba(140,196,160,0.2);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.5);
  --pattern-opacity: 0.08;
}

/* ===== THEME: CALLIGRAPHY ===== */
[data-theme="calligraphy"] {
  --bg-primary: #f5f0e8;
  --bg-secondary: #ebe4d6;
  --bg-card: #fff9f0;
  --bg-input: #f0e8d8;
  --text-primary: #1a1408;
  --text-secondary: #5a4e3a;
  --accent: #8b6914;
  --accent-hover: #a07c1c;
  --accent-glow: rgba(139,105,20,0.2);
  --border: rgba(139,105,20,0.2);
  --bismillah-color: #2a1e0a;
  --bismillah-glow: rgba(42,30,10,0.15);
  --pattern-opacity: 0.04;
}

/* ===== THEME: RAMADAN NIGHT ===== */
[data-theme="ramadan"] {
  --bg-primary: #0a0a1e;
  --bg-secondary: #12122e;
  --bg-card: #1a1a3e;
  --bg-input: #24244e;
  --text-primary: #e8e4f0;
  --text-secondary: #9a8ec4;
  --accent: #d4a04a;
  --accent-hover: #e8b85c;
  --accent-glow: rgba(212,160,74,0.4);
  --border: rgba(212,160,74,0.15);
  --bismillah-color: #d4a04a;
  --bismillah-glow: rgba(212,160,74,0.6);
  --pattern-opacity: 0.05;
}

/* ===== THEME: DESERT OASIS ===== */
[data-theme="desert"] {
  --bg-primary: #f8f0e0;
  --bg-secondary: #efe4cc;
  --bg-card: #fff8ec;
  --bg-input: #f0e4d0;
  --text-primary: #2a2218;
  --text-secondary: #6a5e4a;
  --accent: #2e8b57;
  --accent-hover: #3aa06a;
  --accent-glow: rgba(46,139,87,0.2);
  --border: rgba(46,139,87,0.2);
  --bismillah-color: #8b6914;
  --bismillah-glow: rgba(139,105,20,0.2);
  --pattern-opacity: 0.04;
}

/* ===== THEME: ISLAMIC GARDEN (LIGHT) ===== */
[data-theme="garden"] {
  --bg-primary: #f0f7f2;
  --bg-secondary: #e2efe6;
  --bg-card: #f8fcf9;
  --bg-input: #e8f3ec;
  --text-primary: #1a2e22;
  --text-secondary: #4a6b55;
  --accent: #2d8659;
  --accent-hover: #38a06d;
  --accent-glow: rgba(45,134,89,0.2);
  --border: rgba(45,134,89,0.18);
  --bismillah-color: #2d6b45;
  --bismillah-glow: rgba(45,107,69,0.15);
  --pattern-opacity: 0.03;
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #e67e22;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
}

/* ===== THEME: GOLDEN AGE / SCIENCE (LIGHT) ===== */
[data-theme="goldenage"] {
  --bg-primary: #faf6ee;
  --bg-secondary: #f0eadc;
  --bg-card: #fffcf5;
  --bg-input: #f2ebdb;
  --text-primary: #2a2418;
  --text-secondary: #6b5f4a;
  --accent: #b8860b;
  --accent-hover: #d4a017;
  --accent-glow: rgba(184,134,11,0.2);
  --border: rgba(184,134,11,0.18);
  --bismillah-color: #8b6914;
  --bismillah-glow: rgba(139,105,20,0.15);
  --pattern-opacity: 0.03;
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #e67e22;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
}

/* ===== THEME: MADRASA / SCHOLAR (LIGHT BLUE) ===== */
[data-theme="madrasa"] {
  --bg-primary: #f0f4f8;
  --bg-secondary: #e1e8ef;
  --bg-card: #f8fafb;
  --bg-input: #e6ecf2;
  --text-primary: #1a2636;
  --text-secondary: #4a6280;
  --accent: #2c6faa;
  --accent-hover: #3884c4;
  --accent-glow: rgba(44,111,170,0.2);
  --border: rgba(44,111,170,0.18);
  --bismillah-color: #2c5f8a;
  --bismillah-glow: rgba(44,95,138,0.15);
  --pattern-opacity: 0.03;
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #e67e22;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
}

/* ===== THEME: PEARL / MINIMALIST LIGHT ===== */
[data-theme="pearl"] {
  --bg-primary: #f9f6f2;
  --bg-secondary: #f0ebe4;
  --bg-card: #fffdf9;
  --bg-input: #f0ebe4;
  --text-primary: #2c2520;
  --text-secondary: #7a6e62;
  --accent: #9c7a4f;
  --accent-hover: #b08c5c;
  --accent-glow: rgba(156,122,79,0.2);
  --border: rgba(156,122,79,0.18);
  --bismillah-color: #8a6f48;
  --bismillah-glow: rgba(138,111,72,0.15);
  --pattern-opacity: 0.025;
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #e67e22;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
}

/* ===== THEME: NOOR / LIGHT ===== */
[data-theme="noor"] {
  --bg-primary: #fefefe;
  --bg-secondary: #f4f2ef;
  --bg-card: #ffffff;
  --bg-input: #f0eee9;
  --text-primary: #222222;
  --text-secondary: #6e6e6e;
  --accent: #6a5acd;
  --accent-hover: #7b6dd8;
  --accent-glow: rgba(106,90,205,0.18);
  --border: rgba(106,90,205,0.15);
  --bismillah-color: #6a5acd;
  --bismillah-glow: rgba(106,90,205,0.12);
  --pattern-opacity: 0.02;
  --danger: #c0392b;
  --success: #27ae60;
  --warning: #e67e22;
  --priority-high: #e74c3c;
  --priority-med: #f39c12;
  --priority-low: #27ae60;
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
  overflow-x: hidden;
}

/* ===== GEOMETRIC PATTERN OVERLAY ===== */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 40px, var(--accent) 40px, var(--accent) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, var(--accent) 40px, var(--accent) 41px),
    repeating-linear-gradient(45deg, transparent, transparent 28px, var(--accent) 28px, var(--accent) 29px),
    repeating-linear-gradient(-45deg, transparent, transparent 28px, var(--accent) 28px, var(--accent) 29px);
  opacity: var(--pattern-opacity);
  pointer-events: none;
  z-index: 0;
}

/* ===== STARS for Ramadan theme ===== */
[data-theme="ramadan"] body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: 
    radial-gradient(1px 1px at 10% 15%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 25% 35%, rgba(212,160,74,0.6), transparent),
    radial-gradient(1px 1px at 40% 10%, rgba(212,160,74,0.7), transparent),
    radial-gradient(2px 2px at 55% 45%, rgba(212,160,74,0.5), transparent),
    radial-gradient(1px 1px at 70% 20%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 85% 55%, rgba(212,160,74,0.6), transparent),
    radial-gradient(1px 1px at 15% 65%, rgba(212,160,74,0.7), transparent),
    radial-gradient(2px 2px at 90% 80%, rgba(212,160,74,0.5), transparent),
    radial-gradient(1px 1px at 50% 75%, rgba(212,160,74,0.8), transparent),
    radial-gradient(1.5px 1.5px at 35% 90%, rgba(212,160,74,0.6), transparent);
  pointer-events: none;
  z-index: 0;
  animation: twinkle 4s ease-in-out infinite alternate;
}

@keyframes twinkle {
  0% { opacity: 0.4; }
  100% { opacity: 0.8; }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

/* ===== APP CONTAINER ===== */
.app-container {
  position: relative;
  z-index: 1;
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
}

/* ===== BISMILLAH HEADER ===== */
.bismillah-top {
  font-family: 'Scheherazade New', 'Amiri', serif;
  font-size: 0.7em;
  color: var(--bismillah-color);
  opacity: 0.4;
  direction: rtl;
  white-space: nowrap;
  user-select: none;
  text-shadow: 0 0 10px var(--bismillah-glow);
  transition: opacity var(--transition);
  text-align: center;
  width: 100%;
  padding: 2px 0 0;
}
.bismillah-top:hover { opacity: 0.65; }

.arabic-title-inline {
  font-family: 'Reem Kufi', 'Aref Ruqaa', 'Amiri', serif;
  font-size: 2em;
  font-weight: 700;
  color: var(--accent);
  direction: rtl;
  user-select: none;
  line-height: 1;
  flex-shrink: 0;
  background: linear-gradient(180deg, var(--accent) 30%, var(--bismillah-color) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 1px 4px rgba(0,0,0,0.15));
}

.app-version {
  font-family: var(--font-body);
  font-size: 0.55em;
  color: var(--text-secondary);
  opacity: 0.45;
  align-self: flex-end;
  margin-left: 4px;
  margin-bottom: 4px;
  user-select: none;
}

.top-bar-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  width: 100%;
}

/* ===== SIMPLE MODE ===== */
body.simple-mode .profiles-bar { display: none !important; }
body.simple-mode .task-form-grid .form-group:not(.full-width) { display: none !important; }
body.simple-mode .search-filter-bar { display: none !important; }
body.simple-mode .task-meta { display: none !important; }
body.simple-mode .kb-toggle-btn { display: none !important; }
body.simple-mode .help-toggle-btn { display: none !important; }
body.simple-mode .secure-notes-section { display: none !important; }
body.simple-mode .simple-notes-section { display: block !important; }
body.simple-mode .task-form-grid { grid-template-columns: 1fr !important; }
body.simple-mode .task-item { padding-left: 16px; }

body:not(.simple-mode) .simple-notes-section { display: none !important; }

.simple-notes-section .simple-note-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 10px;
}
.simple-notes-section .simple-note-card h4 {
  color: var(--accent);
  font-size: 1em;
  margin: 0 0 6px 0;
}
.simple-notes-section .simple-note-card p {
  color: var(--text-secondary);
  font-size: 0.9em;
  margin: 0;
  white-space: pre-wrap;
  line-height: 1.5;
}
.simple-notes-section .simple-note-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  justify-content: flex-end;
}

/* ===== NOTES TOOLBAR ===== */
.notes-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.notes-toolbar .notes-search {
  flex: 1;
  min-width: 120px;
  padding: 8px 12px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text);
  font-size: 0.9em;
}
.notes-toolbar .notes-search::placeholder { color: var(--text-secondary); opacity: 0.6; }
.notes-toolbar .view-toggle {
  display: flex;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
.notes-toolbar .view-toggle button {
  padding: 7px 12px;
  background: var(--bg-card);
  color: var(--text-secondary);
  border: none;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.2s;
}
.notes-toolbar .view-toggle button.active {
  background: var(--accent);
  color: var(--bg);
}

/* ===== NOTES GRID VIEW ===== */
.notes-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.notes-grid .note-grid-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px;
  cursor: pointer;
  transition: all 0.2s;
  overflow: hidden;
}
.notes-grid .note-grid-card:hover { border-color: var(--accent); }
.notes-grid .note-grid-card .grid-thumb {
  width: 100%;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 6px;
}
.notes-grid .note-grid-card h4 {
  color: var(--accent);
  font-size: 0.85em;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.notes-grid .note-grid-card small {
  color: var(--text-secondary);
  font-size: 0.75em;
  opacity: 0.6;
}
.notes-grid .note-grid-card .grid-actions {
  display: flex;
  gap: 4px;
  margin-top: 6px;
  justify-content: flex-end;
}

/* ===== COLLAPSIBLE NOTE CARD ===== */
.note-collapsible { cursor: pointer; }
.note-collapsible .note-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.note-collapsible .note-header .note-chevron {
  transition: transform 0.2s;
  color: var(--text-secondary);
  font-size: 0.8em;
}
.note-collapsible.expanded .note-chevron { transform: rotate(90deg); }
.note-collapsible .note-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.note-collapsible.expanded .note-body {
  max-height: 2000px;
}

/* Load more button */
.notes-load-more {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  background: var(--bg-card);
  border: 1px dashed var(--border);
  border-radius: var(--radius);
  color: var(--accent);
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}
.notes-load-more:hover { border-color: var(--accent); }

/* ===== TOP BAR ===== */
.top-bar {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 16px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  margin-bottom: 20px;
  border: 1px solid var(--border);
}

.top-bar-left, .top-bar-right {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  flex: 1;
}

.top-bar-right {
  justify-content: flex-end;
}


/* ===== BUTTONS ===== */
.btn {
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85em;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.btn:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px var(--accent-glow);
}

.btn-accent {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  font-weight: 600;
}

.btn-accent:hover {
  background: var(--accent-hover);
  border-color: var(--accent-hover);
}

.btn-danger {
  border-color: var(--danger);
  color: var(--danger);
}
.btn-danger:hover {
  background: var(--danger);
  color: white;
  border-color: var(--danger);
}

.btn-sm {
  padding: 5px 10px;
  font-size: 0.8em;
}

.btn-icon {
  padding: 6px 8px;
  min-width: 34px;
  justify-content: center;
}

/* ===== SELECT / INPUT ===== */
select, input, textarea {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.9em;
  transition: border-color var(--transition), box-shadow var(--transition);
  outline: none;
}

select:focus, input:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

textarea { resize: vertical; min-height: 80px; }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  padding: 4px;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  margin-bottom: 20px;
  border: 1px solid var(--border);
  overflow-x: auto;
}

.tab {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: calc(var(--radius) - 2px);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.9em;
  font-weight: 500;
  transition: all var(--transition);
  white-space: nowrap;
  text-align: center;
}

.tab:hover { color: var(--text-primary); background: var(--bg-card); }
.tab.active {
  background: var(--accent);
  color: var(--bg-primary);
  font-weight: 600;
  box-shadow: 0 2px 8px var(--accent-glow);
}

/* ===== TASK FORM ===== */
.task-form {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  transition: all var(--transition);
}

.task-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.task-form-grid .full-width { grid-column: 1 / -1; }

.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group label {
  font-size: 0.8em;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  justify-content: flex-end;
}

/* ===== SEARCH & FILTER BAR ===== */
.search-filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.search-input-wrapper {
  flex: 1;
  min-width: 200px;
  position: relative;
}

.search-input-wrapper input {
  width: 100%;
  padding-left: 36px;
}

.search-input-wrapper .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  font-size: 0.9em;
}

/* ===== TASK LIST ===== */
.task-list { display: flex; flex-direction: column; gap: 8px; }

.task-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: all var(--transition);
  animation: slideIn 0.3s ease-out;
  cursor: grab;
  position: relative;
  overflow: hidden;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.task-item:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 12px var(--shadow);
}

.task-item.done { opacity: 0.6; }
.task-item.done .task-title { text-decoration: line-through; }

.task-item.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.task-priority-indicator {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
}

.task-priority-indicator.high { background: var(--priority-high); }
.task-priority-indicator.medium { background: var(--priority-med); }
.task-priority-indicator.low { background: var(--priority-low); }

.task-checkbox {
  width: 22px;
  height: 22px;
  border: 2px solid var(--accent);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
  transition: all var(--transition);
  background: transparent;
  color: transparent;
  font-size: 14px;
}

.task-checkbox.checked {
  background: var(--accent);
  color: var(--bg-primary);
}

.task-checkbox:hover { box-shadow: 0 0 0 3px var(--accent-glow); }

.task-content { flex: 1; min-width: 0; }

.task-title {
  font-weight: 600;
  font-size: 1em;
  margin-bottom: 4px;
  word-break: break-word;
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 0.78em;
  color: var(--text-secondary);
}

.task-meta-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  background: var(--bg-input);
  border-radius: 20px;
}

.task-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state .icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
.empty-state h3 { margin-bottom: 8px; color: var(--text-primary); }

/* ===== SECURE NOTES ===== */
.secure-notes-section {
  margin-top: 20px;
}

.note-item {
  padding: 14px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  transition: all var(--transition);
}

.note-item:hover { border-color: var(--accent); }

.note-locked {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  font-style: italic;
}

/* ===== PIN LOCK OVERLAY ===== */
.pin-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg-primary);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.pin-overlay .bismillah-text { font-size: 2em; }

.pin-input-group {
  display: flex;
  gap: 10px;
}

.pin-digit {
  width: 50px;
  height: 60px;
  text-align: center;
  font-size: 1.5em;
  font-weight: 700;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}

.pin-digit:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

/* ===== MODAL ===== */
.modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  animation: scaleIn 0.2s ease;
}

@keyframes scaleIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal h2 { margin-bottom: 16px; font-family: var(--font-display); color: var(--accent); }
.modal .form-group { margin-bottom: 12px; }

/* ===== SETTINGS PANEL ===== */
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 10px;
  overflow: hidden;
}

.settings-section h3 {
  color: var(--accent);
  margin: 0;
  font-size: 1.05em;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Collapsible settings header */
.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.settings-header:hover { background: rgba(255,255,255,0.04); }
.settings-arrow {
  font-size: 0.7em;
  color: var(--text-secondary);
  transition: transform 0.2s;
}
.settings-header.open .settings-arrow { transform: rotate(180deg); }
.settings-body {
  display: none;
  padding: 0 18px 16px;
}
.settings-body.open { display: block; animation: fadeIn 0.2s ease; }

/* Non-collapsible (About section) */
.settings-section-static { padding: 20px; }

.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  gap: 10px;
}

.setting-row:last-child { border-bottom: none; }

.setting-label { font-size: 0.9em; color: var(--text-secondary); }

/* Speech-to-Text Mic Button */
.stt-input-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
}
.stt-input-wrap input,
.stt-input-wrap textarea { flex: 1; min-width: 0; }
.btn-mic {
  flex-shrink: 0;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.btn-mic:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-mic.listening {
  background: #e74c3c;
  color: #fff;
  border-color: #e74c3c;
  animation: micPulse 1s ease infinite;
}
@keyframes micPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 48px;
  height: 26px;
  background: var(--bg-input);
  border-radius: 13px;
  cursor: pointer;
  transition: background var(--transition);
  border: 1px solid var(--border);
}

.toggle.active { background: var(--accent); border-color: var(--accent); }

.toggle::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: var(--text-primary);
  border-radius: 50%;
  transition: transform var(--transition);
}

.toggle.active::after { transform: translateX(22px); background: var(--bg-primary); }

/* Theme Grid */
.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
}

.theme-card {
  padding: 12px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  text-align: center;
  font-size: 0.85em;
  transition: all var(--transition);
}

.theme-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.theme-card.active { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

.theme-card .theme-icon { font-size: 1.8em; margin-bottom: 6px; }

/* ===== PROFILES ===== */
.profiles-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.profile-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}

.profile-chip.active {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

/* ===== FIREBASE STATUS ===== */
.sync-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8em;
  color: var(--text-secondary);
}

.sync-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-secondary);
}

.sync-dot.online { background: var(--success); }
.sync-dot.warning { background: var(--warning); }
.sync-dot.offline { background: var(--danger); }

/* Language Picker */
.lang-picker { position: relative; }
.lang-picker-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85em;
  font-weight: 500;
  transition: all 0.15s;
}
.lang-picker-btn:hover { border-color: var(--accent); }
.lang-picker-btn svg { border-radius: 2px; flex-shrink: 0; }
.lang-picker-menu {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  z-index: 100;
  min-width: 90px;
  overflow: hidden;
}
[dir="rtl"] .lang-picker-menu { right: auto; left: 0; }
.lang-picker-menu.open { display: block; animation: fadeIn 0.15s ease; }
.lang-option {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: transparent;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85em;
  font-weight: 500;
  transition: background 0.1s;
}
.lang-option:hover { background: rgba(255,255,255,0.08); }
.lang-option svg { border-radius: 2px; flex-shrink: 0; }

/* ===== RTL SUPPORT ===== */
[dir="rtl"] .task-priority-indicator { left: auto; right: 0; }
[dir="rtl"] .search-input-wrapper input { padding-left: 12px; padding-right: 36px; }
[dir="rtl"] .search-input-wrapper .search-icon { left: auto; right: 12px; }
[dir="rtl"] .task-item { padding-left: 16px; padding-right: 20px; }
[dir="rtl"] .bismillah-text { direction: rtl; }

/* ===== RESPONSIVE ===== */
@media (max-width: 640px) {
  .app-container { padding: 10px; }
  .bismillah-text { font-size: 1.6em; }
  .bismillah-top { font-size: 0.6em; }
  .arabic-title-inline { font-size: 1.5em; }
  .task-form-grid { grid-template-columns: 1fr; }
  .top-bar-row { flex-direction: column; align-items: stretch; }
  .top-bar-left, .top-bar-right { justify-content: center; }
  .search-filter-bar { flex-direction: column; }
  .theme-grid { grid-template-columns: repeat(3, 1fr); }
  .tabs { flex-wrap: nowrap; overflow-x: auto; }
  .tab { min-width: fit-content; flex: unset; padding: 10px 14px; }

  /* Mobile simple mode: bigger targets, more breathing room */
  body.simple-mode .task-form { padding: 12px; }
  body.simple-mode .task-form input,
  body.simple-mode .task-form textarea { font-size: 16px; padding: 12px; }
  body.simple-mode .btn { min-height: 44px; font-size: 0.95em; }
  body.simple-mode .task-item { padding: 14px 16px; }
  body.simple-mode .task-title { font-size: 1em; }
  body.simple-mode .simple-note-card { padding: 14px; }
  body.simple-mode .tabs { justify-content: center; }
  body.simple-mode .tab { flex: 1; text-align: center; padding: 12px 8px; font-size: 1em; }
  body.simple-mode .top-bar-right { gap: 6px; }
}

/* ===== FOOTER ===== */
.app-footer {
  text-align: center;
  padding: 20px 16px 12px;
  margin-top: 30px;
  border-top: 1px solid var(--border);
  opacity: 0.5;
  transition: opacity var(--transition);
}
.app-footer:hover { opacity: 0.8; }
.footer-brand {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: var(--text-secondary);
  font-size: 0.8em;
  font-family: var(--font-body);
}
.footer-logo {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  object-fit: contain;
}

/* ===== NOTIFICATION TOAST ===== */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--accent);
  color: var(--bg-primary);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.9em;
  z-index: 2000;
  transition: transform 0.3s ease;
  box-shadow: 0 4px 20px var(--accent-glow);
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== ISLAMIC SHORTCUTS DRAWER ===== */
.shortcuts-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 450;
  display: none;
  animation: fadeIn 0.2s ease;
}

.shortcuts-backdrop.open { display: block; }

.shortcuts-drawer {
  position: fixed;
  top: 0;
  right: 0;
  width: 300px;
  max-width: 85vw;
  height: 100vh;
  background: var(--bg-secondary);
  border-left: 2px solid var(--accent);
  z-index: 451;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: -8px 0 30px rgba(0,0,0,0.4);
}

[dir="rtl"] .shortcuts-drawer {
  right: auto;
  left: 0;
  border-left: none;
  border-right: 2px solid var(--accent);
  transform: translateX(-100%);
  box-shadow: 8px 0 30px rgba(0,0,0,0.4);
}

.shortcuts-drawer.open { transform: translateX(0); }

/* Settings Sidebar */
.settings-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 500;
  display: none;
  animation: fadeIn 0.2s ease;
}
.settings-backdrop.open { display: block; }

.settings-sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  max-width: 90vw;
  height: 100vh;
  background: var(--bg-primary);
  border-left: 2px solid var(--accent);
  z-index: 501;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: -8px 0 30px rgba(0,0,0,0.4);
  overflow: hidden;
}

[dir="rtl"] .settings-sidebar {
  right: auto;
  left: 0;
  border-left: none;
  border-right: 2px solid var(--accent);
  transform: translateX(-100%);
  box-shadow: 8px 0 30px rgba(0,0,0,0.4);
}

.settings-sidebar.open { transform: translateX(0); }

.settings-sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.settings-sidebar-header h3 {
  color: var(--accent);
  font-size: 1.1em;
  margin: 0;
}

.settings-sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.shortcuts-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.shortcuts-header h3 {
  color: var(--accent);
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-body);
}

.shortcuts-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 1.3em;
  cursor: pointer;
  padding: 4px;
  transition: color var(--transition);
}

.shortcuts-close:hover { color: var(--accent); }

.shortcuts-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.shortcuts-add-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  background: transparent;
  color: var(--accent);
  font-family: inherit;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}

.shortcuts-add-btn:hover {
  border-color: var(--accent);
  background: rgba(212,160,74,0.05);
}

/* Custom shortcut form */
.shortcuts-form {
  display: none;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 10px;
}

.shortcuts-form.open { display: block; animation: fadeIn 0.2s ease; }

.shortcuts-form .form-group { margin-bottom: 8px; }
.shortcuts-form .form-group label { font-size: 0.75em; }
.shortcuts-form input { width: 100%; font-size: 0.85em; padding: 6px 10px; }
.shortcuts-form .form-actions { margin-top: 8px; }

/* Phrase card */
.phrase-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}

.phrase-card:hover {
  border-color: var(--accent);
  transform: translateX(-3px);
  box-shadow: 0 2px 12px var(--shadow);
}

[dir="rtl"] .phrase-card:hover { transform: translateX(3px); }

.phrase-card:active {
  background: rgba(212,160,74,0.08);
}

.phrase-arabic {
  font-family: 'Amiri', 'Aref Ruqaa', serif;
  font-size: 1.15em;
  color: var(--text-primary);
  direction: rtl;
  text-align: right;
  line-height: 1.6;
  margin-bottom: 4px;
}

.phrase-translit {
  font-size: 0.78em;
  color: var(--accent);
  font-style: italic;
  margin-bottom: 2px;
}

.phrase-meaning {
  font-size: 0.75em;
  color: var(--text-secondary);
}

.phrase-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 6px;
}

.phrase-insert-hint {
  font-size: 0.7em;
  color: var(--text-secondary);
  opacity: 0.6;
}

.phrase-delete-btn {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 0.85em;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0;
  transition: opacity var(--transition);
}

.phrase-card:hover .phrase-delete-btn.visible { opacity: 1; }
.phrase-delete-btn:hover { background: rgba(192,57,43,0.1); }

/* Section divider in drawer */
.shortcuts-divider {
  font-size: 0.7em;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 8px 4px 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}

@media (max-width: 640px) {
  .shortcuts-drawer { width: 260px; }
  .phrase-arabic { font-size: 1em; }
}

/* ===== HELP WIDGET ===== */
.help-toggle-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 400;
  box-shadow: 0 4px 16px var(--accent-glow);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

.help-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 24px var(--accent-glow);
}

.help-toggle-btn.active {
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border);
  box-shadow: 0 4px 12px var(--shadow);
}

.help-toggle-btn.active:hover {
  color: var(--accent);
  border-color: var(--accent);
}

[dir="rtl"] .help-toggle-btn { left: auto; right: 20px; }
[dir="rtl"] .kb-toggle-btn { right: auto; left: 20px; }

body.help-open .help-toggle-btn { bottom: calc(65vh + 10px); }

.help-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 65vh;
  background: var(--bg-secondary);
  border-top: 2px solid var(--accent);
  z-index: 398;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.5);
}

.help-panel.open { transform: translateY(0); }

.help-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.help-header h3 {
  color: var(--accent);
  font-size: 1.1em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-search {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.85em;
  outline: none;
  width: 180px;
  transition: border-color var(--transition);
}

.help-search:focus { border-color: var(--accent); }

.help-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* Quick Tips Cards */
.help-quick-tips {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.help-tip-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  transition: all var(--transition);
}

.help-tip-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow);
}

.help-tip-icon {
  font-size: 1.8em;
  margin-bottom: 6px;
}

.help-tip-title {
  font-weight: 600;
  color: var(--accent);
  font-size: 0.95em;
  margin-bottom: 4px;
}

.help-tip-desc {
  font-size: 0.82em;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* Section Label */
.help-section-label {
  font-size: 0.8em;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 16px 0 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border);
}

/* Accordion */
.help-accordion { margin-bottom: 8px; }

.help-accordion-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
  font-size: 0.9em;
  color: var(--text-primary);
  width: 100%;
  text-align: left;
}

[dir="rtl"] .help-accordion-header { text-align: right; }

.help-accordion-header:hover {
  border-color: var(--accent);
  background: rgba(212,160,74,0.05);
}

.help-accordion-header.active {
  border-color: var(--accent);
  border-radius: var(--radius) var(--radius) 0 0;
  background: rgba(212,160,74,0.08);
}

.help-accordion-icon {
  font-size: 0.8em;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-accordion-arrow {
  transition: transform 0.2s ease;
  font-size: 0.9em;
}

.help-accordion-header.active .help-accordion-arrow {
  transform: rotate(180deg);
}

.help-accordion-body {
  display: none;
  padding: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  font-size: 0.85em;
  color: var(--text-secondary);
  line-height: 1.7;
}

.help-accordion-body.open { display: block; animation: fadeIn 0.2s ease; }

.help-accordion-body ul {
  padding-left: 18px;
  margin: 6px 0;
}

.help-accordion-body li { margin: 4px 0; }
.help-accordion-body li::marker { color: var(--accent); }
.help-accordion-body strong { color: var(--text-primary); }

/* Step-by-step guide */
.help-steps { counter-reset: step-counter; padding: 0; list-style: none; margin: 8px 0; }
.help-steps li {
  counter-increment: step-counter;
  position: relative;
  padding: 10px 12px 10px 44px;
  margin: 6px 0;
  background: var(--bg-input);
  border-radius: 8px;
  border-left: 3px solid var(--accent);
  font-size: 0.88em;
  line-height: 1.5;
}
[dir="rtl"] .help-steps li { padding: 10px 44px 10px 12px; border-left: none; border-right: 3px solid var(--accent); }
.help-steps li::before {
  content: counter(step-counter);
  position: absolute;
  left: 10px; top: 10px;
  width: 24px; height: 24px;
  background: var(--accent);
  color: #fff;
  border-radius: 50%;
  font-size: 0.78em;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
}
[dir="rtl"] .help-steps li::before { left: auto; right: 10px; }
.help-steps code {
  background: rgba(255,255,255,0.08);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 0.9em;
  color: var(--accent);
  word-break: break-all;
}
.help-sub-accordion { margin: 8px 0 4px; }
.help-sub-accordion summary {
  cursor: pointer;
  color: var(--accent);
  font-weight: 600;
  font-size: 0.9em;
  padding: 4px 0;
}
.help-sub-accordion summary:hover { text-decoration: underline; }
.help-note {
  background: rgba(255,193,7,0.1);
  border-left: 3px solid #ffc107;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.85em;
  margin: 8px 0;
  color: var(--text-secondary);
}
[dir="rtl"] .help-note { border-left: none; border-right: 3px solid #ffc107; }

/* Contextual Tooltips */
.tooltip-trigger {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: transparent;
  border: 1px solid var(--text-secondary);
  color: var(--text-secondary);
  font-size: 0.65em;
  font-weight: 700;
  cursor: help;
  position: relative;
  vertical-align: middle;
  margin-left: 4px;
  transition: all var(--transition);
  font-family: inherit;
  padding: 0;
  line-height: 1;
}

[dir="rtl"] .tooltip-trigger { margin-left: 0; margin-right: 4px; }

.tooltip-trigger:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

.tooltip-bubble {
  display: none;
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-secondary);
  white-space: normal;
  width: 220px;
  z-index: 600;
  box-shadow: 0 4px 16px var(--shadow);
  line-height: 1.5;
  text-align: left;
}

[dir="rtl"] .tooltip-bubble { text-align: right; }

.tooltip-bubble::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--accent);
}

.tooltip-trigger:hover .tooltip-bubble,
.tooltip-trigger:focus .tooltip-bubble { display: block; }

/* Help panel responsive */
@media (max-width: 640px) {
  .help-panel { height: 75vh; }
  .help-quick-tips { grid-template-columns: 1fr; }
  .help-search { width: 120px; }
  body.help-open .help-toggle-btn { bottom: calc(75vh + 10px); }
  .tooltip-bubble { width: 180px; left: auto; right: -10px; transform: none; }
  .tooltip-bubble::after { left: auto; right: 14px; transform: none; }
}

/* ===== ARABIC VIRTUAL KEYBOARD ===== */
.kb-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 400;
  box-shadow: 0 4px 16px var(--accent-glow);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.kb-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 24px var(--accent-glow);
}

.kb-toggle-btn.active {
  right: auto;
  left: 20px;
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border);
  box-shadow: 0 4px 12px var(--shadow);
}

.kb-toggle-btn.active:hover {
  color: var(--accent);
  border-color: var(--accent);
}

[dir="rtl"] .kb-toggle-btn { right: auto; left: 20px; }
[dir="rtl"] .kb-toggle-btn.active { left: auto; right: 20px; }

.arabic-keyboard {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border-top: 2px solid var(--accent);
  z-index: 399;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 0;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
}

.arabic-keyboard.open {
  transform: translateY(0);
}

.kb-toolbar {
  display: flex;
  flex-direction: column;
  padding: 6px 8px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  gap: 4px;
}

.kb-toolbar-row1 {
  display: flex;
  align-items: center;
  gap: 5px;
}

.kb-toolbar-row2 {
  display: flex;
  justify-content: center;
  gap: 4px;
}

.kb-preview {
  flex: 1;
  min-width: 0;
  padding: 6px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: 'Amiri', serif;
  font-size: 1.1em;
  direction: rtl;
  text-align: right;
  min-height: 36px;
  line-height: 24px;
  outline: none;
}

.kb-preview:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.kb-toolbar-btns {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

.kb-tool-btn {
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-input);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8em;
  font-family: inherit;
  transition: all var(--transition);
  white-space: nowrap;
  min-height: 32px;
}

.kb-tool-btn:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

.kb-rows {
  padding: 6px 4px 10px;
}

.kb-row {
  display: flex;
  justify-content: center;
  gap: 3px;
  margin-bottom: 3px;
}

.kb-key {
  min-width: 32px;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-card);
  color: var(--text-primary);
  font-family: 'Amiri', serif;
  font-size: 1.15em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  user-select: none;
  -webkit-user-select: none;
  position: relative;
}

.kb-key:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 3px 8px var(--accent-glow);
}

.kb-key:active {
  transform: translateY(0);
  background: var(--accent-hover);
}

.kb-key.pressed {
  background: var(--accent);
  color: var(--bg-primary);
  transform: scale(1.15);
}

.kb-key-wide {
  min-width: 52px;
  font-size: 0.85em;
  font-family: var(--font-body);
}

.kb-key-space {
  flex: 1;
  max-width: 220px;
  font-size: 0.8em;
  font-family: var(--font-body);
}

.kb-key-haraka {
  min-width: 34px;
  height: 38px;
  font-size: 1.3em;
  color: var(--accent);
  background: transparent;
  border-color: rgba(212,160,74,0.15);
}

.kb-key-haraka:hover {
  color: var(--bg-primary);
}

.kb-section-label {
  font-size: 0.7em;
  color: var(--text-secondary);
  text-align: center;
  margin: 4px 0 2px;
  font-family: var(--font-body);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Responsive keyboard */
@media (max-width: 640px) {
  .kb-key { min-width: 26px; height: 38px; font-size: 1em; }
  .kb-key-wide { min-width: 40px; }
  .kb-key-haraka { min-width: 28px; height: 34px; }
  .kb-tool-btn { padding: 4px 8px; font-size: 0.75em; }
}

/* When keyboard is open, add padding to body */
body.kb-open {
  padding-bottom: 300px;
}

body.kb-open .kb-toggle-btn {
  bottom: 310px;
}

/* ===== PASSWORD WRAPPER ===== */
.password-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
}

.password-wrapper input {
  flex: 1;
  padding-right: 44px;
}

.password-wrapper .toggle-pass {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  padding: 4px 8px;
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 1.1em;
  font-family: 'Amiri', serif;
  cursor: pointer;
  opacity: 0.7;
  min-width: auto;
}

.password-wrapper .toggle-pass:hover {
  opacity: 1;
  background: transparent;
  color: var(--text-primary);
  transform: translateY(-50%);
  box-shadow: none;
}

/* ===== PAGE SECTIONS ===== */
.page { display: none; }
.page.active { display: block; animation: fadeIn 0.3s ease; }
</style>
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a0f0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tethkir">
<link rel="apple-touch-icon" href="icon-192.png">
</head>
<body data-theme="alhambra">

<!-- PIN LOCK OVERLAY -->
<div class="pin-overlay" id="pinOverlay" style="display:none;">
  <div class="bismillah-text">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù‡Ù Ù±Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ€Ù°Ù†Ù Ù±Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</div>
  <h2 id="pinTitle" style="color:var(--accent)">Enter PIN</h2>
  <div class="pin-input-group" id="pinInputGroup">
    <input class="pin-digit" type="password" maxlength="1" data-index="0" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="1" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="2" inputmode="numeric">
    <input class="pin-digit" type="password" maxlength="1" data-index="3" inputmode="numeric">
  </div>
  <p id="pinError" style="color:var(--danger);display:none;font-size:0.9em;"></p>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- HELP WIDGET TOGGLE -->
<button class="help-toggle-btn" id="helpToggleBtn" onclick="toggleHelp()" title="Help">â“</button>

<!-- HELP PANEL -->
<div class="help-panel" id="helpPanel">
  <div class="help-header">
    <h3>â“ <span data-i18n="helpTitle">Help & Guide</span></h3>
    <input type="text" class="help-search" id="helpSearch" data-i18n-placeholder="helpSearchPlaceholder" placeholder="Search help..." oninput="filterHelp()">
  </div>
  <div class="help-body" id="helpBody">
    <!-- Quick Tips -->
    <div class="help-section-label" data-i18n="helpQuickStart">ðŸš€ QUICK START</div>
    <div class="help-quick-tips" id="helpQuickTips">
      <div class="help-tip-card" data-help-keywords="add task create new">
        <div class="help-tip-icon">ðŸ“</div>
        <div class="help-tip-title" data-i18n="helpTip1Title">Add a Task</div>
        <div class="help-tip-desc" data-i18n="helpTip1Desc">Type a title in the Tasks tab and click "+ Add Task". Set priority, due date, and category.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="done complete check finish">
        <div class="help-tip-icon">âœ…</div>
        <div class="help-tip-title" data-i18n="helpTip2Title">Complete a Task</div>
        <div class="help-tip-desc" data-i18n="helpTip2Desc">Click the checkbox on any task to mark it done.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="theme style design color">
        <div class="help-tip-icon">ðŸ•Œ</div>
        <div class="help-tip-title" data-i18n="helpTip3Title">Change Theme</div>
        <div class="help-tip-desc" data-i18n="helpTip3Desc">Go to Settings â†’ Themes and pick from 11 beautiful Islamic-inspired designs.</div>
      </div>
      <div class="help-tip-card" data-help-keywords="language arabic french english rtl">
        <div class="help-tip-icon">ðŸŒ</div>
        <div class="help-tip-title" data-i18n="helpTip4Title">Switch Language</div>
        <div class="help-tip-desc" data-i18n="helpTip4Desc">Use the language dropdown (EN/FR/AR) in the top bar. Arabic automatically enables RTL layout.</div>
      </div>
    </div>

    <!-- Feature Guide -->
    <div class="help-section-label" data-i18n="helpFeatures">ðŸ“š FEATURE GUIDE</div>

    <div class="help-accordion" data-help-keywords="task add edit delete priority date category tag search filter reorder drag">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">ðŸ“ <span data-i18n="helpFeatTasks">Tasks</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatTasksAdd">Add tasks</strong> â€” <span data-i18n="helpFeatTasksAddDesc">Type a title, set priority/date/category/tags, click "+ Add Task"</span></li>
          <li><strong data-i18n="helpFeatTasksEdit">Edit</strong> â€” <span data-i18n="helpFeatTasksEditDesc">Click âœï¸ on any task to edit it</span></li>
          <li><strong data-i18n="helpFeatTasksDel">Delete</strong> â€” <span data-i18n="helpFeatTasksDelDesc">Click ðŸ—‘ï¸ to remove a task</span></li>
          <li><strong data-i18n="helpFeatTasksPriority">Priority</strong> â€” <span data-i18n="helpFeatTasksPriorityDesc">High (red), Medium (yellow), Low (green) â€” shown as a colored bar on the left</span></li>
          <li><strong data-i18n="helpFeatTasksSearch">Search & Filter</strong> â€” <span data-i18n="helpFeatTasksSearchDesc">Use the search bar and dropdowns to find tasks by text, priority, category, or status</span></li>
          <li><strong data-i18n="helpFeatTasksDrag">Reorder</strong> â€” <span data-i18n="helpFeatTasksDragDesc">Drag and drop tasks to change their order</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="secure notes encrypt password passphrase aes lock">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">ðŸ”’ <span data-i18n="helpFeatNotes">Secure Notes</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatNotesHow">How it works</strong> â€” <span data-i18n="helpFeatNotesHowDesc">Notes are encrypted with AES-256 using your passphrase before saving. Nobody can read them without the passphrase.</span></li>
          <li><strong data-i18n="helpFeatNotesFirst">First time</strong> â€” <span data-i18n="helpFeatNotesFirstDesc">Set a passphrase and confirm it. Remember it â€” there's no recovery!</span></li>
          <li><strong data-i18n="helpFeatNotesReturn">Returning</strong> â€” <span data-i18n="helpFeatNotesReturnDesc">Enter your passphrase to unlock. If wrong, you'll see an error message.</span></li>
          <li><strong data-i18n="helpFeatNotesChange">Change passphrase</strong> â€” <span data-i18n="helpFeatNotesChangeDesc">Click ðŸ”‘ Change Passphrase (when unlocked). All notes are re-encrypted with the new one.</span></li>
          <li>âš ï¸ <strong data-i18n="helpFeatNotesWarn">Warning</strong> â€” <span data-i18n="helpFeatNotesWarnDesc">Don't store critical passwords here. Use Bitwarden (free) for that.</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="arabic keyboard type harakat diacritics virtual">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">âŒ¨ï¸ <span data-i18n="helpFeatKeyboard">Arabic Keyboard</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatKbOpen">Open/Close</strong> â€” <span data-i18n="helpFeatKbOpenDesc">Tap the âŒ¨ï¸ button (bottom-right corner)</span></li>
          <li><strong data-i18n="helpFeatKbPreview">How to use</strong> â€” <span data-i18n="helpFeatKbPreviewDesc">Type in the preview bar, then âžœ Insert to send text into the last clicked field. Or ðŸ“‹ Copy then Ctrl+V.</span></li>
          <li><strong data-i18n="helpFeatKbHarakat">Harakat</strong> â€” <span data-i18n="helpFeatKbHarakatDesc">Top row has diacritics: ÙØªØ­Ø©ØŒ Ø¶Ù…Ø©ØŒ ÙƒØ³Ø±Ø©ØŒ ØªÙ†ÙˆÙŠÙ†ØŒ Ø´Ø¯Ù‘Ø©ØŒ Ø³ÙƒÙˆÙ†</span></li>
          <li><strong data-i18n="helpFeatKbNumbers">Numbers</strong> â€” <span data-i18n="helpFeatKbNumbersDesc">Arabic numerals: Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©</span></li>
        </ul>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="theme alhambra ottoman moroccan calligraphy ramadan desert style">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">ðŸ•Œ <span data-i18n="helpFeatThemes">Themes</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li>ðŸ° <strong>Alhambra</strong> â€” <span data-i18n="helpThemeAlhambra">Warm gold & terracotta, inspired by Granada's Alhambra</span></li>
          <li>ðŸ”µ <strong>Ottoman</strong> â€” <span data-i18n="helpThemeOttoman">Turquoise, cobalt blue & gold, Iznik tile inspired</span></li>
          <li>ðŸ’Ž <strong>Moroccan</strong> â€” <span data-i18n="helpThemeMoroccan">Emerald, saffron & royal blue, zellige mosaic style</span></li>
          <li>âœ’ï¸ <strong>Calligraphy</strong> â€” <span data-i18n="helpThemeCalligraphy">Cream & black ink, manuscript aesthetic</span></li>
          <li>ðŸŒ™ <strong>Ramadan</strong> â€” <span data-i18n="helpThemeRamadan">Deep navy with twinkling gold stars</span></li>
          <li>ðŸœï¸ <strong>Desert</strong> â€” <span data-i18n="helpThemeDesert">Sandy beige & palm green, calm oasis feel</span></li>
        </ul>
        <p data-i18n="helpThemeHow">Go to Settings â†’ Themes to switch. Your choice is saved automatically.</p>
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="pin lock security password">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon">ðŸ”¢ <span data-i18n="helpFeatPin">PIN Lock</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body">
        <ul>
          <li><strong data-i18n="helpFeatPinEnable">Enable</strong> â€” <span data-i18n="helpFeatPinEnableDesc">Settings â†’ PIN Lock â†’ Toggle on â†’ Set a 4-digit PIN</span></li>
          <li><strong data-i18n="helpFeatPinUse">How it works</strong> â€” <span data-i18n="helpFeatPinUseDesc">On app load, you'll need to enter the PIN before accessing your data</span></li>
          <li><strong data-i18n="helpFeatPinChange">Change PIN</strong> â€” <span data-i18n="helpFeatPinChangeDesc">Settings â†’ Click ðŸ”‘ Change PIN â†’ Enter old and new PIN</span></li>
        </ul>
      </div>
    </div>

    <!-- FAQ -->
    <div class="help-section-label" data-i18n="helpFAQ">â“ FREQUENTLY ASKED QUESTIONS</div>

    <div class="help-accordion" data-help-keywords="password store safe bitwarden">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq1Q">Can I store my passwords here?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq1A">
        <strong>Not recommended.</strong> This app is for tasks and light memos. For passwords, use a proper password manager like <strong>Bitwarden</strong> (free) or <strong>KeePass</strong>. Secure Notes are encrypted but not designed for critical credentials.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="forget passphrase recovery lost">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq2Q">What if I forget my passphrase?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq2A">
        <strong>Your notes cannot be recovered.</strong> AES encryption means without the passphrase, the data is unreadable. Always remember your passphrase or write it down in a safe place.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="offline internet connection work">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq3Q">Does it work offline?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq3A">
        <strong>Yes!</strong> In local mode, everything works without internet. Tasks are saved in your browser's localStorage. Cloud sync (Firebase) requires internet only when syncing.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="sync device phone laptop computer access everywhere">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq4Q">How do I sync across devices?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq4A">
        Set up Firebase Cloud Sync: scroll up to the <strong>â˜ï¸ Cloud Sync (Firebase)</strong> section above for a full step-by-step guide. Alternatively, use <strong>Export/Import</strong> in Settings to manually transfer data via JSON files.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="data secure safe privacy">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq5Q">Is my data secure?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq5A">
        <strong>Local mode:</strong> Data is in your browser's localStorage â€” private but not encrypted (except Secure Notes). <strong>Secure Notes:</strong> AES-256 encrypted, safe with a strong passphrase. <strong>Firebase:</strong> Protected by Google authentication, only you can access your data.
      </div>
    </div>

    <div class="help-accordion" data-help-keywords="github pages deploy host website publish">
      <button class="help-accordion-header" onclick="toggleAccordion(this)">
        <span class="help-accordion-icon"><span data-i18n="helpFaq6Q">How do I deploy on GitHub Pages?</span></span>
        <span class="help-accordion-arrow">â–¼</span>
      </button>
      <div class="help-accordion-body" data-i18n="helpFaq6A">
        Create a GitHub repo â†’ Upload files â†’ Settings â†’ Pages â†’ Select main branch â†’ Your app is live at https://username.github.io/repo-name/. Full guide in README.html.
      </div>
    </div>

  </div>
</div>

<!-- ISLAMIC SHORTCUTS DRAWER -->
<div class="shortcuts-backdrop" id="shortcutsBackdrop" onclick="toggleShortcutsDrawer()"></div>
<div class="shortcuts-drawer" id="shortcutsDrawer">
  <div class="shortcuts-header">
    <h3>ðŸ¤² <span data-i18n="shortcutsTitle">Islamic Phrases</span></h3>
    <button class="shortcuts-close" onclick="toggleShortcutsDrawer()">âœ•</button>
  </div>
  <div class="shortcuts-body">
    <!-- Add Custom Button -->
    <button class="shortcuts-add-btn" onclick="toggleCustomForm()" data-i18n="addCustomShortcut">+ Add Custom Phrase</button>

    <!-- Custom Form (hidden) -->
    <div class="shortcuts-form" id="customShortcutForm">
      <div class="form-group">
        <label data-i18n="scArabic">Arabic Text *</label>
        <input type="text" id="scArabicInput" dir="rtl" placeholder="Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù‡Ù">
      </div>
      <div class="form-group">
        <label data-i18n="scTranslit">Transliteration</label>
        <input type="text" id="scTranslitInput" placeholder="Bismillah">
      </div>
      <div class="form-group">
        <label data-i18n="scMeaning">Meaning</label>
        <input type="text" id="scMeaningInput" placeholder="In the name of Allah">
      </div>
      <div class="form-actions">
        <button class="btn btn-sm" onclick="toggleCustomForm()" data-i18n="cancel">Cancel</button>
        <button class="btn btn-sm btn-accent" onclick="saveCustomShortcut()" data-i18n="scSave">Save</button>
      </div>
    </div>

    <!-- Phrase list rendered by JS -->
    <div id="shortcutsList"></div>
  </div>
</div>

<!-- ARABIC KEYBOARD TOGGLE -->
<button class="kb-toggle-btn" id="kbToggleBtn" onclick="toggleKeyboard()" title="Arabic Keyboard">âŒ¨ï¸</button>

<!-- ARABIC VIRTUAL KEYBOARD -->
<div class="arabic-keyboard" id="arabicKeyboard">
  <!-- Toolbar with preview, copy, paste, clear -->
  <div class="kb-toolbar">
    <div class="kb-toolbar-row1">
      <input type="text" class="kb-preview" id="kbPreview" dir="rtl" placeholder="Type here..." oninput="kbPreviewText = this.value">
      <button class="kb-tool-btn" onclick="toggleShortcutsDrawer()" title="Islamic Phrases">ðŸ¤²</button>
    </div>
    <div class="kb-toolbar-row2">
      <button class="kb-tool-btn" onclick="kbCopyPreview()">ðŸ“‹ Copy</button>
      <button class="kb-tool-btn" onclick="kbPasteToField()">âžœ Insert</button>
      <button class="kb-tool-btn" onclick="kbClearPreview()">âœ– Clear</button>
    </div>
  </div>

  <div class="kb-rows">
    <!-- Harakat / Diacritics -->
    <div class="kb-section-label">Harakat</div>
    <div class="kb-row" id="kbHarakatRow">
      <div class="kb-key kb-key-haraka" data-char="ÙŽ" title="Fatha">ÙŽ</div>
      <div class="kb-key kb-key-haraka" data-char="Ù" title="Damma">Ù</div>
      <div class="kb-key kb-key-haraka" data-char="Ù" title="Kasra">Ù</div>
      <div class="kb-key kb-key-haraka" data-char="Ù‹" title="Tanween Fatha">Ù‹</div>
      <div class="kb-key kb-key-haraka" data-char="ÙŒ" title="Tanween Damma">ÙŒ</div>
      <div class="kb-key kb-key-haraka" data-char="Ù" title="Tanween Kasra">Ù</div>
      <div class="kb-key kb-key-haraka" data-char="Ù‘" title="Shadda">Ù‘</div>
      <div class="kb-key kb-key-haraka" data-char="Ù’" title="Sukun">Ù’</div>
    </div>

    <!-- Row 1: Arabic numbers -->
    <div class="kb-section-label">Numbers</div>
    <div class="kb-row" id="kbNumbersRow">
      <div class="kb-key" data-char="Ù¡">Ù¡</div>
      <div class="kb-key" data-char="Ù¢">Ù¢</div>
      <div class="kb-key" data-char="Ù£">Ù£</div>
      <div class="kb-key" data-char="Ù¤">Ù¤</div>
      <div class="kb-key" data-char="Ù¥">Ù¥</div>
      <div class="kb-key" data-char="Ù¦">Ù¦</div>
      <div class="kb-key" data-char="Ù§">Ù§</div>
      <div class="kb-key" data-char="Ù¨">Ù¨</div>
      <div class="kb-key" data-char="Ù©">Ù©</div>
      <div class="kb-key" data-char="Ù ">Ù </div>
    </div>

    <!-- Row 2: Letters row 1 -->
    <div class="kb-row">
      <div class="kb-key" data-char="Ø¶">Ø¶</div>
      <div class="kb-key" data-char="Øµ">Øµ</div>
      <div class="kb-key" data-char="Ø«">Ø«</div>
      <div class="kb-key" data-char="Ù‚">Ù‚</div>
      <div class="kb-key" data-char="Ù">Ù</div>
      <div class="kb-key" data-char="Øº">Øº</div>
      <div class="kb-key" data-char="Ø¹">Ø¹</div>
      <div class="kb-key" data-char="Ù‡">Ù‡</div>
      <div class="kb-key" data-char="Ø®">Ø®</div>
      <div class="kb-key" data-char="Ø­">Ø­</div>
      <div class="kb-key" data-char="Ø¬">Ø¬</div>
    </div>

    <!-- Row 3: Letters row 2 -->
    <div class="kb-row">
      <div class="kb-key" data-char="Ø´">Ø´</div>
      <div class="kb-key" data-char="Ø³">Ø³</div>
      <div class="kb-key" data-char="ÙŠ">ÙŠ</div>
      <div class="kb-key" data-char="Ø¨">Ø¨</div>
      <div class="kb-key" data-char="Ù„">Ù„</div>
      <div class="kb-key" data-char="Ø§">Ø§</div>
      <div class="kb-key" data-char="Øª">Øª</div>
      <div class="kb-key" data-char="Ù†">Ù†</div>
      <div class="kb-key" data-char="Ù…">Ù…</div>
      <div class="kb-key" data-char="Ùƒ">Ùƒ</div>
      <div class="kb-key" data-char="Ø©">Ø©</div>
    </div>

    <!-- Row 4: Letters row 3 -->
    <div class="kb-row">
      <div class="kb-key" data-char="Ø¦">Ø¦</div>
      <div class="kb-key" data-char="Ø¡">Ø¡</div>
      <div class="kb-key" data-char="Ø¤">Ø¤</div>
      <div class="kb-key" data-char="Ø±">Ø±</div>
      <div class="kb-key" data-char="Ù„Ø§">Ù„Ø§</div>
      <div class="kb-key" data-char="Ù‰">Ù‰</div>
      <div class="kb-key" data-char="Ùˆ">Ùˆ</div>
      <div class="kb-key" data-char="Ø²">Ø²</div>
      <div class="kb-key" data-char="Ø¸">Ø¸</div>
      <div class="kb-key" data-char="Ø·">Ø·</div>
      <div class="kb-key" data-char="Ø°">Ø°</div>
      <div class="kb-key" data-char="Ø¯">Ø¯</div>
    </div>

    <!-- Row 5: Space, backspace, symbols -->
    <div class="kb-row">
      <div class="kb-key kb-key-wide" data-action="backspace">âŒ«</div>
      <div class="kb-key" data-char="ØŒ">ØŒ</div>
      <div class="kb-key" data-char="Ø›">Ø›</div>
      <div class="kb-key kb-key-space" data-char=" ">Ù…Ø³Ø§ÙØ©</div>
      <div class="kb-key" data-char="ØŸ">ØŸ</div>
      <div class="kb-key" data-char=".">.</div>
      <div class="kb-key kb-key-wide" data-action="enter">â†µ</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app-container" id="appContainer">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="bismillah-top">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù‡Ù Ù±Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ€Ù°Ù†Ù Ù±Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</div>
    <div class="top-bar-row">
    <div class="top-bar-left">
      <div class="sync-status" id="syncStatus">
        <span class="sync-dot offline" id="syncDot"></span>
        <span id="syncLabel">Offline</span>
      </div>
    </div>
    <span class="arabic-title-inline">ØªØ°ÙƒÙŠØ±</span><span class="app-version">v4.0</span>
    <div class="top-bar-right">
      <div class="lang-picker" id="langPicker">
        <button class="lang-picker-btn" onclick="toggleLangPicker()" id="langPickerBtn">
          <span id="langFlag" style="display:inline-flex;align-items:center;"></span>
          <span id="langCode">EN</span>
          <span style="font-size:0.6em;opacity:0.6;">â–¼</span>
        </button>
        <div class="lang-picker-menu" id="langPickerMenu">
          <button class="lang-option" onclick="selectLang('en')">
            <svg width="24" height="16" viewBox="0 0 60 30"><clipPath id="ukc"><rect width="60" height="30" rx="2"/></clipPath><g clip-path="url(#ukc)"><rect width="60" height="30" fill="#012169"/><path d="M0,0L60,30M60,0L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0L60,30M60,0L0,30" stroke="#C8102E" stroke-width="4" clip-path="url(#ukc)"/><path d="M30,0V30M0,15H60" stroke="#fff" stroke-width="10"/><path d="M30,0V30M0,15H60" stroke="#C8102E" stroke-width="6"/></g></svg>
            EN
          </button>
          <button class="lang-option" onclick="selectLang('fr')">
            <svg width="24" height="16" viewBox="0 0 60 30"><rect width="20" height="30" fill="#002395"/><rect x="20" width="20" height="30" fill="#fff"/><rect x="40" width="20" height="30" fill="#ED2939"/></svg>
            FR
          </button>
          <button class="lang-option" onclick="selectLang('ar')">
            <svg width="24" height="16" viewBox="0 0 60 30"><rect width="30" height="30" fill="#006233"/><rect x="30" width="30" height="30" fill="#fff"/><circle cx="30" cy="15" r="7" fill="#D21034"/><circle cx="32" cy="15" r="5.8" fill="#fff"/><polygon points="33.5,9.5 34.8,13 38.5,13 35.5,15.3 36.5,19 33.5,16.5 30.5,19 31.5,15.3 28.5,13 32.2,13" fill="#D21034"/></svg>
            AR
          </button>
        </div>
      </div>
      <button class="btn" id="authBtn" onclick="toggleAuth()" data-i18n="signIn">â˜ï¸ Sign In</button>
      <button class="btn btn-icon" onclick="toggleSettingsSidebar()" title="Settings" style="font-size:1.1em;">âš™ï¸</button>
    </div>
    </div>
  </div>

  <!-- PROFILES BAR -->
  <div class="profiles-bar" id="profilesBar">
    <button class="profile-chip active" data-profile="default" onclick="switchProfile('default')">ðŸ‘¤ <span data-i18n="defaultProfile">Default</span></button>
    <button class="btn btn-sm" onclick="showAddProfileModal()">+ <span data-i18n="addProfile">Profile</span></button>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="tasks" onclick="switchTab('tasks')">ðŸ“ <span data-i18n="tabTasks">Tasks</span></button>
    <button class="tab" data-tab="notes" onclick="switchTab('notes')">ðŸ”’ <span data-i18n="tabNotes">Secure Notes</span></button>
  </div>

  <!-- ===== TASKS PAGE ===== -->
  <div class="page active" id="page-tasks">
    <!-- Add Task Form -->
    <div class="task-form" id="taskForm">
      <div class="task-form-grid">
        <div class="form-group full-width">
          <label data-i18n="taskTitle">Task Title</label>
          <div class="stt-input-wrap">
            <input type="text" id="taskTitleInput" data-i18n-placeholder="taskTitlePlaceholder" placeholder="What do you need to do?">
            <button type="button" class="btn-mic" onclick="toggleSTT('taskTitleInput', this)" title="Voice input">ðŸŽ¤</button>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="priority">Priority</label><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipPriority">High = urgent (red), Medium = normal (yellow), Low = can wait (green). Color bar shows on each task.</span></button>
          <select id="taskPriority">
            <option value="low" data-i18n="low">Low</option>
            <option value="medium" data-i18n="medium">Medium</option>
            <option value="high" data-i18n="high">High</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="dueDate">Due Date</label>
          <input type="date" id="taskDueDate">
        </div>
        <div class="form-group">
          <label data-i18n="category">Category</label>
          <select id="taskCategory">
            <option value="general" data-i18n="catGeneral">General</option>
            <option value="work" data-i18n="catWork">Work</option>
            <option value="personal" data-i18n="catPersonal">Personal</option>
            <option value="homework" data-i18n="catHomework">ðŸ“š Homework</option>
            <option value="chores" data-i18n="catChores">ðŸ§¹ Chores</option>
            <option value="dua" data-i18n="catDua">ðŸ¤² Dua / Quran</option>
            <option value="activities" data-i18n="catActivities">ðŸƒ Activities</option>
            <option value="fun" data-i18n="catFun">ðŸŽ¨ Fun</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="tags">Tags</label><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipTags">Add labels separated by commas (e.g. "urgent, school, home"). Use search to find tasks by tag.</span></button>
          <input type="text" id="taskTags" data-i18n-placeholder="tagsPlaceholder" placeholder="comma separated">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn" onclick="clearForm()" data-i18n="clear">Clear</button>
        <button class="btn btn-accent" onclick="addTask()" id="addTaskBtn" data-i18n="addTask">+ Add Task</button>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="search-filter-bar">
      <div class="search-input-wrapper">
        <span class="search-icon">ðŸ”</span>
        <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Search tasks..." oninput="renderTasks()">
      </div>
      <select id="filterPriority" onchange="renderTasks()">
        <option value="all" data-i18n="allPriorities">All Priorities</option>
        <option value="high" data-i18n="high">High</option>
        <option value="medium" data-i18n="medium">Medium</option>
        <option value="low" data-i18n="low">Low</option>
      </select>
      <select id="filterCategory" onchange="renderTasks()">
        <option value="all" data-i18n="allCategories">All Categories</option>
        <option value="general" data-i18n="catGeneral">General</option>
        <option value="work" data-i18n="catWork">Work</option>
        <option value="personal" data-i18n="catPersonal">Personal</option>
        <option value="homework" data-i18n="catHomework">Homework</option>
        <option value="chores" data-i18n="catChores">Chores</option>
        <option value="dua" data-i18n="catDua">Dua / Quran</option>
        <option value="activities" data-i18n="catActivities">Activities</option>
        <option value="fun" data-i18n="catFun">Fun</option>
      </select>
      <select id="filterStatus" onchange="renderTasks()">
        <option value="all" data-i18n="allStatus">All</option>
        <option value="active" data-i18n="active">Active</option>
        <option value="done" data-i18n="done">Done</option>
      </select>
    </div>

    <!-- Task List -->
    <div class="task-list" id="taskList"></div>
  </div>

  <!-- ===== SECURE NOTES PAGE ===== -->
  <div class="page" id="page-notes">
    <!-- SIMPLE MODE NOTES -->
    <div class="simple-notes-section">
      <div id="simpleNotesToolbar"></div>
      <div id="simpleNotesList" style="margin-bottom:16px;"></div>
      <div class="task-form">
        <div class="form-group">
          <label data-i18n="noteTitle">Note Title</label>
          <div class="stt-input-wrap">
            <input type="text" id="simpleNoteTitleInput" data-i18n-placeholder="noteTitlePlaceholder" placeholder="Note title...">
            <button type="button" class="btn-mic" onclick="toggleSTT('simpleNoteTitleInput', this)" title="Voice input">ðŸŽ¤</button>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="noteContent">Content</label>
          <div class="stt-input-wrap" style="align-items:flex-start;">
            <textarea id="simpleNoteContentInput" rows="3" data-i18n-placeholder="noteContentPlaceholder" placeholder="Your note..."></textarea>
            <button type="button" class="btn-mic" style="margin-top:4px;" onclick="toggleSTT('simpleNoteContentInput', this)" title="Voice input">ðŸŽ¤</button>
          </div>
        </div>
        <div class="form-group">
          <label>ðŸ“· <span data-i18n="attachImage">Attach Image</span></label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button type="button" class="btn" onclick="document.getElementById('simpleNoteImageInput').click()">ðŸ“· <span data-i18n="captureOrChoose">Camera / Gallery</span></button>
            <input type="file" id="simpleNoteImageInput" accept="image/*" capture="environment" style="display:none;" onchange="previewNoteImage(this, 'simpleNoteImagePreview')">
            <button type="button" class="btn" id="simpleNoteRemoveImg" style="display:none;" onclick="removeNoteImagePreview('simpleNoteImageInput', 'simpleNoteImagePreview')">ðŸ—‘ï¸</button>
          </div>
          <div id="simpleNoteImagePreview" style="margin-top:8px;"></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-accent" onclick="addSimpleNote()" data-i18n="saveNote">ðŸ’¾ Save Note</button>
        </div>
      </div>
    </div>

    <!-- ADVANCED MODE NOTES (encrypted) -->
    <div class="secure-notes-section">
      <div id="notePasswordSection">
        <div class="task-form">
          <h3 style="color:var(--accent);margin-bottom:12px;" data-i18n="secureNotesTitle">ðŸ” Secure Notes (AES Encrypted)</h3>
          <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:14px;" data-i18n="secureNotesDesc">Notes are encrypted with your passphrase. Without it, nobody can read them.</p>
          <p id="noteCountHint" style="color:var(--accent);font-size:0.9em;margin-bottom:14px;display:none;"></p>
          <div class="form-group">
            <label data-i18n="passphrase">Master Passphrase</label>
            <div class="password-wrapper">
              <input type="password" id="notePassphrase" data-i18n-placeholder="passphrasePlaceholder" placeholder="Enter your secret passphrase">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('notePassphrase', this)" title="Show/Hide">Ø¹Ù€</button>
            </div>
          </div>
          <!-- Confirm passphrase (only shown if no notes exist yet) -->
          <div class="form-group" id="confirmPassGroup" style="display:none;">
            <label data-i18n="confirmPassphrase">Confirm Passphrase</label>
            <div class="password-wrapper">
              <input type="password" id="notePassphraseConfirm" data-i18n-placeholder="confirmPassphrasePlaceholder" placeholder="Re-enter your passphrase">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('notePassphraseConfirm', this)" title="Show/Hide">Ø¹Ù€</button>
            </div>
            <small id="passMismatch" style="color:var(--danger);display:none;" data-i18n="passMismatch">Passphrases don't match</small>
          </div>
          <div class="form-actions" style="margin-top:10px;">
            <button class="btn btn-accent" onclick="unlockNotes()" id="unlockBtn" data-i18n="unlock">ðŸ”“ Unlock</button>
          </div>
        </div>
      </div>

      <div id="noteEditorSection" style="display:none;">
        <!-- Notes Toolbar -->
        <div id="secureNotesToolbar"></div>
        <!-- Saved Notes List (shown first) -->
        <div id="notesList" style="margin-bottom:16px;"></div>

        <!-- New Note Form (collapsible) -->
        <div id="newNoteFormWrapper">
          <button class="btn btn-accent" id="showNewNoteBtn" onclick="showNewNoteForm()" style="width:100%;padding:12px;margin-bottom:12px;">
            âœï¸ <span data-i18n="writeNewNote">Write New Note</span>
          </button>
          <div class="task-form" id="newNoteForm" style="display:none;">
            <h3 style="color:var(--accent);margin-bottom:12px;">âœï¸ <span data-i18n="newNoteTitle">New Note</span></h3>
            <div class="form-group">
              <label data-i18n="noteTitle">Note Title</label>
              <div class="stt-input-wrap">
                <input type="text" id="noteTitleInput" data-i18n-placeholder="noteTitlePlaceholder" placeholder="Note title...">
                <button type="button" class="btn-mic" onclick="toggleSTT('noteTitleInput', this)" title="Voice input">ðŸŽ¤</button>
              </div>
            </div>
            <div class="form-group">
              <label data-i18n="noteContent">Content</label>
              <div class="stt-input-wrap" style="align-items:flex-start;">
                <textarea id="noteContentInput" rows="4" data-i18n-placeholder="noteContentPlaceholder" placeholder="Your secret note..."></textarea>
                <button type="button" class="btn-mic" style="margin-top:4px;" onclick="toggleSTT('noteContentInput', this)" title="Voice input">ðŸŽ¤</button>
              </div>
            </div>
            <div class="form-group">
              <label>ðŸ“· <span data-i18n="attachImage">Attach Image</span></label>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button type="button" class="btn" onclick="document.getElementById('noteImageInput').click()">ðŸ“· <span data-i18n="captureOrChoose">Camera / Gallery</span></button>
                <input type="file" id="noteImageInput" accept="image/*" capture="environment" style="display:none;" onchange="previewNoteImage(this, 'noteImagePreview')">
                <button type="button" class="btn" id="noteRemoveImg" style="display:none;" onclick="removeNoteImagePreview('noteImageInput', 'noteImagePreview')">ðŸ—‘ï¸</button>
              </div>
              <div id="noteImagePreview" style="margin-top:8px;"></div>
            </div>
            <div class="form-actions">
              <button class="btn" onclick="cancelNewNote()" data-i18n="cancel">Cancel</button>
              <button class="btn btn-accent" onclick="addNote()" data-i18n="saveNote">ðŸ” Encrypt & Save</button>
            </div>
          </div>
        </div>

        <!-- Lock & Change Passphrase buttons -->
        <div style="display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap;">
          <button class="btn" onclick="lockNotes()" data-i18n="lock">ðŸ”’ Lock</button>
          <button class="btn" onclick="showChangePassphraseModal()" data-i18n="changePassphrase">ðŸ”‘ Change Passphrase</button>
        </div>
      </div>
    </div>
  </div>


  <!-- FOOTER -->
  <footer class="app-footer">
    <a href="https://workshop-diy.org" target="_blank" rel="noopener noreferrer" class="footer-brand">
      <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIAogICAgIHZpZXdCb3g9Ii05MS41MTM1MzQgMTgwLjc2OTQyNSAyLjI4OTk2MiAyLjI4OTk2MiIKICAgICByb2xlPSJpbWciIGFyaWEtbGFiZWw9IldvcmtzaG9wIERJWSI+CiAgPHRpdGxlPldvcmtzaG9wIERJWTwvdGl0bGU+CiAgPHJlY3QgeD0iLTkxLjUxMzUzNCIgeT0iMTgwLjc2OTQyNSIgd2lkdGg9IjIuMjg5OTYyIiBoZWlnaHQ9IjIuMjg5OTYyIiBmaWxsPSIjMDA3QkZGIiByeD0iMC4yNzQ3OTUiLz4KICA8ZyBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgPHBhdGggZD0iTS05MC4zNzA4MjcsMTgxLjYyNTA0NkMtOTAuMzgyNTM4LDE4MS42MjAzMTYsLTkwLjM5MDg2MiwxODEuNjA2NTk4LC05MC40MTY2OTUsMTgxLjU0OTQ1NEMtOTAuNDc0Mzg4LDE4MS40MjE4NDQsLTkwLjQ3NDgwOCwxODEuNDIxMDgyLC05MC40ODg0OTUsMTgxLjQxODM1Qy05MC40OTU0MDcsMTgxLjQxNjk2MiwtOTAuNTQ5MzE2LDE4MS40MTU4MzMsLTkwLjYwODMwNywxODEuNDE1ODMzTC05MC43MTU1NTMsMTgxLjQxNTgzM0wtOTAuNzIzODY5LDE4MS40MzA2MzRDLTkwLjczNTc4NiwxODEuNDUxODI4LC05MC43NzE1NjEsMTgxLjQ4NDI4MywtOTAuNzk0OTkxLDE4MS40OTUxMzJDLTkwLjg2MDAzOSwxODEuNTI1MjY5LC05MC45MzExOSwxODEuNTEyNjk1LC05MC45NzcxNjUsMTgxLjQ2Mjk1MkMtOTAuOTg4NTAzLDE4MS40NTA2ODQsLTkxLjAwMzAxNCwxODEuNDMwMjY3LC05MS4wMDkzOTksMTgxLjQxNzU4N0MtOTEuMDE5NzQ1LDE4MS4zOTcwNjQsLTkxLjAyMTAxOSwxODEuMzkwNzAxLC05MS4wMjEwMTksMTgxLjM1OTY4Qy05MS4wMjEwMTksMTgxLjMyODQ3NiwtOTEuMDE5NzE0LDE4MS4zMjIwNjcsLTkxLjAwODU5MSwxODEuMjk4NTY5Qy05MC45OTI5MiwxODEuMjY1NDg4LC05MC45NjUyNzksMTgxLjIzODExMywtOTAuOTMwODYyLDE4MS4yMjE1ODhDLTkwLjkwNzY2OSwxODEuMjEwNDY0LC05MC45MDEwMTYsMTgxLjIwOTA3NiwtOTAuODY5OTY1LDE4MS4yMDg4NjJDLTkwLjgwNzkzLDE4MS4yMDg0MzUsLTkwLjc2NDUzNCwxODEuMjI5OTUsLTkwLjczMjQ3NSwxODEuMjc3MDIzTC05MC43MTUwNDIsMTgxLjMwMjYxMkwtOTAuNTc1NjE1LDE4MS4zMDQwNzdDLTkwLjQzNjE4OCwxODEuMzA1NTI3LC05MC40MzYxOCwxODEuMzA1NTQyLC05MC40MTY4MTcsMTgxLjMxNTE3Qy05MC4zOTgzNjksMTgxLjMyNDM1NiwtOTAuMzk2NCwxODEuMzI2OTIsLTkwLjM3NTMwNSwxODEuMzY5MzU0Qy05MC4zNjMxMjEsMTgxLjM5Mzg2LC05MC4zMzQ1NDEsMTgxLjQ1NTczNCwtOTAuMzExNzksMTgxLjUwNjg1MUMtOTAuMjg5MDQsMTgxLjU1Nzk4MywtOTAuMjY3ODc2LDE4MS42MDM3MTQsLTkwLjI2NDc2MywxODEuNjA4NDlDLTkwLjI1MzE0MywxODEuNjI2MzI4LC05MC4yNTkyODUsMTgxLjYyODg3NiwtOTAuMzEzMDg3LDE4MS42Mjg2MTZDLTkwLjM0MDMxNywxODEuNjI4NDc5LC05MC4zNjYyOTUsMTgxLjYyNjg2MiwtOTAuMzcwODI3LDE4MS42MjUwNDZ6Ii8+CiAgICA8cGF0aCBkPSJNLTkxLjE3OTgxNywxODIuMDM5NDc0Qy05MS4yNDA4MjksMTgyLjAxNTA2LC05MS4yODM1NjIsMTgxLjk1NDc0MiwtOTEuMjg0MTI2LDE4MS44OTIyMjdDLTkxLjI4NDUzOCwxODEuODQ2ODc4LC05MS4yNzI3NjYsMTgxLjgyMDE0NSwtOTEuMjM2MjA2LDE4MS43ODM0MDFDLTkxLjE5ODIxOSwxODEuNzQ1MjA5LC05MS4xODI0NDksMTgxLjczOTIyNywtOTEuMTE5NzgxLDE4MS43MzkyNzNDLTkxLjA3NzkxMSwxODEuNzM5MzA0LC05MS4wNzM3MzgsMTgxLjc0MDAzNiwtOTEuMDUwMDcyLDE4MS43NTEzODlDLTkxLjAyMjQ1MywxODEuNzY0NjMzLC05MC45ODk0NDksMTgxLjc5NDk5OCwtOTAuOTczODE2LDE4MS44MjE1NDhMLTkwLjk2NDEyNywxODEuODM3OTk3TC05MC44MDE4MTksMTgxLjgzNzk5N0wtOTAuNjM5NTE5LDE4MS44Mzc5OTdMLTkwLjYzOTUxOSwxODEuODc2MTlDLTkwLjYzOTUxOSwxODEuODk3MjAyLC05MC42NDA2MjUsMTgxLjkyMjQ3LC05MC42NDE5ODMsMTgxLjkzMjM1OEwtOTAuNjQ0NDQ3LDE4MS45NTAzMTdMLTkwLjgwNDM2NywxODEuOTUwMzE3TC05MC45NjQyODcsMTgxLjk1MDMxN0wtOTAuOTgxMDc5LDE4MS45NzQzOTZDLTkxLjAwMDE5MSwxODIuMDAxODAxLC05MS4wMzc0MywxODIuMDMzNiwtOTEuMDU3Njg2LDE4Mi4wMzk4NDFDLTkxLjA2NTIxNiwxODIuMDQyMTYsLTkxLjA5MTQxNSwxODIuMDQ0NzY5LC05MS4xMTU5MTMsMTgyLjA0NTYzOUMtOTEuMTUzODU0LDE4Mi4wNDY5ODIsLTkxLjE2MzMyMiwxODIuMDQ2MDY2LC05MS4xNzk4MTcsMTgyLjAzOTQ3NHoiLz4KICAgIDxwYXRoIGQ9Ik0tOTAuNDMwMjYsMTgyLjA5NzA2MUMtOTAuNDQzNDc0LDE4Mi4wOTE3OTcsLTkwLjQ0NTc0LDE4Mi4wODY5NzUsLTkwLjQ0NTgwOCwxODIuMDY0MDQxTC05MC40NDU4NjIsMTgyLjA0NDE0NEwtOTAuNDczOTQ2LDE4Mi4wMzA3NjJDLTkwLjUwOTc0MywxODIuMDEzNzE4LC05MC41MjI5MDMsMTgyLjAwMjQ0MSwtOTAuNTM2ODM1LDE4MS45NzY4MzdDLTkwLjU1MjY4OSwxODEuOTQ3NzA4LC05MC41NTUyMDYsMTgxLjkwMjgxNywtOTAuNTQyNjQxLDE4MS44NzM1OTZDLTkwLjUzMTc3NiwxODEuODQ4MzQzLC05MC40OTQ4MzUsMTgxLjgxMjkxMiwtOTAuNDczMzQzLDE4MS44MDcxMTRDLTkwLjQ1NDk3OSwxODEuODAyMTcsLTkwLjQ1MTEyNiwxODEuNzk3NzYsLTkwLjQ0NzkyMiwxODEuNzc3OTY5Qy05MC40NDMxOTksMTgxLjc0ODc2NCwtOTAuNDQyMTU0LDE4MS43NDYzNjgsLTkwLjQzMjIyLDE4MS43NDE4MzdDLTkwLjQyNjM3NiwxODEuNzM5MTgyLC05MC40MDMwNzYsMTgxLjczNzMwNSwtOTAuMzc1ODcsMTgxLjczNzMwNUwtOTAuMzI5NDc1LDE4MS43MzczMDVMLTkwLjMyNTUxNiwxODEuNzQ3NzI2Qy05MC4zMjI5NiwxODEuNzU0NDQsLTkwLjMyMTk2LDE4MS44MTgwMzksLTkwLjMyMjcwOCwxODEuOTI2MDQxQy05MC4zMjM3LDE4Mi4wNzAxOSwtOTAuMzI0Njg0LDE4Mi4wOTQ0MzcsLTkwLjMyOTY3NCwxODIuMDk3NThDLTkwLjMzNzI5NiwxODIuMTAyNDAyLC05MC40MTc5MzgsMTgyLjEwMTk5LC05MC40MzAyNiwxODIuMDk3MDYxeiIvPgogICAgPHBhdGggZD0iTS04OS45MDU1NjMsMTgyLjI2MjIzOEMtODkuOTYxNTEsMTgyLjI0Nzg5NCwtODkuOTkwMjE5LDE4Mi4yMzQyMzgsLTkwLjA1MjM2OCwxODIuMTkyMzgzQy05MC4xMTU0MjUsMTgyLjE0OTkxOCwtOTAuMTQ5NjIsMTgyLjEzMDYxNSwtOTAuMTkyMTc3LDE4Mi4xMTM0NDlMLTkwLjIxOTI4NCwxODIuMTAyNTI0TC05MC4yMTg2NTEsMTgyLjA1MjU2N0MtOTAuMjE4MjkyLDE4Mi4wMjUwODUsLTkwLjIxNzg1NywxODEuOTQxOTEsLTkwLjIxNzY4MiwxODEuODY3NzA2TC05MC4yMTczNTQsMTgxLjczMjgwM0wtOTAuMjAwODksMTgxLjcyNjQyNUMtOTAuMTYxOTQyLDE4MS43MTEzMDQsLTkwLjExNDk2NywxODEuNjg1NzMsLTkwLjA2NDM2MiwxODEuNjUyMUMtOTAuMDA1MDM1LDE4MS42MTI2NzEsLTg5Ljk1MzIzMiwxODEuNTg2MjQzLC04OS45MTcxODMsMTgxLjU3NzAxMUMtODkuODIzNDc5LDE4MS41NTI5OTQsLTg5LjczMjYzNSwxODEuNTYyNDU0LC04OS42NDYwNjUsMTgxLjYwNTIwOUMtODkuNTYwMDQzLDE4MS42NDc2OSwtODkuNDk4MTg0LDE4MS43MjA3MzQsLTg5LjQ2MzUzMSwxODEuODIwNjk0Qy04OS40NTM0NjEsMTgxLjg0OTc0NywtODkuNDUyODIsMTgxLjg1NTUzLC04OS40NTI2OTgsMTgxLjkxOTM0MkwtODkuNDUyNTY4LDE4MS45ODcxMjJMLTg5LjQ2NjgxMiwxODIuMDI1Mjk5Qy04OS40ODcxMjIsMTgyLjA3OTcyNywtODkuNTA5ODUsMTgyLjExNzI3OSwtODkuNTQ1MDgyLDE4Mi4xNTQ2MDJDLTg5LjU5NzYxOCwxODIuMjEwMjgxLC04OS42NjA0NTQsMTgyLjI0NTcyOCwtODkuNzM5MDgyLDE4Mi4yNjQwNjlDLTg5Ljc4NjY2NywxODIuMjc1MTYyLC04OS44NTgyNDYsMTgyLjI3NDM2OCwtODkuOTA1NTYzLDE4Mi4yNjIyMzh6TS04OS43MjE1OTYsMTgxLjczNTM2N0wtODkuNzIxNTk2LDE4MS42OTg1NzhMLTg5Ljc5NTE4MSwxODEuNjk4NTc4TC04OS44Njg3NzQsMTgxLjY5ODU3OEwtODkuODY4Nzc0LDE4MS43MzUzNjdMLTg5Ljg2ODc3NCwxODEuNzcyMTU2TC04OS43OTUxODEsMTgxLjc3MjE1NkwtODkuNzIxNTk2LDE4MS43NzIxNTZMLTg5LjcyMTU5NiwxODEuNzM1MzY3ek0tOTAuMDI3NTY1LDE4MS44ODgzNTFMLTkwLjAyNzU2NSwxODEuNjk4NTc4TC05MC4wNjI0MjQsMTgxLjY5ODU3OEwtOTAuMDk3MjgyLDE4MS42OTg1NzhMLTkwLjA5NzI4MiwxODEuODg4MzUxTC05MC4wOTcyODIsMTgyLjA3ODE0TC05MC4wNjI0MjQsMTgyLjA3ODE0TC05MC4wMjc1NjUsMTgyLjA3ODE0TC05MC4wMjc1NjUsMTgxLjg4ODM1MXpNLTg5LjU2NjY2NiwxODEuODg4MzUxTC04OS41NjY2NjYsMTgxLjY5ODU3OEwtODkuNjAzNDYyLDE4MS42OTg1NzhMLTg5LjY0MDI1OSwxODEuNjk4NTc4TC04OS42NDAyNTksMTgxLjg4ODM1MUwtODkuNjQwMjU5LDE4Mi4wNzgxNEwtODkuNjAzNDYyLDE4Mi4wNzgxNEwtODkuNTY2NjY2LDE4Mi4wNzgxNEwtODkuNTY2NjY2LDE4MS44ODgzNTF6TS04OS44NzM1MjgsMTgyLjE1NDYzM0wtODkuODcyNDgyLDE4Mi4wNzgxNEwtODkuNzk3MDM1LDE4Mi4wNzgxNEwtODkuNzIxNTk2LDE4Mi4wNzgxNEwtODkuNzIxNTk2LDE4MS45NjM4ODJMLTg5LjcyMTU5NiwxODEuODQ5NjI1TC04OS43OTUxODEsMTgxLjg0OTYyNUwtODkuODY4Nzc0LDE4MS44NDk2MjVMLTg5Ljg2ODc3NCwxODEuODg2Mjc2TC04OS44Njg3NzQsMTgxLjkyMjkyOEwtODkuODMxMDA5LDE4MS45MjQwNDJMLTg5Ljc5MzI0MywxODEuOTI1MTU2TC04OS43OTIxNDUsMTgxLjk2NDg0NEwtODkuNzkxMDM5LDE4Mi4wMDQ1NDdMLTg5Ljg2ODYzNywxODIuMDA0NTQ3TC04OS45NDYyMzYsMTgyLjAwNDU0N0wtODkuOTQ2MjM2LDE4Mi4xMTYyMjZDLTg5Ljk0NjIzNiwxODIuMTc3NjQzLC04OS45NDUwMDcsMTgyLjIyOTEyNiwtODkuOTQzNTEyLDE4Mi4yMzA2MjFDLTg5Ljk0MjAxNywxODIuMjMyMTE3LC04OS45MjU4OTYsMTgyLjIzMjgzNCwtODkuOTA3Njg0LDE4Mi4yMzIyMzlMLTg5Ljg3NDU4LDE4Mi4yMzExMjVMLTg5Ljg3MzUyOCwxODIuMTU0NjMzeiIvPgogICAgPHBhdGggZD0iTS05MC45MzY3MDcsMTgyLjYwNjgxMkMtOTAuOTY5MTM5LDE4Mi41OTA1NzYsLTkwLjk5NjAwMiwxODIuNTYzNDMxLC05MS4wMTA1NzQsMTgyLjUzMjEzNUMtOTEuMDE5NDQsMTgyLjUxMzA5MiwtOTEuMDIwODg5LDE4Mi41MDQ4MjIsLTkxLjAyMDk1LDE4Mi40NzMxMjlDLTkxLjAyMTAxOSwxODIuNDM5MTc4LC05MS4wMjAwMTIsMTgyLjQzNDIwNCwtOTEuMDA4MjU1LDE4Mi40MTAzMDlDLTkwLjk5MTg4MiwxODIuMzc3MDI5LC05MC45NjU4MDUsMTgyLjM1MTA0NCwtOTAuOTMzODc2LDE4Mi4zMzYxODJDLTkwLjkxMDU2MSwxODIuMzI1MzE3LC05MC45MDU0MTEsMTgyLjMyNDQ0OCwtOTAuODY0MTU5LDE4Mi4zMjQyNjVDLTkwLjgyMjY0NywxODIuMzI0MDk3LC05MC44MTgxMywxODIuMzI0ODQ0LC05MC43OTc3NjgsMTgyLjMzNTE1OUMtOTAuNzY5MzU2LDE4Mi4zNDk1NDgsLTkwLjc0MDUwMSwxODIuMzc1MDMxLC05MC43MjQ2NywxODIuMzk5Njg5TC05MC43MTIwMzYsMTgyLjQxOTM4OEwtOTAuNTk2NTY1LDE4Mi40MTgyMTNDLTkwLjUxODIwNCwxODIuNDE3NDA0LC05MC40Nzk3MTMsMTgyLjQxNTY0OSwtOTAuNDc2Nzg0LDE4Mi40MTI3MDRDLTkwLjQ3NDQwMywxODIuNDEwMzI0LC05MC40NTExNTcsMTgyLjM2MTUyNiwtOTAuNDI1MTEsMTgyLjMwNDI2TC05MC4zNzc3NjIsMTgyLjIwMDEzNEwtOTAuMzI5MDg2LDE4Mi4xOTkwNjZDLTkwLjMwMjMxNSwxODIuMTk4NDcxLC05MC4yNzU4NjQsMTgyLjE5OTcwNywtOTAuMjcwMzA5LDE4Mi4yMDE4MjhDLTkwLjI2MDQyOSwxODIuMjA1NTgyLC05MC4yNjAzMjMsMTgyLjIwNjAwOSwtOTAuMjY1NTI2LDE4Mi4yMjAzMzdDLTkwLjI2ODQ1NiwxODIuMjI4Mzk0LC05MC4yODUwOTUsMTgyLjI2NjM3MywtOTAuMzAyNDk4LDE4Mi4zMDQ3MThDLTkwLjMxOTkwMSwxODIuMzQzMDYzLC05MC4zNDU3NzIsMTgyLjQwMDU0MywtOTAuMzU5OTg1LDE4Mi40MzI0NDlDLTkwLjM4ODUyNywxODIuNDk2NTIxLC05MC40MDY2NDcsMTgyLjUyMDI3OSwtOTAuNDMwNzEsMTgyLjUyNTE2MkMtOTAuNDM3OTgxLDE4Mi41MjY2NDIsLTkwLjUwNTQ0LDE4Mi41Mjg4MjQsLTkwLjU4MDYxMiwxODIuNTI5OTk5TC05MC43MTczLDE4Mi41MzIxNjZMLTkwLjczMDE2NCwxODIuNTUyMjYxQy05MC43NDU5NDksMTgyLjU3NjkzNSwtOTAuNzcwNzA2LDE4Mi41OTg5MzgsLTkwLjc5NjM3OSwxODIuNjExMTE1Qy05MC44MTM0MjMsMTgyLjYxOTE4NiwtOTAuODIxMzgxLDE4Mi42MjAzLC05MC44NjI2NzEsMTgyLjYyMDMzMUMtOTAuOTA4NTkyLDE4Mi42MjAzNzcsLTkwLjkxMDE3OSwxODIuNjIwMDg3LC05MC45MzY3MDcsMTgyLjYwNjgxMnoiLz4KICA8L2c+Cjwvc3ZnPg==" alt="Workshop DIY" class="footer-logo">
      <span>workshop-diy.org</span>
    </a>
  </footer>

</div>

<!-- ===== SETTINGS SIDEBAR ===== -->
<div class="settings-backdrop" id="settingsBackdrop" onclick="toggleSettingsSidebar()"></div>
<div class="settings-sidebar" id="settingsSidebar">
  <div class="settings-sidebar-header">
    <h3>âš™ï¸ <span data-i18n="tabSettings">Settings</span></h3>
    <button class="btn btn-icon" onclick="toggleSettingsSidebar()" style="font-size:1.2em;">âœ•</button>
  </div>
  <div class="settings-sidebar-body">
    <!-- Mode Toggle -->
    <div class="settings-section">
      <div class="settings-section-static">
        <div class="setting-row">
          <span class="setting-label" style="font-weight:600;color:var(--accent);" data-i18n="modeLabel">Simple Mode</span>
          <div class="toggle active" id="simpleModeToggle" onclick="toggleSimpleMode()"></div>
        </div>
        <p style="color:var(--text-secondary);font-size:0.8em;margin-top:4px;" data-i18n="modeDesc">Hide advanced features (profiles, filters, encryption)</p>
      </div>
    </div>

    <!-- Themes â€” open by default -->
    <div class="settings-section">
      <div class="settings-header open" onclick="toggleSettingsSection(this)">
        <h3>ðŸ•Œ <span data-i18n="themesTitle">Themes</span></h3>
        <span class="settings-arrow">â–¼</span>
      </div>
      <div class="settings-body open">
        <div class="theme-grid" id="themeGrid">
          <div class="theme-card active" data-themeid="alhambra" onclick="setTheme('alhambra')">
            <div class="theme-icon">ðŸ°</div>
            <div>Alhambra</div>
          </div>
          <div class="theme-card" data-themeid="ottoman" onclick="setTheme('ottoman')">
            <div class="theme-icon">ðŸ”µ</div>
            <div>Ottoman</div>
          </div>
          <div class="theme-card" data-themeid="moroccan" onclick="setTheme('moroccan')">
            <div class="theme-icon">ðŸ’Ž</div>
            <div>Moroccan</div>
          </div>
          <div class="theme-card" data-themeid="calligraphy" onclick="setTheme('calligraphy')">
            <div class="theme-icon">âœ’ï¸</div>
            <div>Calligraphy</div>
          </div>
          <div class="theme-card" data-themeid="ramadan" onclick="setTheme('ramadan')">
            <div class="theme-icon">ðŸŒ™</div>
            <div>Ramadan</div>
          </div>
          <div class="theme-card" data-themeid="desert" onclick="setTheme('desert')">
            <div class="theme-icon">ðŸœï¸</div>
            <div>Desert</div>
          </div>
          <div class="theme-card" data-themeid="garden" onclick="setTheme('garden')">
            <div class="theme-icon">ðŸŒ¿</div>
            <div>Garden</div>
          </div>
          <div class="theme-card" data-themeid="goldenage" onclick="setTheme('goldenage')">
            <div class="theme-icon">ðŸ”¬</div>
            <div>Golden Age</div>
          </div>
          <div class="theme-card" data-themeid="madrasa" onclick="setTheme('madrasa')">
            <div class="theme-icon">ðŸ“˜</div>
            <div>Madrasa</div>
          </div>
          <div class="theme-card" data-themeid="pearl" onclick="setTheme('pearl')">
            <div class="theme-icon">ðŸ¤</div>
            <div>Pearl</div>
          </div>
          <div class="theme-card" data-themeid="noor" onclick="setTheme('noor')">
            <div class="theme-icon">ðŸ’¡</div>
            <div>Noor</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PIN Lock -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>ðŸ”’ <span data-i18n="pinLockTitle">PIN Lock</span></h3>
        <span class="settings-arrow">â–¼</span>
      </div>
      <div class="settings-body">
        <div class="setting-row">
          <span class="setting-label" data-i18n="enablePin">Enable PIN Lock</span><button class="tooltip-trigger" tabindex="0">?<span class="tooltip-bubble" data-i18n="tooltipPin">Locks the app with a 4-digit code on startup. Prevents casual access but not bulletproof security.</span></button>
          <div class="toggle" id="pinToggle" onclick="togglePinSetting()"></div>
        </div>
        <div id="pinSetupArea" style="display:none;margin-top:12px;">
          <div class="form-group">
            <label data-i18n="setPin">Set 4-digit PIN</label>
            <div class="password-wrapper" style="max-width:160px;">
              <input type="password" id="pinSetInput" maxlength="4" inputmode="numeric" placeholder="0000">
              <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('pinSetInput', this)" title="Show/Hide">Ø¹Ù€</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn btn-accent btn-sm" onclick="savePin()" data-i18n="savePin">Save PIN</button>
            <button class="btn btn-sm" id="changePinBtn" onclick="showChangePinModal()" style="display:none;" data-i18n="changePin">ðŸ”‘ Change PIN</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import / Export -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>ðŸ“¦ <span data-i18n="dataTitle">Data Management</span></h3>
        <span class="settings-arrow">â–¼</span>
      </div>
      <div class="settings-body">
        <div class="setting-row">
          <span class="setting-label" data-i18n="syncDesc">Sync data to/from cloud</span>
          <button class="btn btn-sm btn-accent" onclick="manualSync()" data-i18n="syncNow">â˜ï¸ Sync Now</button>
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="exportDesc">Export all data as JSON</span>
          <button class="btn btn-sm" onclick="exportData()" data-i18n="export">ðŸ“¥ Export</button>
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="importDesc">Import data from JSON</span>
          <button class="btn btn-sm" onclick="document.getElementById('importFile').click()" data-i18n="import">ðŸ“¤ Import</button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
        </div>
        <div class="setting-row">
          <span class="setting-label" data-i18n="clearCacheDesc">Clear all local data &amp; cache</span>
          <button class="btn btn-sm btn-danger" onclick="clearAllData()" data-i18n="clearCache">ðŸ—‘ï¸ Clear Cache</button>
        </div>
      </div>
    </div>

    <!-- Firebase Config â€” collapsed by default -->
    <div class="settings-section">
      <div class="settings-header" onclick="toggleSettingsSection(this)">
        <h3>â˜ï¸ <span data-i18n="firebaseTitle">Firebase Cloud Sync</span></h3>
        <span class="settings-arrow">â–¼</span>
      </div>
      <div class="settings-body">
        <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:12px;" data-i18n="firebaseDesc">
          To enable cloud sync, create a Firebase project and paste your config below.
        </p>
        <div class="form-group">
          <label>Firebase Config (JSON)</label>
          <textarea id="firebaseConfigInput" rows="5" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
        </div>
        <div class="form-actions" style="margin-top:8px;">
          <button class="btn btn-accent btn-sm" onclick="saveFirebaseConfig()" data-i18n="saveConfig">Save Config</button>
          <button class="btn btn-sm btn-danger" onclick="clearFirebaseConfig()" data-i18n="clearConfig">Clear Config</button>
        </div>
      </div>
    </div>

    <!-- About / Version â€” always visible -->
    <div class="settings-section">
      <div class="settings-section-static" style="text-align:center;">
        <p style="color:var(--accent);font-weight:600;font-size:1em;display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;">
          ðŸ“ Tethkir â€” ØªØ°ÙƒÙŠØ±
          <span id="appVersion" style="color:var(--text-secondary);font-size:0.8em;font-weight:400;"></span>
          <a href="CHANGES.html" target="_blank" style="color:var(--accent);font-size:0.8em;text-decoration:underline;cursor:pointer;font-weight:400;" data-i18n="viewChangelog">View Changelog</a>
        </p>
      </div>
    </div>
  </div>


</div>
<div class="modal-backdrop" id="modalBackdrop" style="display:none;" onclick="closeModal(event)">
  <div class="modal" id="modalContent" onclick="event.stopPropagation()"></div>
</div>

<script>
// ===== VERSION =====
const APP_VERSION = 'v4.0';

// ===== TRANSLATIONS =====
const i18n = {
  en: {
    appTitle: 'ðŸ“ Tethkir',
    modeLabel: 'Simple Mode', modeDesc: 'Hide advanced features (profiles, filters, encryption)',
    modeLabelAdvanced: 'Advanced Mode', modeDescAdvanced: 'Profiles, filters, encrypted notes, Arabic keyboard enabled',
    noNotesYet: 'No notes yet!', noteSaved: 'Note saved! âœ…', copied: 'Copied! ðŸ“‹',
    attachImage: 'Attach Image', captureOrChoose: 'Camera / Gallery',
    offline: 'Offline', online: 'Synced', syncing: 'Syncing...',
    signIn: 'â˜ï¸ Sign In', signOut: 'â˜ï¸ Sign Out',
    tabTasks: 'Tasks', tabNotes: 'Secure Notes', tabNotesSimple: 'Notes', tabSettings: 'Settings',
    taskTitle: 'Task Title', taskTitlePlaceholder: 'What do you need to do?',
    priority: 'Priority', dueDate: 'Due Date', category: 'Category', tags: 'Tags',
    tagsPlaceholder: 'comma separated',
    low: 'Low', medium: 'Medium', high: 'High',
    catGeneral: 'General', catWork: 'Work', catPersonal: 'Personal',
    catHomework: 'ðŸ“š Homework', catChores: 'ðŸ§¹ Chores', catDua: 'ðŸ¤² Dua / Quran',
    catActivities: 'ðŸƒ Activities', catFun: 'ðŸŽ¨ Fun',
    clear: 'Clear', addTask: '+ Add Task', editTask: 'Save Edit',
    searchPlaceholder: 'Search tasks...',
    allPriorities: 'All Priorities', allCategories: 'All Categories',
    allStatus: 'All', active: 'Active', done: 'Done',
    emptyTitle: 'No tasks yet!', emptyDesc: 'Add your first task above',
    secureNotesTitle: 'ðŸ” Secure Notes (AES Encrypted)',
    secureNotesDesc: 'Notes are encrypted with your passphrase. Without it, nobody can read them.',
    passphrase: 'Master Passphrase', passphrasePlaceholder: 'Enter your secret passphrase',
    confirmPassphrase: 'Confirm Passphrase', confirmPassphrasePlaceholder: 'Re-enter your passphrase',
    passMismatch: "Passphrases don't match", enterConfirm: 'Please confirm your passphrase',
    wrongPassphrase: 'âŒ Wrong passphrase. Cannot decrypt notes.',
    unlock: 'ðŸ”“ Unlock', lock: 'ðŸ”’ Lock',
    noteTitle: 'Note Title', noteTitlePlaceholder: 'Note title...',
    noteContent: 'Content', noteContentPlaceholder: 'Your secret note...',
    addNote: '+ Add Note',
    saveNote: 'ðŸ” Encrypt & Save',
    writeNewNote: 'âœï¸ Write New Note',
    newNoteTitle: 'New Note',
    cancel: 'Cancel',
    themesTitle: 'Themes', pinLockTitle: 'PIN Lock',
    enablePin: 'Enable PIN Lock', setPin: 'Set 4-digit PIN', savePin: 'Save PIN',
    dataTitle: 'Data Management',
    syncDesc: 'Sync data to/from cloud', syncNow: 'â˜ï¸ Sync Now',
    syncing: 'Syncing...', syncDone: 'Sync complete! âœ…', syncError: 'Sync failed âŒ', syncNotSignedIn: 'Sign in to Firebase first â˜ï¸',
    exportDesc: 'Export all data as JSON', export: 'ðŸ“¥ Export',
    importDesc: 'Import data from JSON', import: 'ðŸ“¤ Import',
    clearCacheDesc: 'Clear local data & cache', clearCache: 'ðŸ—‘ï¸ Clear Cache',
    clearAllConfirm: 'This will delete ALL local data (tasks, notes, settings). Cloud data is not affected.\n\nAre you sure?',
    clearAllDone: 'Cache cleared! ðŸ—‘ï¸',
    firebaseTitle: 'Firebase Cloud Sync',
    firebaseDesc: 'To enable cloud sync, create a Firebase project and paste your config below.',
    saveConfig: 'Save Config', clearConfig: 'Clear Config',
    defaultProfile: 'Default',
    enterPin: 'Enter PIN', wrongPin: 'Wrong PIN, try again',
    taskAdded: 'Task added! âœ¨', taskDone: 'Ma Shaa Allah! âœ…',
    taskDeleted: 'Task deleted', noteAdded: 'Note encrypted & saved ðŸ”',
    dataExported: 'Data exported! ðŸ“¦', dataImported: 'Data imported! âœ…',
    confirmDelete: 'Delete this?',
    kbCopied: 'Copied to clipboard! ðŸ“‹',
    kbPasted: 'Inserted into field',
    kbNoField: 'Click on an input field first',
    kbNothingToPaste: 'Nothing to insert â€” type something first',
    kbDirectOn: 'Direct mode: typing into focused field',
    kbPreviewOn: 'Preview mode: type in keyboard preview',
    kbPhrases: 'Phrases', kbCopy: 'Copy', kbPaste: 'Paste to field', kbClear: 'Clear',
    kbDirect: 'Direct mode', kbSwitchPreview: 'Preview mode', kbSwitchDirect: 'Direct mode',
    changePassphrase: 'ðŸ”‘ Change Passphrase',
    changePassDesc: 'All notes will be re-encrypted with the new passphrase.',
    currentPassphrase: 'Current Passphrase',
    newPassphrase: 'New Passphrase', newPassPlaceholder: 'Enter new passphrase',
    confirmNewPassphrase: 'Confirm New Passphrase',
    enterCurrent: 'Enter your current passphrase',
    enterNew: 'Enter a new passphrase',
    passTooShort: 'Passphrase must be at least 3 characters',
    passSameAsOld: 'New passphrase must be different from current',
    confirmChange: 'Change & Re-encrypt',
    passChanged: 'Passphrase changed! All notes re-encrypted ðŸ”',
    reEncryptError: 'âŒ Error re-encrypting. Some notes may use a different passphrase.',
    changePin: 'ðŸ”‘ Change PIN',
    currentPin: 'Current PIN', newPin: 'New PIN', confirmNewPin: 'Confirm New PIN',
    enterValidPin: 'Enter your current 4-digit PIN',
    enterNewPin: 'Enter a new 4-digit PIN',
    pinMismatch: "PINs don't match",
    pinSameAsOld: 'New PIN must be different from current',
    confirmPinChange: 'Change PIN',
    pinChanged: 'PIN changed! ðŸ”’',
    viewChangelog: 'View Changelog',
    helpTitle: 'Help & Guide', helpSearchPlaceholder: 'Search help...',
    helpQuickStart: 'ðŸš€ QUICK START', helpFeatures: 'ðŸ“š FEATURE GUIDE', helpFAQ: 'â“ FREQUENTLY ASKED QUESTIONS',
    helpTip1Title: 'Add a Task', helpTip1Desc: 'Type a title in the Tasks tab and click "+ Add Task". Set priority, due date, and category.',
    helpTip2Title: 'Complete a Task', helpTip2Desc: 'Click the checkbox on any task to mark it done.',
    helpTip3Title: 'Change Theme', helpTip3Desc: 'Go to Settings â†’ Themes and pick from 11 beautiful Islamic-inspired designs.',
    helpTip4Title: 'Switch Language', helpTip4Desc: 'Use the language dropdown (EN/FR/AR) in the top bar. Arabic enables RTL layout.',
    tooltipPriority: 'High = urgent (red), Medium = normal (yellow), Low = can wait (green).',
    tooltipTags: 'Add labels separated by commas. Use search to find tasks by tag.',
    tooltipPin: 'Locks the app with a 4-digit code on startup.',
    shortcutsTitle: 'Islamic Phrases', addCustomShortcut: '+ Add Custom Phrase',
    scArabic: 'Arabic Text *', scTranslit: 'Transliteration', scMeaning: 'Meaning', scSave: 'Save',
    scCustomLabel: 'âœï¸ YOUR CUSTOM PHRASES', scBuiltinLabel: 'ðŸ¤² ISLAMIC PHRASES',
    scSaved: 'Custom phrase saved! ðŸ¤²', scDeleted: 'Phrase deleted',
    scInserted: 'Phrase added to preview âœ…', scTapToInsert: 'Tap to add to preview',
    profileName: 'Profile Name', profileNamePlaceholder: 'Enter name...',
    createProfile: 'Create',
  },
  fr: {
    appTitle: 'ðŸ“ Tethkir',
    modeLabel: 'Mode Simple', modeDesc: 'Masquer les fonctions avancÃ©es (profils, filtres, chiffrement)',
    modeLabelAdvanced: 'Mode AvancÃ©', modeDescAdvanced: 'Profils, filtres, notes chiffrÃ©es, clavier arabe activÃ©s',
    noNotesYet: 'Aucune note !', noteSaved: 'Note enregistrÃ©e ! âœ…', copied: 'CopiÃ© ! ðŸ“‹',
    attachImage: 'Joindre une image', captureOrChoose: 'CamÃ©ra / Galerie',
    offline: 'Hors ligne', online: 'SynchronisÃ©', syncing: 'Synchronisation...',
    signIn: 'â˜ï¸ Connexion', signOut: 'â˜ï¸ DÃ©connexion',
    tabTasks: 'TÃ¢ches', tabNotes: 'Notes SÃ©curisÃ©es', tabNotesSimple: 'Notes', tabSettings: 'ParamÃ¨tres',
    taskTitle: 'Titre de la tÃ¢che', taskTitlePlaceholder: 'Que devez-vous faire?',
    priority: 'PrioritÃ©', dueDate: 'Date limite', category: 'CatÃ©gorie', tags: 'Ã‰tiquettes',
    tagsPlaceholder: 'sÃ©parÃ©es par des virgules',
    low: 'Basse', medium: 'Moyenne', high: 'Haute',
    catGeneral: 'GÃ©nÃ©ral', catWork: 'Travail', catPersonal: 'Personnel',
    catHomework: 'ðŸ“š Devoirs', catChores: 'ðŸ§¹ CorvÃ©es', catDua: 'ðŸ¤² Dua / Coran',
    catActivities: 'ðŸƒ ActivitÃ©s', catFun: 'ðŸŽ¨ Amusement',
    clear: 'Effacer', addTask: '+ Ajouter', editTask: 'Sauvegarder',
    searchPlaceholder: 'Rechercher...',
    allPriorities: 'Toutes prioritÃ©s', allCategories: 'Toutes catÃ©gories',
    allStatus: 'Tout', active: 'Actif', done: 'Fait',
    emptyTitle: 'Aucune tÃ¢che!', emptyDesc: 'Ajoutez votre premiÃ¨re tÃ¢che',
    secureNotesTitle: 'ðŸ” Notes SÃ©curisÃ©es (Chiffrement AES)',
    secureNotesDesc: 'Les notes sont chiffrÃ©es avec votre mot de passe.',
    passphrase: 'Mot de passe maÃ®tre', passphrasePlaceholder: 'Entrez votre mot de passe secret',
    confirmPassphrase: 'Confirmer le mot de passe', confirmPassphrasePlaceholder: 'RÃ©-entrez votre mot de passe',
    passMismatch: 'Les mots de passe ne correspondent pas', enterConfirm: 'Veuillez confirmer votre mot de passe',
    wrongPassphrase: 'âŒ Mot de passe incorrect. Impossible de dÃ©chiffrer.',
    unlock: 'ðŸ”“ DÃ©verrouiller', lock: 'ðŸ”’ Verrouiller',
    noteTitle: 'Titre', noteTitlePlaceholder: 'Titre de la note...',
    noteContent: 'Contenu', noteContentPlaceholder: 'Votre note secrÃ¨te...',
    addNote: '+ Ajouter',
    saveNote: 'ðŸ” Chiffrer & Sauver',
    writeNewNote: 'âœï¸ Ã‰crire une note',
    newNoteTitle: 'Nouvelle note',
    cancel: 'Annuler',
    themesTitle: 'ThÃ¨mes', pinLockTitle: 'Verrouillage PIN',
    enablePin: 'Activer le PIN', setPin: 'PIN Ã  4 chiffres', savePin: 'Sauvegarder',
    dataTitle: 'Gestion des donnÃ©es',
    syncDesc: 'Synchroniser avec le cloud', syncNow: 'â˜ï¸ Synchroniser',
    syncing: 'Synchronisation...', syncDone: 'Synchronisation terminÃ©e ! âœ…', syncError: 'Ã‰chec de la sync âŒ', syncNotSignedIn: 'Connectez-vous Ã  Firebase d\'abord â˜ï¸',
    exportDesc: 'Exporter en JSON', export: 'ðŸ“¥ Exporter',
    importDesc: 'Importer depuis JSON', import: 'ðŸ“¤ Importer',
    clearCacheDesc: 'Effacer les donnÃ©es locales', clearCache: 'ðŸ—‘ï¸ Vider le cache',
    clearAllConfirm: 'Cela supprimera TOUTES les donnÃ©es locales (tÃ¢ches, notes, paramÃ¨tres). Les donnÃ©es cloud ne sont pas affectÃ©es.\n\nÃŠtes-vous sÃ»r ?',
    clearAllDone: 'Cache vidÃ© ! ðŸ—‘ï¸',
    firebaseTitle: 'Firebase Synchronisation',
    firebaseDesc: 'CrÃ©ez un projet Firebase et collez la configuration.',
    saveConfig: 'Sauvegarder', clearConfig: 'Effacer',
    defaultProfile: 'Par dÃ©faut',
    enterPin: 'Entrez le PIN', wrongPin: 'PIN incorrect, rÃ©essayez',
    taskAdded: 'TÃ¢che ajoutÃ©e! âœ¨', taskDone: 'Ma Shaa Allah! âœ…',
    taskDeleted: 'TÃ¢che supprimÃ©e', noteAdded: 'Note chiffrÃ©e et sauvÃ©e ðŸ”',
    dataExported: 'DonnÃ©es exportÃ©es! ðŸ“¦', dataImported: 'DonnÃ©es importÃ©es! âœ…',
    confirmDelete: 'Supprimer?',
    kbCopied: 'CopiÃ©! ðŸ“‹',
    kbPasted: 'InsÃ©rÃ© dans le champ',
    kbNoField: 'Cliquez sur un champ de saisie d\'abord',
    kbNothingToPaste: 'Rien Ã  insÃ©rer â€” tapez quelque chose d\'abord',
    kbDirectOn: 'Mode direct: saisie dans le champ actif',
    kbPreviewOn: 'Mode aperÃ§u: saisie dans l\'aperÃ§u clavier',
    kbPhrases: 'Phrases', kbCopy: 'Copier', kbPaste: 'Coller dans le champ', kbClear: 'Effacer',
    kbDirect: 'Mode direct', kbSwitchPreview: 'Mode aperÃ§u', kbSwitchDirect: 'Mode direct',
    changePassphrase: 'ðŸ”‘ Changer le mot de passe',
    changePassDesc: 'Toutes les notes seront re-chiffrÃ©es avec le nouveau mot de passe.',
    currentPassphrase: 'Mot de passe actuel',
    newPassphrase: 'Nouveau mot de passe', newPassPlaceholder: 'Entrez le nouveau mot de passe',
    confirmNewPassphrase: 'Confirmer le nouveau mot de passe',
    enterCurrent: 'Entrez votre mot de passe actuel',
    enterNew: 'Entrez un nouveau mot de passe',
    passTooShort: 'Le mot de passe doit avoir au moins 3 caractÃ¨res',
    passSameAsOld: 'Le nouveau mot de passe doit Ãªtre diffÃ©rent',
    confirmChange: 'Changer & Re-chiffrer',
    passChanged: 'Mot de passe changÃ©! Notes re-chiffrÃ©es ðŸ”',
    reEncryptError: 'âŒ Erreur de re-chiffrement.',
    changePin: 'ðŸ”‘ Changer le PIN',
    currentPin: 'PIN actuel', newPin: 'Nouveau PIN', confirmNewPin: 'Confirmer le nouveau PIN',
    enterValidPin: 'Entrez votre PIN actuel Ã  4 chiffres',
    enterNewPin: 'Entrez un nouveau PIN Ã  4 chiffres',
    pinMismatch: 'Les PINs ne correspondent pas',
    pinSameAsOld: 'Le nouveau PIN doit Ãªtre diffÃ©rent',
    confirmPinChange: 'Changer le PIN',
    pinChanged: 'PIN changÃ©! ðŸ”’',
    viewChangelog: 'Voir les changements',
    helpTitle: 'Aide & Guide', helpSearchPlaceholder: 'Rechercher...',
    helpQuickStart: 'ðŸš€ DÃ‰MARRAGE RAPIDE', helpFeatures: 'ðŸ“š GUIDE DES FONCTIONNALITÃ‰S', helpFAQ: 'â“ QUESTIONS FRÃ‰QUENTES',
    helpTip1Title: 'Ajouter une tÃ¢che', helpTip1Desc: 'Tapez un titre dans l\'onglet TÃ¢ches et cliquez "+ Ajouter". DÃ©finissez prioritÃ©, date et catÃ©gorie.',
    helpTip2Title: 'Terminer une tÃ¢che', helpTip2Desc: 'Cliquez la case Ã  cocher pour marquer une tÃ¢che comme terminÃ©e. En mode enfants, gagnez une Ã©toile! â­',
    helpTip3Title: 'Changer le thÃ¨me', helpTip3Desc: 'Allez dans ParamÃ¨tres â†’ ThÃ¨mes et choisissez parmi 11 designs islamiques.',
    helpTip4Title: 'Changer la langue', helpTip4Desc: 'Utilisez le menu dÃ©roulant (EN/FR/AR) dans la barre supÃ©rieure. L\'arabe active le mode RTL.',
    tooltipPriority: 'Haute = urgent (rouge), Moyenne = normal (jaune), Basse = peut attendre (vert).',
    tooltipTags: 'Ajoutez des Ã©tiquettes sÃ©parÃ©es par des virgules.',
    tooltipPin: 'Verrouille l\'appli avec un code Ã  4 chiffres au dÃ©marrage.',
    shortcutsTitle: 'Phrases Islamiques', addCustomShortcut: '+ Ajouter une phrase',
    scArabic: 'Texte arabe *', scTranslit: 'TranslittÃ©ration', scMeaning: 'Signification', scSave: 'Sauver',
    scCustomLabel: 'âœï¸ VOS PHRASES PERSONNALISÃ‰ES', scBuiltinLabel: 'ðŸ¤² PHRASES ISLAMIQUES',
    scSaved: 'Phrase sauvegardÃ©e! ðŸ¤²', scDeleted: 'Phrase supprimÃ©e',
    scInserted: 'Phrase ajoutÃ©e Ã  l\'aperÃ§u âœ…', scTapToInsert: 'Appuyez pour ajouter',
    profileName: 'Nom du profil', profileNamePlaceholder: 'Entrez le nom...',
    createProfile: 'CrÃ©er',
  },
  ar: {
    appTitle: 'ðŸ“ ØªØ°ÙƒÙŠØ±',
    modeLabel: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø³ÙŠØ·', modeDesc: 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø§Ù„ÙÙ„Ø§ØªØ±ØŒ Ø§Ù„ØªØ´ÙÙŠØ±)',
    modeLabelAdvanced: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', modeDescAdvanced: 'Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©ØŒ Ø§Ù„ÙÙ„Ø§ØªØ±ØŒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´ÙØ±Ø©ØŒ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…ÙØ¹Ù‘Ù„Ø©',
    noNotesYet: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª!', noteSaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©! âœ…', copied: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®! ðŸ“‹',
    attachImage: 'Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©', captureOrChoose: 'ÙƒØ§Ù…ÙŠØ±Ø§ / Ù…Ø¹Ø±Ø¶',
    offline: 'ØºÙŠØ± Ù…ØªØµÙ„', online: 'Ù…ØªØµÙ„', syncing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...',
    signIn: 'â˜ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', signOut: 'â˜ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
    tabTasks: 'Ø§Ù„Ù…Ù‡Ø§Ù…', tabNotes: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¢Ù…Ù†Ø©', tabNotesSimple: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', tabSettings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    taskTitle: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', taskTitlePlaceholder: 'Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ',
    priority: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©', dueDate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚', category: 'Ø§Ù„ÙØ¦Ø©', tags: 'Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª',
    tagsPlaceholder: 'Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„',
    low: 'Ù…Ù†Ø®ÙØ¶Ø©', medium: 'Ù…ØªÙˆØ³Ø·Ø©', high: 'Ø¹Ø§Ù„ÙŠØ©',
    catGeneral: 'Ø¹Ø§Ù…', catWork: 'Ø¹Ù…Ù„', catPersonal: 'Ø´Ø®ØµÙŠ',
    catHomework: 'ðŸ“š ÙˆØ§Ø¬Ø¨Ø§Øª', catChores: 'ðŸ§¹ Ø£Ø¹Ù…Ø§Ù„ Ù…Ù†Ø²Ù„ÙŠØ©', catDua: 'ðŸ¤² Ø¯Ø¹Ø§Ø¡ / Ù‚Ø±Ø¢Ù†',
    catActivities: 'ðŸƒ Ø£Ù†Ø´Ø·Ø©', catFun: 'ðŸŽ¨ ØªØ±ÙÙŠÙ‡',
    clear: 'Ù…Ø³Ø­', addTask: '+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', editTask: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
    searchPlaceholder: 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…...',
    allPriorities: 'ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª', allCategories: 'ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª',
    allStatus: 'Ø§Ù„ÙƒÙ„', active: 'Ù†Ø´Ø·', done: 'Ù…ÙƒØªÙ…Ù„',
    emptyTitle: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…!', emptyDesc: 'Ø£Ø¶Ù Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰',
    secureNotesTitle: 'ðŸ” Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¢Ù…Ù†Ø© (ØªØ´ÙÙŠØ± AES)',
    secureNotesDesc: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø´ÙØ±Ø© Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.',
    passphrase: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', passphrasePlaceholder: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©',
    confirmPassphrase: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', confirmPassphrasePlaceholder: 'Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
    passMismatch: 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†', enterConfirm: 'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
    wrongPassphrase: 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±.',
    unlock: 'ðŸ”“ ÙØªØ­', lock: 'ðŸ”’ Ù‚ÙÙ„',
    noteTitle: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', noteTitlePlaceholder: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...',
    noteContent: 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', noteContentPlaceholder: 'Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©...',
    addNote: '+ Ø¥Ø¶Ø§ÙØ©',
    saveNote: 'ðŸ” ØªØ´ÙÙŠØ± ÙˆØ­ÙØ¸',
    writeNewNote: 'âœï¸ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©',
    newNoteTitle: 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©',
    cancel: 'Ø¥Ù„ØºØ§Ø¡',
    themesTitle: 'Ø§Ù„Ø³Ù…Ø§Øª', pinLockTitle: 'Ù‚ÙÙ„ PIN',
    enablePin: 'ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ PIN', setPin: 'PIN Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…', savePin: 'Ø­ÙØ¸',
    dataTitle: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    syncDesc: 'Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', syncNow: 'â˜ï¸ Ù…Ø²Ø§Ù…Ù†Ø©',
    syncing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...', syncDone: 'ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©! âœ…', syncError: 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âŒ', syncNotSignedIn: 'Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ â˜ï¸',
    exportDesc: 'ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù JSON', export: 'ðŸ“¥ ØªØµØ¯ÙŠØ±',
    importDesc: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† JSON', import: 'ðŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯',
    clearCacheDesc: 'Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', clearCache: 'ðŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©',
    clearAllConfirm: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª). Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ù† ØªØªØ£Ø«Ø±.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
    clearAllDone: 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©! ðŸ—‘ï¸',
    firebaseTitle: 'Ù…Ø²Ø§Ù…Ù†Ø© Firebase Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©',
    firebaseDesc: 'Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Firebase ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.',
    saveConfig: 'Ø­ÙØ¸', clearConfig: 'Ù…Ø³Ø­',
    defaultProfile: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
    enterPin: 'Ø£Ø¯Ø®Ù„ PIN', wrongPin: 'PIN Ø®Ø§Ø·Ø¦ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
    taskAdded: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©! âœ¨', taskDone: 'Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! âœ…',
    taskDeleted: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©', noteAdded: 'ØªÙ… ØªØ´ÙÙŠØ± ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ðŸ”',
    dataExported: 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±! ðŸ“¦', dataImported: 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯! âœ…',
    confirmDelete: 'Ø­Ø°Ù Ù‡Ø°Ø§ØŸ',
    kbCopied: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®! ðŸ“‹',
    kbPasted: 'ØªÙ… Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„',
    kbNoField: 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹',
    kbNothingToPaste: 'Ù„Ø§ Ø´ÙŠØ¡ Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬ â€” Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹',
    kbDirectOn: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯',
    kbPreviewOn: 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­',
    kbPhrases: 'Ø¹Ø¨Ø§Ø±Ø§Øª', kbCopy: 'Ù†Ø³Ø®', kbPaste: 'Ù„ØµÙ‚ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„', kbClear: 'Ù…Ø³Ø­',
    kbDirect: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', kbSwitchPreview: 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©', kbSwitchDirect: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
    changePassphrase: 'ðŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
    changePassDesc: 'Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.',
    currentPassphrase: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
    newPassphrase: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', newPassPlaceholder: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
    confirmNewPassphrase: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
    enterCurrent: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
    enterNew: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©',
    passTooShort: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„',
    passSameAsOld: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ©',
    confirmChange: 'ØªØºÙŠÙŠØ± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ÙÙŠØ±',
    passChanged: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±! ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ðŸ”',
    reEncryptError: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ÙÙŠØ±.',
    changePin: 'ðŸ”‘ ØªØºÙŠÙŠØ± PIN',
    currentPin: 'PIN Ø§Ù„Ø­Ø§Ù„ÙŠ', newPin: 'PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯', confirmNewPin: 'ØªØ£ÙƒÙŠØ¯ PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯',
    enterValidPin: 'Ø£Ø¯Ø®Ù„ PIN Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…',
    enterNewPin: 'Ø£Ø¯Ø®Ù„ PIN Ø¬Ø¯ÙŠØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…',
    pinMismatch: 'Ø£Ø±Ù‚Ø§Ù… PIN ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
    pinSameAsOld: 'PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ§Ù‹',
    confirmPinChange: 'ØªØºÙŠÙŠØ± PIN',
    pinChanged: 'ØªÙ… ØªØºÙŠÙŠØ± PIN! ðŸ”’',
    viewChangelog: 'Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª',
    helpTitle: 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„', helpSearchPlaceholder: 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©...',
    helpQuickStart: 'ðŸš€ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©', helpFeatures: 'ðŸ“š Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª', helpFAQ: 'â“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©',
    helpTip1Title: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', helpTip1Desc: 'Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù†Ù‚Ø± "+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©". Ø­Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙØ¦Ø©.',
    helpTip2Title: 'Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø©', helpTip2Desc: 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© ÙƒÙ…ÙƒØªÙ…Ù„Ø©. ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ø¬Ù…Ø©! â­',
    helpTip3Title: 'ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù…Ø©', helpTip3Desc: 'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ø³Ù…Ø§Øª ÙˆØ§Ø®ØªØ± Ù…Ù† 11 ØªØµÙ…ÙŠÙ… Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø¬Ù…ÙŠÙ„Ø©.',
    helpTip4Title: 'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©', helpTip4Desc: 'Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ØºØ§Øª (EN/FR/AR) ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ. Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØªÙØ¹Ù‘Ù„ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±.',
    tooltipPriority: 'Ø¹Ø§Ù„ÙŠØ© = Ø¹Ø§Ø¬Ù„ (Ø£Ø­Ù…Ø±)ØŒ Ù…ØªÙˆØ³Ø·Ø© = Ø¹Ø§Ø¯ÙŠ (Ø£ØµÙØ±)ØŒ Ù…Ù†Ø®ÙØ¶Ø© = ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø£Ø®Ø¶Ø±).',
    tooltipTags: 'Ø£Ø¶Ù Ø¹Ù„Ø§Ù…Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ù….',
    tooltipPin: 'ÙŠÙ‚ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø±Ù…Ø² Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡.',
    shortcutsTitle: 'Ø¹Ø¨Ø§Ø±Ø§Øª Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', addCustomShortcut: '+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¨Ø§Ø±Ø© Ù…Ø®ØµØµØ©',
    scArabic: 'Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ *', scTranslit: 'Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø­Ø±ÙÙŠ', scMeaning: 'Ø§Ù„Ù…Ø¹Ù†Ù‰', scSave: 'Ø­ÙØ¸',
    scCustomLabel: 'âœï¸ Ø¹Ø¨Ø§Ø±Ø§ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ©', scBuiltinLabel: 'ðŸ¤² Ø¹Ø¨Ø§Ø±Ø§Øª Ø¥Ø³Ù„Ø§Ù…ÙŠØ©',
    scSaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©! ðŸ¤²', scDeleted: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©',
    scInserted: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© âœ…', scTapToInsert: 'Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©',
    profileName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', profileNamePlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…...',
    createProfile: 'Ø¥Ù†Ø´Ø§Ø¡',
  }
};

// ===== STATE =====
let state = {
  lang: 'en',
  theme: 'alhambra',
  pinEnabled: false,
  pin: '',
  currentProfile: 'default',
  profiles: ['default'],
  tasks: {},        // { profileId: [ task, ... ] }
  notes: [],        // encrypted notes
  simpleNotes: {},  // { profileId: [ {id, title, content, created}, ... ] }
  simpleMode: true, // default simple
  firebaseConfig: null,
  notePassphrase: null,
  editingTaskId: null,
  noteView: 'list', // 'list' or 'grid'
};

// ===== INIT =====
function init() {
  loadState();
  // Default to simple mode for new users
  if (state.simpleMode === undefined) state.simpleMode = true;
  applySimpleMode();
  applyLang(state.lang);
  setTheme(state.theme);
  if (state.pinEnabled && state.pin) showPinLock();
  renderProfiles();
  renderTasks();
  // Set initial connection status
  updateSyncUI(false);
  // Load firebase config
  const fc = localStorage.getItem('tethkir_firebase');
  if (fc) {
    state.firebaseConfig = JSON.parse(fc);
    document.getElementById('firebaseConfigInput').value = fc;
    // Auto-load Firebase SDK and init
    loadFirebaseSDK().then(() => {
      initFirebase(state.firebaseConfig);
    }).catch(e => console.error('Firebase auto-load failed:', e));
  }
  if (state.pinEnabled) {
    document.getElementById('pinToggle').classList.add('active');
  }
  updateChangePinBtn();
  document.getElementById('appVersion').textContent = APP_VERSION;
}

function loadState() {
  try {
    const saved = localStorage.getItem('tethkir_state');
    if (saved) {
      const parsed = JSON.parse(saved);
      state = { ...state, ...parsed };
    }
    if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
  } catch(e) { console.error('Load error', e); }
}

function saveState() {
  try {
    // Exclude notePassphrase from storage for security
    const toSave = { ...state, notePassphrase: null };
    localStorage.setItem('tethkir_state', JSON.stringify(toSave));
    // Auto-sync to cloud if signed in
    if (firebaseReady && firebaseAuth?.currentUser) syncToCloud();
  } catch(e) { console.error('Save error', e); }
}

// ===== LANGUAGE =====
function applyLang(lang) {
  state.lang = lang;
  updateLangPicker(lang);
  const dir = lang === 'ar' ? 'rtl' : 'ltr';
  document.documentElement.setAttribute('lang', lang);
  document.documentElement.setAttribute('dir', dir);

  // Apply translations
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[lang] && i18n[lang][key]) {
      el.textContent = i18n[lang][key];
    }
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (i18n[lang] && i18n[lang][key]) {
      el.setAttribute('placeholder', i18n[lang][key]);
    }
  });
  saveState();
}

// ===== LANGUAGE PICKER =====
const langFlags = {
  en: '<svg width="22" height="16" viewBox="0 0 60 30"><clipPath id="ukc2"><rect width="60" height="30" rx="2"/></clipPath><g clip-path="url(#ukc2)"><rect width="60" height="30" fill="#012169"/><path d="M0,0L60,30M60,0L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0L60,30M60,0L0,30" stroke="#C8102E" stroke-width="4"/><path d="M30,0V30M0,15H60" stroke="#fff" stroke-width="10"/><path d="M30,0V30M0,15H60" stroke="#C8102E" stroke-width="6"/></g></svg>',
  fr: '<svg width="22" height="16" viewBox="0 0 60 30"><rect width="20" height="30" fill="#002395"/><rect x="20" width="20" height="30" fill="#fff"/><rect x="40" width="20" height="30" fill="#ED2939"/></svg>',
  ar: '<svg width="22" height="16" viewBox="0 0 60 30"><rect width="30" height="30" fill="#006233"/><rect x="30" width="30" height="30" fill="#fff"/><circle cx="30" cy="15" r="7" fill="#D21034"/><circle cx="32" cy="15" r="5.8" fill="#fff"/><polygon points="33.5,9.5 34.8,13 38.5,13 35.5,15.3 36.5,19 33.5,16.5 30.5,19 31.5,15.3 28.5,13 32.2,13" fill="#D21034"/></svg>'
};

function updateLangPicker(lang) {
  document.getElementById('langFlag').innerHTML = langFlags[lang] || langFlags.en;
  document.getElementById('langCode').textContent = lang.toUpperCase();
}

function toggleLangPicker() {
  document.getElementById('langPickerMenu').classList.toggle('open');
}

function selectLang(lang) {
  document.getElementById('langPickerMenu').classList.remove('open');
  applyLang(lang);
  applySimpleMode();
  renderTasks();
  updateSyncUI(firebaseAuth?.currentUser != null, firebaseAuth?.currentUser?.displayName);
}

// Close picker on outside click
document.addEventListener('click', (e) => {
  const picker = document.getElementById('langPicker');
  if (picker && !picker.contains(e.target)) {
    document.getElementById('langPickerMenu').classList.remove('open');
  }
});

// ===== THEMES =====
function setTheme(themeId) {
  state.theme = themeId;
  document.body.setAttribute('data-theme', themeId);
  document.querySelectorAll('.theme-card').forEach(c => {
    c.classList.toggle('active', c.dataset.themeid === themeId);
  });
  saveState();
}

// ===== TABS =====
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === `page-${tabName}`));
  if (tabName === 'notes' && state.simpleMode) renderSimpleNotes();
}

// ===== PROFILES =====
function switchProfile(profileId) {
  state.currentProfile = profileId;
  if (!state.tasks[profileId]) state.tasks[profileId] = [];
  renderProfiles();
  renderTasks();
  saveState();
}

function renderProfiles() {
  const bar = document.getElementById('profilesBar');
  let html = '';
  state.profiles.forEach(p => {
    const icon = 'ðŸ‘¤';
    const active = p === state.currentProfile ? 'active' : '';
    const label = p === 'default' ? (i18n[state.lang]?.defaultProfile || 'Default') :
                  p;
    html += `<button class="profile-chip ${active}" onclick="switchProfile('${p}')">${icon} ${label}</button>`;
  });
  html += `<button class="btn btn-sm" onclick="showAddProfileModal()">+ ${i18n[state.lang]?.addProfile || 'Profile'}</button>`;
  bar.innerHTML = html;
}

function showAddProfileModal() {
  const lang = state.lang;
  const t = i18n[lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>${t.addProfile}</h2>
    <div class="form-group">
      <label>${t.profileName}</label>
      <input type="text" id="newProfileName" placeholder="${t.profileNamePlaceholder}">
    </div>
    <div class="form-actions" style="margin-top:12px;">
      <button class="btn" onclick="closeModal()">${t.clear}</button>
      <button class="btn btn-accent" onclick="createProfile()">${t.createProfile}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function createProfile() {
  const name = document.getElementById('newProfileName').value.trim();
  if (!name || state.profiles.includes(name)) return;
  state.profiles.push(name);
  state.tasks[name] = [];
  switchProfile(name);
  closeModal();
  saveState();
}

function closeModal(e) {
  if (e && e.target && e.target !== document.getElementById('modalBackdrop')) return;
  document.getElementById('modalBackdrop').style.display = 'none';
}

// ===== TASKS =====
function getTasks() {
  return state.tasks[state.currentProfile] || [];
}

function addTask() {
  const title = document.getElementById('taskTitleInput').value.trim();
  if (!title) return;

  const task = {
    id: state.editingTaskId || Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    title,
    priority: document.getElementById('taskPriority').value,
    dueDate: document.getElementById('taskDueDate').value,
    category: document.getElementById('taskCategory').value,
    tags: document.getElementById('taskTags').value.split(',').map(t=>t.trim()).filter(Boolean),
    done: false,
    createdAt: new Date().toISOString(),
  };

  if (state.editingTaskId) {
    const idx = getTasks().findIndex(t => t.id === state.editingTaskId);
    if (idx >= 0) {
      task.done = getTasks()[idx].done;
      task.createdAt = getTasks()[idx].createdAt;
      state.tasks[state.currentProfile][idx] = task;
    }
    state.editingTaskId = null;
    document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.addTask || '+ Add Task';
  } else {
    if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
    state.tasks[state.currentProfile].unshift(task);
  }

  clearForm();
  saveState();
  renderTasks();
  showToast(i18n[state.lang]?.taskAdded || 'Task added! âœ¨');
}

function toggleTaskDone(id) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  task.done = !task.done;
  saveState();
  renderTasks();

  if (task.done) {
    showToast(i18n[state.lang]?.taskDone || 'Ma Shaa Allah! âœ…');
  }
}

function editTask(id) {
  const task = getTasks().find(t => t.id === id);
  if (!task) return;
  state.editingTaskId = id;
  document.getElementById('taskTitleInput').value = task.title;
  document.getElementById('taskPriority').value = task.priority;
  document.getElementById('taskDueDate').value = task.dueDate || '';
  document.getElementById('taskCategory').value = task.category;
  document.getElementById('taskTags').value = (task.tags||[]).join(', ');
  document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.editTask || 'Save Edit';
  document.getElementById('taskTitleInput').focus();
  switchTab('tasks');
}

function deleteTask(id) {
  state.tasks[state.currentProfile] = getTasks().filter(t => t.id !== id);
  saveState();
  renderTasks();
  showToast(i18n[state.lang]?.taskDeleted || 'Task deleted');
}

function clearForm() {
  document.getElementById('taskTitleInput').value = '';
  document.getElementById('taskPriority').value = 'low';
  document.getElementById('taskDueDate').value = '';
  document.getElementById('taskCategory').value = 'general';
  document.getElementById('taskTags').value = '';
  state.editingTaskId = null;
  document.getElementById('addTaskBtn').textContent = i18n[state.lang]?.addTask || '+ Add Task';
}

function renderTasks() {
  const container = document.getElementById('taskList');
  let tasks = [...getTasks()];
  const lang = state.lang;
  const t = i18n[lang];

  // Filter
  const search = document.getElementById('searchInput').value.toLowerCase();
  const fPriority = document.getElementById('filterPriority').value;
  const fCategory = document.getElementById('filterCategory').value;
  const fStatus = document.getElementById('filterStatus').value;

  if (search) tasks = tasks.filter(t => t.title.toLowerCase().includes(search) || (t.tags||[]).some(tag=>tag.toLowerCase().includes(search)));
  if (fPriority !== 'all') tasks = tasks.filter(t => t.priority === fPriority);
  if (fCategory !== 'all') tasks = tasks.filter(t => t.category === fCategory);
  if (fStatus === 'active') tasks = tasks.filter(t => !t.done);
  if (fStatus === 'done') tasks = tasks.filter(t => t.done);

  if (tasks.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ðŸ“</div>
        <h3>${t.emptyTitle}</h3>
        <p>${t.emptyDesc}</p>
      </div>`;
    return;
  }

  container.innerHTML = tasks.map(task => {
    const priorityLabel = t[task.priority] || task.priority;
    const catLabel = t['cat' + task.category.charAt(0).toUpperCase() + task.category.slice(1)] || task.category;
    const dueStr = task.dueDate ? `ðŸ“… ${task.dueDate}` : '';
    const tagsStr = (task.tags||[]).map(tg => `<span class="task-meta-item">ðŸ·ï¸ ${tg}</span>`).join('');

    return `
      <div class="task-item ${task.done?'done':''}" draggable="true" data-id="${task.id}"
        ondragstart="onDragStart(event)" ondragover="onDragOver(event)" ondrop="onDrop(event)">
        <div class="task-priority-indicator ${task.priority}"></div>
        <div class="task-checkbox ${task.done?'checked':''}" onclick="toggleTaskDone('${task.id}')">
          ${task.done ? 'âœ“' : ''}
        </div>
        <div class="task-content">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">
            <span class="task-meta-item">${priorityLabel}</span>
            <span class="task-meta-item">${catLabel}</span>
            ${dueStr ? `<span class="task-meta-item">${dueStr}</span>` : ''}
            ${tagsStr}
          </div>
        </div>
        <div class="task-actions">
          <button class="btn btn-sm btn-icon" onclick="copyTask('${task.id}')" title="Copy">ðŸ“‹</button>
          <button class="btn btn-sm btn-icon" onclick="editTask('${task.id}')" title="Edit">âœï¸</button>
          <button class="btn btn-sm btn-icon btn-danger" onclick="deleteTask('${task.id}')" title="Delete">ðŸ—‘ï¸</button>
        </div>
      </div>`;
  }).join('');
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== COPY TASK / NOTE =====
function copyTask(taskId) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  const t = i18n[state.lang];
  const priorityLabel = t[task.priority] || task.priority;
  const catLabel = t['cat' + task.category.charAt(0).toUpperCase() + task.category.slice(1)] || task.category;
  let text = task.title;
  text += `\nPriority: ${priorityLabel}`;
  text += `\nCategory: ${catLabel}`;
  if (task.dueDate) text += `\nDue: ${task.dueDate}`;
  if (task.tags && task.tags.length) text += `\nTags: ${task.tags.join(', ')}`;
  if (task.done) text += `\nStatus: âœ“ Done`;
  navigator.clipboard.writeText(text).then(() => showToast(t.copied || 'Copied! ðŸ“‹')).catch(() => showToast('Copy failed'));
}

function copyNote(noteId) {
  const note = state.notes.find(n => n.id === noteId);
  if (!note || !state.notePassphrase) return;
  try {
    const decrypted = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
    const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    const text = data.title + '\n' + data.content;
    navigator.clipboard.writeText(text).then(() => showToast(i18n[state.lang]?.copied || 'Copied! ðŸ“‹')).catch(() => showToast('Copy failed'));
  } catch(e) { showToast('Cannot copy encrypted note'); }
}

// ===== DRAG & DROP =====
let dragId = null;
function onDragStart(e) {
  dragId = e.currentTarget.dataset.id;
  e.currentTarget.classList.add('dragging');
}
function onDragOver(e) { e.preventDefault(); }
function onDrop(e) {
  e.preventDefault();
  const targetId = e.currentTarget.dataset.id;
  if (!dragId || dragId === targetId) return;
  const tasks = getTasks();
  const fromIdx = tasks.findIndex(t => t.id === dragId);
  const toIdx = tasks.findIndex(t => t.id === targetId);
  if (fromIdx < 0 || toIdx < 0) return;
  const [moved] = tasks.splice(fromIdx, 1);
  tasks.splice(toIdx, 0, moved);
  state.tasks[state.currentProfile] = tasks;
  saveState();
  renderTasks();
  document.querySelectorAll('.task-item').forEach(el => el.classList.remove('dragging'));
  dragId = null;
}

// ===== SECURE NOTES (AES) =====
function unlockNotes() {
  const pass = document.getElementById('notePassphrase').value;
  if (!pass) return;

  const hasNotes = state.notes && state.notes.length > 0;

  // If first time (no notes), require confirmation
  if (!hasNotes) {
    const confirm = document.getElementById('notePassphraseConfirm').value;
    if (!confirm) {
      document.getElementById('passMismatch').textContent = i18n[state.lang]?.enterConfirm || 'Please confirm your passphrase';
      document.getElementById('passMismatch').style.display = 'block';
      return;
    }
    if (pass !== confirm) {
      document.getElementById('passMismatch').textContent = i18n[state.lang]?.passMismatch || "Passphrases don't match";
      document.getElementById('passMismatch').style.display = 'block';
      return;
    }
  }

  // Accept any passphrase â€” each note will decrypt (or not) individually
  state.notePassphrase = pass;
  document.getElementById('notePasswordSection').style.display = 'none';
  document.getElementById('noteEditorSection').style.display = 'block';
  document.getElementById('passMismatch').style.display = 'none';
  // Clean up error hints
  const errHint = document.getElementById('passErrorHint');
  if (errHint) errHint.remove();
  renderNotes();
}

function togglePasswordVisibility(inputId, btn) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ØºÙ€';
  } else {
    input.type = 'password';
    btn.textContent = 'Ø¹Ù€';
  }
}

function lockNotes() {
  state.notePassphrase = null;
  document.getElementById('notePasswordSection').style.display = 'block';
  document.getElementById('noteEditorSection').style.display = 'none';
  document.getElementById('notePassphrase').value = '';
  document.getElementById('notePassphraseConfirm').value = '';
  document.getElementById('notePassphrase').type = 'password';
  document.getElementById('notePassphraseConfirm').type = 'password';
  document.getElementById('passMismatch').style.display = 'none';
  updateNoteCountHint();
}

function addNote() {
  const title = document.getElementById('noteTitleInput').value.trim();
  const content = document.getElementById('noteContentInput').value.trim();
  const imageData = getPreviewImageData('noteImagePreview');
  if ((!title && !content && !imageData) || !state.notePassphrase) return;

  const payload = { title: title || 'Untitled', content };
  if (imageData) payload.image = imageData;
  const encrypted = CryptoJS.AES.encrypt(JSON.stringify(payload), state.notePassphrase).toString();
  state.notes.push({ id: Date.now().toString(36), encrypted, createdAt: new Date().toISOString() });
  document.getElementById('noteTitleInput').value = '';
  document.getElementById('noteContentInput').value = '';
  removeNoteImagePreview('noteImageInput', 'noteImagePreview');
  saveState();
  renderNotes();
  cancelNewNote();
  showToast(i18n[state.lang]?.noteAdded || 'Note encrypted & saved ðŸ”');
}

function showNewNoteForm() {
  document.getElementById('newNoteForm').style.display = 'block';
  document.getElementById('showNewNoteBtn').style.display = 'none';
  document.getElementById('noteTitleInput').focus();
}

function cancelNewNote() {
  document.getElementById('newNoteForm').style.display = 'none';
  document.getElementById('showNewNoteBtn').style.display = 'block';
  document.getElementById('noteTitleInput').value = '';
  document.getElementById('noteContentInput').value = '';
  removeNoteImagePreview('noteImageInput', 'noteImagePreview');
}

function deleteNote(id) {
  state.notes = state.notes.filter(n => n.id !== id);
  saveState();
  renderNotes();
}

function renderNotes() {
  const container = document.getElementById('notesList');
  if (!state.notePassphrase || !state.notes.length) {
    document.getElementById('secureNotesToolbar').innerHTML = '';
    container.innerHTML = '<div class="empty-state"><div class="icon">ðŸ”</div><p>No notes yet</p></div>';
    return;
  }

  const t = i18n[state.lang] || i18n.en;

  // Decrypt all notes first
  let decryptedNotes = [];
  let lockedNotes = [];

  state.notes.forEach(note => {
    try {
      const decrypted = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
      const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
      decryptedNotes.push({ ...note, data });
    } catch(e) {
      lockedNotes.push(note);
    }
  });

  renderNotesToolbar('secureNotesToolbar', secureNotesSearch, 'searchSecureNotes', decryptedNotes.length + lockedNotes.length);

  // Filter decrypted notes by search
  let filtered = decryptedNotes;
  if (secureNotesSearch) {
    filtered = filtered.filter(n =>
      (n.data.title || '').toLowerCase().includes(secureNotesSearch) ||
      (n.data.content || '').toLowerCase().includes(secureNotesSearch)
    );
  }

  // Paginate
  const total = filtered.length;
  const visible = filtered.slice(0, secureNotesPage * NOTES_PER_PAGE);
  const hasMore = visible.length < total;
  const loadMoreLabels = { en: `Load more (${total - visible.length} remaining)`, fr: `Voir plus (${total - visible.length} restantes)`, ar: `ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ (${total - visible.length} Ù…ØªØ¨Ù‚ÙŠØ©)` };

  let html = '';

  if (filtered.length === 0 && secureNotesSearch) {
    html = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">ðŸ” No matching notes</div>';
  } else if (state.noteView === 'grid') {
    html += '<div class="notes-grid">';
    visible.forEach(n => {
      const d = n.data;
      html += `<div class="note-grid-card" onclick="toggleNoteExpand(this)">
        ${d.image ? `<img class="grid-thumb" src="${d.image}">` : ''}
        <h4>${escapeHtml(d.title)}</h4>
        <small>${formatNoteDate(n.createdAt)}</small>
        <div class="note-body">
          ${d.content ? `<p style="color:var(--text-secondary);font-size:0.85em;margin-top:6px;white-space:pre-wrap;">${escapeHtml(d.content)}</p>` : ''}
          ${d.image ? `<div style="margin-top:6px;"><img src="${d.image}" style="max-width:100%;border-radius:6px;cursor:pointer;" onclick="event.stopPropagation();openImageFullscreen(this.src)"></div>` : ''}
          <div class="grid-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation();copyNote('${n.id}')" title="Copy">ðŸ“‹</button>
            <button class="btn btn-sm" onclick="event.stopPropagation();speakNote('${n.id}')" title="Listen">ðŸ”Š</button>
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteNote('${n.id}')">ðŸ—‘ï¸</button>
          </div>
        </div>
      </div>`;
    });
    html += '</div>';
  } else {
    // List view â€” collapsible
    visible.forEach(n => {
      const d = n.data;
      html += `<div class="note-item note-collapsible" onclick="toggleNoteExpand(this)">
        <div class="note-header">
          <div style="flex:1;min-width:0;">
            <strong>${escapeHtml(d.title)}</strong>
            <br><small style="color:var(--text-secondary);opacity:0.6;font-size:0.8em;">${formatNoteDate(n.createdAt)}</small>
          </div>
          <span class="note-chevron">â–¶</span>
        </div>
        <div class="note-body">
          ${d.content ? `<p style="color:var(--text-secondary);font-size:0.9em;margin-top:8px;white-space:pre-wrap;">${escapeHtml(d.content)}</p>` : ''}
          ${d.image ? `<div style="margin:8px 0;"><img src="${d.image}" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid var(--border);cursor:pointer;" onclick="event.stopPropagation();openImageFullscreen(this.src)"></div>` : ''}
          <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:8px;">
            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation();copyNote('${n.id}')" title="Copy">ðŸ“‹</button>
            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation();speakNote('${n.id}')" title="Listen">ðŸ”Š</button>
            <button class="btn btn-sm btn-icon btn-danger" onclick="event.stopPropagation();deleteNote('${n.id}')">ðŸ—‘ï¸</button>
          </div>
        </div>
      </div>`;
    });
  }

  if (hasMore) {
    html += `<button class="notes-load-more" onclick="loadMoreSecureNotes()">${loadMoreLabels[state.lang] || loadMoreLabels.en}</button>`;
  }

  // Show locked notes section
  if (lockedNotes.length > 0) {
    const lockedLabels = {
      en: `Locked with a different passphrase (${lockedNotes.length})`,
      fr: `VerrouillÃ©es avec un autre mot de passe (${lockedNotes.length})`,
      ar: `Ù…Ù‚ÙÙ„Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø®Ø±Ù‰ (${lockedNotes.length})`
    };
    const tryLabels = { en: 'ðŸ”‘ Unlock with another passphrase', fr: 'ðŸ”‘ DÃ©verrouiller avec un autre mot de passe', ar: 'ðŸ”‘ ÙØªØ­ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø®Ø±Ù‰' };
    html += `<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
      <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:10px;">ðŸ”’ ${lockedLabels[state.lang] || lockedLabels.en}</p>`;
    lockedNotes.forEach(note => {
      const dateStr = note.createdAt ? formatNoteDate(note.createdAt) : 'â€”';
      html += `<div class="note-item" style="opacity:0.6;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="color:var(--text-secondary);font-size:0.9em;">ðŸ”’ ${dateStr}</span>
          <button class="btn btn-sm btn-icon btn-danger" onclick="deleteNote('${note.id}')">ðŸ—‘ï¸</button>
        </div>
      </div>`;
    });
    html += `<button class="btn" style="width:100%;margin-top:8px;" onclick="showTryOtherPassphraseModal()">${tryLabels[state.lang] || tryLabels.en}</button>`;
    html += `</div>`;
  }

  if (!html) {
    html = '<div class="empty-state"><div class="icon">ðŸ”</div><p>No notes yet</p></div>';
  }

  container.innerHTML = html;
}

// ===== PIN LOCK =====
function togglePinSetting() {
  const toggle = document.getElementById('pinToggle');
  const area = document.getElementById('pinSetupArea');
  state.pinEnabled = !state.pinEnabled;
  toggle.classList.toggle('active', state.pinEnabled);
  area.style.display = state.pinEnabled ? 'block' : 'none';
  if (!state.pinEnabled) { state.pin = ''; }
  saveState();
  updateChangePinBtn();
}

function savePin() {
  const pin = document.getElementById('pinSetInput').value;
  if (pin.length !== 4 || !/^\d{4}$/.test(pin)) return;
  state.pin = CryptoJS.SHA256(pin).toString();
  document.getElementById('pinSetInput').value = '';
  saveState();
  updateChangePinBtn();
  showToast('PIN saved! ðŸ”’');
}

function updateChangePinBtn() {
  const btn = document.getElementById('changePinBtn');
  if (state.pin && state.pinEnabled) {
    btn.style.display = 'inline-flex';
  } else {
    btn.style.display = 'none';
  }
}

function showPinLock() {
  document.getElementById('pinOverlay').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
  const digits = document.querySelectorAll('.pin-digit');
  digits.forEach((d, i) => {
    d.value = '';
    d.addEventListener('input', (e) => {
      if (e.target.value && i < 3) digits[i+1].focus();
      if (i === 3 && e.target.value) checkPin();
    });
    d.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !d.value && i > 0) digits[i-1].focus();
    });
  });
  setTimeout(() => digits[0].focus(), 100);
}

function checkPin() {
  const digits = document.querySelectorAll('.pin-digit');
  const entered = [...digits].map(d => d.value).join('');
  if (entered.length !== 4) return;
  const hash = CryptoJS.SHA256(entered).toString();
  if (hash === state.pin) {
    document.getElementById('pinOverlay').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
  } else {
    document.getElementById('pinError').textContent = i18n[state.lang]?.wrongPin || 'Wrong PIN';
    document.getElementById('pinError').style.display = 'block';
    digits.forEach(d => d.value = '');
    digits[0].focus();
  }
}

// ===== IMPORT / EXPORT =====
function exportData() {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    state: { ...state, notePassphrase: null }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tethkir-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(i18n[state.lang]?.dataExported || 'Data exported! ðŸ“¦');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.state) {
        state = { ...state, ...data.state, notePassphrase: null };
        saveState();
        applyLang(state.lang);
        setTheme(state.theme);
        renderProfiles();
        renderTasks();
              showToast(i18n[state.lang]?.dataImported || 'Data imported! âœ…');
      }
    } catch(err) { showToast('Invalid file âŒ'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

async function manualSync() {
  if (!firebaseReady || !firebaseAuth?.currentUser) {
    showToast(i18n[state.lang]?.syncNotSignedIn || 'Sign in to Firebase first â˜ï¸');
    return;
  }
  const t = i18n[state.lang] || i18n.en;
  showToast(t.syncing || 'Syncing...');
  try {
    await syncToCloud();
    await syncFromCloud();
    showToast(t.syncDone || 'Sync complete! âœ…');
  } catch(e) {
    console.error('Manual sync error:', e);
    showToast(t.syncError || 'Sync failed âŒ');
  }
}

function clearAllData() {
  const t = i18n[state.lang] || i18n.en;
  const msg = t.clearAllConfirm || 'This will delete ALL your tasks, notes, profiles, and settings. This cannot be undone!\n\nAre you sure?';
  if (!confirm(msg)) return;
  // Sign out of Firebase if connected
  if (firebaseAuth?.currentUser) {
    firebaseAuth.signOut();
  }
  // Clear all localStorage
  localStorage.removeItem('tethkir_state');
  localStorage.removeItem('tethkir_firebase');
  localStorage.removeItem('tethkir_custom_shortcuts');
  // Reload the page to reset everything
  showToast(t.clearAllDone || 'All data cleared! ðŸ—‘ï¸');
  setTimeout(() => location.reload(), 800);
}

// ===== FIREBASE =====
let firebaseReady = false;
let firebaseAuth = null;
let firebaseDb = null;
let syncInProgress = false;

function loadFirebaseSDK() {
  return new Promise((resolve, reject) => {
    if (firebaseReady) { resolve(); return; }
    if (typeof firebase !== 'undefined' && firebase.apps) { resolve(); return; }
    const scripts = [
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js',
      'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js'
    ];
    let loaded = 0;
    scripts.forEach(src => {
      if (document.querySelector('script[src="' + src + '"]')) {
        loaded++; if (loaded === scripts.length) resolve(); return;
      }
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => { loaded++; if (loaded === scripts.length) resolve(); };
      s.onerror = () => reject(new Error('Failed to load Firebase SDK'));
      document.head.appendChild(s);
    });
  });
}

function initFirebase(config) {
  try {
    if (typeof firebase === 'undefined') return;
    if (firebase.apps && firebase.apps.length) {
      // Already initialized â€” just grab references
      firebaseAuth = firebase.auth();
      firebaseDb = firebase.firestore();
      firebaseReady = true;
      setupAuthListener();
      return;
    }
    firebase.initializeApp(config);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.firestore();
    firebaseReady = true;
    setupAuthListener();
  } catch(e) { console.error('Firebase init error:', e); }
}

function setupAuthListener() {
  // Handle redirect result (for iOS Safari sign-in)
  firebaseAuth.getRedirectResult().then(result => {
    if (result && result.user) {
      showToast('Welcome, ' + result.user.displayName + '! â˜ï¸');
    }
  }).catch(e => {
    if (e.code !== 'auth/no-auth-event') {
      console.error('Redirect result error:', e);
    }
  });

  firebaseAuth.onAuthStateChanged(user => {
    if (user) {
      updateSyncUI(true, user.displayName);
      syncFromCloud();
    } else {
      updateSyncUI(false);
    }
  });
}

function updateSyncUI(firebaseOnline, name) {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  const btn = document.getElementById('authBtn');
  const lang = state.lang || 'en';
  const hasInternet = navigator.onLine;

  if (firebaseOnline && hasInternet) {
    dot.className = 'sync-dot online';
    label.textContent = name || (i18n[lang]?.synced || 'Synced');
    btn.textContent = i18n[lang]?.signOut || 'â˜ï¸ Sign Out';
  } else if (hasInternet) {
    dot.className = 'sync-dot warning';
    label.textContent = i18n[lang]?.online || 'Online';
    btn.textContent = i18n[lang]?.signIn || 'â˜ï¸ Sign In';
  } else {
    dot.className = 'sync-dot offline';
    label.textContent = i18n[lang]?.offline || 'Offline';
    btn.textContent = i18n[lang]?.signIn || 'â˜ï¸ Sign In';
  }
}

// Listen for internet connectivity changes
window.addEventListener('online', () => updateSyncUI(firebaseAuth?.currentUser != null, firebaseAuth?.currentUser?.displayName));
window.addEventListener('offline', () => updateSyncUI(false));

async function syncToCloud() {
  if (!firebaseReady || !firebaseAuth?.currentUser) return;
  if (syncInProgress) return;
  syncInProgress = true;
  try {
    const user = firebaseAuth.currentUser;
    await firebaseDb.collection('users').doc(user.uid).set({
      tasks: state.tasks,
      profiles: state.profiles,
      notes: state.notes,
      theme: state.theme,
      lang: state.lang,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log('âœ… Synced to cloud');
  } catch(e) {
    console.error('Sync to cloud error:', e);
    showToast('Sync error â€” check console');
  } finally {
    syncInProgress = false;
  }
}

async function syncFromCloud() {
  if (!firebaseReady || !firebaseAuth?.currentUser) return;
  try {
    const user = firebaseAuth.currentUser;
    const doc = await firebaseDb.collection('users').doc(user.uid).get();
    if (doc.exists) {
      const data = doc.data();
      state.tasks = data.tasks || state.tasks;
      state.profiles = data.profiles || state.profiles;
      state.notes = data.notes || state.notes;
      if (data.theme) { state.theme = data.theme; setTheme(data.theme); }
      if (data.lang) { state.lang = data.lang; applyLang(data.lang); }
      if (!state.tasks[state.currentProfile]) state.tasks[state.currentProfile] = [];
      const toSave = { ...state, notePassphrase: null };
      localStorage.setItem('tethkir_state', JSON.stringify(toSave));
      renderProfiles();
      renderTasks();
          updateNoteCountHint();
      showToast('â˜ï¸ Synced from cloud!');
    } else {
      await syncToCloud();
      showToast('â˜ï¸ Data uploaded to cloud!');
    }
  } catch(e) {
    console.error('Sync from cloud error:', e);
    showToast('Cloud fetch error â€” check console');
  }
}

function saveFirebaseConfig() {
  const val = document.getElementById('firebaseConfigInput').value.trim();
  try {
    const config = JSON.parse(val);
    state.firebaseConfig = config;
    localStorage.setItem('tethkir_firebase', val);
    saveState();
    showToast('Firebase config saved! Loading SDK... â˜ï¸');
    loadFirebaseSDK().then(() => {
      initFirebase(config);
      showToast('Firebase ready! Click Sign In â˜ï¸');
    }).catch(e => {
      showToast('Failed to load Firebase SDK âŒ');
      console.error(e);
    });
  } catch(e) { showToast('Invalid JSON âŒ'); }
}

function clearFirebaseConfig() {
  if (firebaseAuth?.currentUser) firebaseAuth.signOut();
  state.firebaseConfig = null;
  firebaseReady = false;
  firebaseAuth = null;
  firebaseDb = null;
  localStorage.removeItem('tethkir_firebase');
  document.getElementById('firebaseConfigInput').value = '';
  saveState();
  updateSyncUI(false);
  showToast('Firebase config cleared');
}

function toggleAuth() {
  if (!state.firebaseConfig) {
    showToast('Set Firebase config in Settings first â˜ï¸');
    toggleSettingsSidebar();
    return;
  }
  if (!firebaseReady) {
    showToast('Loading Firebase...');
    loadFirebaseSDK().then(() => {
      initFirebase(state.firebaseConfig);
      doSignIn();
    }).catch(() => showToast('Failed to load Firebase SDK âŒ'));
    return;
  }
  if (firebaseAuth?.currentUser) {
    firebaseAuth.signOut().then(() => {
      updateSyncUI(false);
      showToast('Signed out â˜ï¸');
    });
  } else {
    doSignIn();
  }
}

async function doSignIn() {
  try {
    // Guard: ensure auth module is ready
    if (!firebase.auth || !firebase.auth.GoogleAuthProvider) {
      showToast('Firebase auth not ready â€” try again');
      return;
    }
    const provider = new firebase.auth.GoogleAuthProvider();

    // iOS Safari doesn't support popups well â€” use redirect
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (isIOS || (isSafari && 'ontouchstart' in window)) {
      await firebaseAuth.signInWithRedirect(provider);
    } else {
      const result = await firebaseAuth.signInWithPopup(provider);
      showToast('Welcome, ' + result.user.displayName + '! â˜ï¸');
    }
  } catch(e) {
    if (e.code === 'auth/popup-closed-by-user') {
      showToast('Sign-in cancelled');
    } else if (e.code === 'auth/unauthorized-domain') {
      showToast('Add this domain to Firebase Authorized Domains âš ï¸');
    } else {
      console.error('Sign-in error:', e);
      showToast('Sign-in failed: ' + e.message);
    }
  }
}

// ===== TOAST =====
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ===== KEYBOARD SHORTCUT =====
document.getElementById('taskTitleInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') addTask();
});

document.getElementById('notePassphrase').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const hasNotes = state.notes && state.notes.length > 0;
    if (hasNotes) unlockNotes();
    else document.getElementById('notePassphraseConfirm').focus();
  }
});

document.getElementById('notePassphraseConfirm').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') unlockNotes();
});

// ===== HELP WIDGET =====
let helpOpen = false;

function toggleHelp() {
  helpOpen = !helpOpen;
  document.getElementById('helpPanel').classList.toggle('open', helpOpen);
  document.getElementById('helpToggleBtn').classList.toggle('active', helpOpen);
  document.body.classList.toggle('help-open', helpOpen);
  document.getElementById('helpToggleBtn').textContent = helpOpen ? 'â“ â–¾' : 'â“';
}

function toggleAccordion(header) {
  const body = header.nextElementSibling;
  const isOpen = body.classList.contains('open');

  // Close all other accordions (optional â€” remove for multi-open)
  // document.querySelectorAll('.help-accordion-body.open').forEach(b => b.classList.remove('open'));
  // document.querySelectorAll('.help-accordion-header.active').forEach(h => h.classList.remove('active'));

  header.classList.toggle('active', !isOpen);
  body.classList.toggle('open', !isOpen);
}

function toggleSettingsSection(header) {
  const body = header.nextElementSibling;
  const isOpen = body.classList.contains('open');
  header.classList.toggle('open', !isOpen);
  body.classList.toggle('open', !isOpen);
}

function toggleSettingsSidebar() {
  document.getElementById('settingsBackdrop').classList.toggle('open');
  document.getElementById('settingsSidebar').classList.toggle('open');
}

// ===== SIMPLE MODE =====
function toggleSimpleMode() {
  state.simpleMode = !state.simpleMode;
  applySimpleMode();
  saveState();
}

function applySimpleMode() {
  const on = state.simpleMode !== false; // default true
  document.body.classList.toggle('simple-mode', on);
  const toggle = document.getElementById('simpleModeToggle');
  if (toggle) toggle.classList.toggle('active', on);
  // Update mode label & description
  const t = i18n[state.lang] || i18n.en;
  const modeLabel = document.querySelector('[data-i18n="modeLabel"]');
  if (modeLabel) modeLabel.textContent = on ? (t.modeLabel || 'Simple Mode') : (t.modeLabelAdvanced || 'Advanced Mode');
  const modeDesc = document.querySelector('[data-i18n="modeDesc"]');
  if (modeDesc) modeDesc.textContent = on ? (t.modeDesc || 'Hide advanced features (profiles, filters, encryption)') : (t.modeDescAdvanced || 'Profiles, filters, encrypted notes, Arabic keyboard enabled');
  // Update notes tab label
  const notesTab = document.querySelector('[data-tab="notes"] span');
  if (notesTab) {
    notesTab.textContent = on ? (t.tabNotesSimple || 'Notes') : (t.tabNotes || 'Secure Notes');
  }
  if (on) renderSimpleNotes();
}

// ===== NOTE IMAGE UTILITIES =====
function compressImage(file, maxWidth, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function previewNoteImage(input, previewId) {
  const preview = document.getElementById(previewId);
  const removeBtn = document.getElementById(input.id === 'simpleNoteImageInput' ? 'simpleNoteRemoveImg' : 'noteRemoveImg');
  if (!input.files || !input.files[0]) { preview.innerHTML = ''; removeBtn.style.display = 'none'; return; }
  compressImage(input.files[0], 800, 0.7).then(dataUrl => {
    preview.innerHTML = `<img src="${dataUrl}" style="max-width:100%;max-height:200px;border-radius:8px;border:1px solid var(--border);">`;
    preview.dataset.imageData = dataUrl;
    removeBtn.style.display = 'inline-block';
    // Check size warning
    const sizeKB = Math.round(dataUrl.length * 3 / 4 / 1024);
    if (sizeKB > 500) {
      preview.innerHTML += `<p style="color:var(--danger);font-size:0.8em;margin-top:4px;">âš ï¸ Image is ${sizeKB}KB â€” large images may fill up storage</p>`;
    }
  }).catch(() => {
    preview.innerHTML = '<p style="color:var(--danger);font-size:0.85em;">âŒ Could not load image</p>';
  });
}

function removeNoteImagePreview(inputId, previewId) {
  document.getElementById(inputId).value = '';
  const preview = document.getElementById(previewId);
  preview.innerHTML = '';
  delete preview.dataset.imageData;
  const removeBtn = document.getElementById(inputId === 'simpleNoteImageInput' ? 'simpleNoteRemoveImg' : 'noteRemoveImg');
  removeBtn.style.display = 'none';
}

function openImageFullscreen(src) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:99999;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:20px;';
  overlay.innerHTML = `<img src="${src}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;">`;
  overlay.onclick = () => overlay.remove();
  document.body.appendChild(overlay);
}

function getPreviewImageData(previewId) {
  const preview = document.getElementById(previewId);
  return preview.dataset.imageData || null;
}

function addSimpleNote() {
  const title = document.getElementById('simpleNoteTitleInput').value.trim();
  const content = document.getElementById('simpleNoteContentInput').value.trim();
  const imageData = getPreviewImageData('simpleNoteImagePreview');
  if (!title && !content && !imageData) { showToast('Write something first!'); return; }
  if (!state.simpleNotes) state.simpleNotes = {};
  if (!state.simpleNotes[state.currentProfile]) state.simpleNotes[state.currentProfile] = [];
  state.simpleNotes[state.currentProfile].push({
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    title: title || 'Untitled',
    content: content,
    image: imageData || null,
    created: Date.now()
  });
  document.getElementById('simpleNoteTitleInput').value = '';
  document.getElementById('simpleNoteContentInput').value = '';
  removeNoteImagePreview('simpleNoteImageInput', 'simpleNoteImagePreview');
  saveState();
  renderSimpleNotes();
  const t = i18n[state.lang] || i18n.en;
  showToast(t.noteSaved || 'Note saved! âœ…');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== NOTES VIEW SYSTEM =====
var simpleNotesPage = 1;
var secureNotesPage = 1;
var simpleNotesSearch = '';
var secureNotesSearch = '';
const NOTES_PER_PAGE = 10;

function renderNotesToolbar(containerId, searchVar, onSearchFn, noteCount) {
  const container = document.getElementById(containerId);
  if (!container) return;
  if (noteCount === 0) { container.innerHTML = ''; return; }
  const t = i18n[state.lang] || i18n.en;
  const searchPlaceholders = { en: 'ðŸ” Search notes...', fr: 'ðŸ” Rechercher...', ar: 'ðŸ” Ø¨Ø­Ø«...' };
  container.innerHTML = `
    <div class="notes-toolbar">
      <input type="text" class="notes-search" placeholder="${searchPlaceholders[state.lang] || searchPlaceholders.en}" value="${searchVar}" oninput="${onSearchFn}(this.value)">
      <div class="view-toggle">
        <button onclick="setNoteView('list')" class="${state.noteView === 'list' ? 'active' : ''}" title="List">ðŸ“„</button>
        <button onclick="setNoteView('grid')" class="${state.noteView === 'grid' ? 'active' : ''}" title="Grid">ðŸ“</button>
      </div>
    </div>`;
}

function setNoteView(view) {
  state.noteView = view;
  simpleNotesPage = 1;
  secureNotesPage = 1;
  saveState();
  if (state.simpleMode) renderSimpleNotes();
  else renderNotes();
}

function searchSimpleNotes(query) {
  simpleNotesSearch = query.toLowerCase();
  simpleNotesPage = 1;
  renderSimpleNotes();
}

function searchSecureNotes(query) {
  secureNotesSearch = query.toLowerCase();
  secureNotesPage = 1;
  renderNotes();
}

function toggleNoteExpand(el) {
  el.classList.toggle('expanded');
}

function loadMoreSimpleNotes() {
  simpleNotesPage++;
  renderSimpleNotes();
}

function loadMoreSecureNotes() {
  secureNotesPage++;
  renderNotes();
}

function formatNoteDate(ts) {
  const d = ts instanceof Date ? ts : new Date(ts);
  const locale = state.lang === 'ar' ? 'ar' : state.lang === 'fr' ? 'fr' : 'en';
  return d.toLocaleDateString(locale, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function renderSimpleNotes() {
  const container = document.getElementById('simpleNotesList');
  if (!container) return;
  const allNotes = (state.simpleNotes && state.simpleNotes[state.currentProfile]) || [];

  renderNotesToolbar('simpleNotesToolbar', simpleNotesSearch, 'searchSimpleNotes', allNotes.length);

  if (allNotes.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px 10px;color:var(--text-secondary);"><div style="font-size:2em;margin-bottom:8px;">ðŸ“</div><p data-i18n="noNotesYet"><b>No notes yet!</b></p></div>';
    return;
  }

  // Filter
  let notes = allNotes;
  if (simpleNotesSearch) {
    notes = notes.filter(n =>
      (n.title || '').toLowerCase().includes(simpleNotesSearch) ||
      (n.content || '').toLowerCase().includes(simpleNotesSearch)
    );
  }

  if (notes.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">ðŸ” No matching notes</div>';
    return;
  }

  // Paginate
  const total = notes.length;
  const visible = notes.slice(0, simpleNotesPage * NOTES_PER_PAGE);
  const hasMore = visible.length < total;
  const loadMoreLabels = { en: `Load more (${total - visible.length} remaining)`, fr: `Voir plus (${total - visible.length} restantes)`, ar: `ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ (${total - visible.length} Ù…ØªØ¨Ù‚ÙŠØ©)` };

  let html = '';

  if (state.noteView === 'grid') {
    html += '<div class="notes-grid">';
    visible.forEach(n => {
      html += `<div class="note-grid-card" onclick="toggleNoteExpand(this)">
        ${n.image ? `<img class="grid-thumb" src="${n.image}">` : ''}
        <h4>${escHtml(n.title)}</h4>
        <small>${formatNoteDate(n.created)}</small>
        <div class="note-body">
          ${n.content ? `<p style="color:var(--text-secondary);font-size:0.85em;margin-top:6px;white-space:pre-wrap;">${escHtml(n.content)}</p>` : ''}
          ${n.image ? `<div style="margin-top:6px;"><img src="${n.image}" style="max-width:100%;border-radius:6px;cursor:pointer;" onclick="event.stopPropagation();openImageFullscreen(this.src)"></div>` : ''}
          <div class="grid-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation();copySimpleNote('${n.id}')" title="Copy">ðŸ“‹</button>
            <button class="btn btn-sm" onclick="event.stopPropagation();speakSimpleNote('${n.id}')" title="Read aloud">ðŸ”Š</button>
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteSimpleNote('${n.id}')">ðŸ—‘ï¸</button>
          </div>
        </div>
      </div>`;
    });
    html += '</div>';
  } else {
    // List view â€” collapsible
    visible.forEach(n => {
      html += `<div class="simple-note-card note-collapsible" onclick="toggleNoteExpand(this)">
        <div class="note-header">
          <div style="flex:1;min-width:0;">
            <h4 style="margin:0;">${escHtml(n.title)}</h4>
            <small style="color:var(--text-secondary);opacity:0.6;font-size:0.8em;">${formatNoteDate(n.created)}</small>
          </div>
          <span class="note-chevron">â–¶</span>
        </div>
        <div class="note-body">
          ${n.content ? `<p style="margin-top:8px;">${escHtml(n.content)}</p>` : ''}
          ${n.image ? `<div style="margin:8px 0;"><img src="${n.image}" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid var(--border);cursor:pointer;" onclick="event.stopPropagation();openImageFullscreen(this.src)"></div>` : ''}
          <div class="simple-note-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation();copySimpleNote('${n.id}')" title="Copy">ðŸ“‹</button>
            <button class="btn btn-sm" onclick="event.stopPropagation();speakSimpleNote('${n.id}')" title="Read aloud">ðŸ”Š</button>
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteSimpleNote('${n.id}')">ðŸ—‘ï¸</button>
          </div>
        </div>
      </div>`;
    });
  }

  if (hasMore) {
    html += `<button class="notes-load-more" onclick="loadMoreSimpleNotes()">${loadMoreLabels[state.lang] || loadMoreLabels.en}</button>`;
  }

  container.innerHTML = html;
}

function deleteSimpleNote(id) {
  if (!state.simpleNotes || !state.simpleNotes[state.currentProfile]) return;
  state.simpleNotes[state.currentProfile] = state.simpleNotes[state.currentProfile].filter(n => n.id !== id);
  saveState();
  renderSimpleNotes();
}

function copySimpleNote(id) {
  const notes = (state.simpleNotes && state.simpleNotes[state.currentProfile]) || [];
  const note = notes.find(n => n.id === id);
  if (!note) return;
  const text = note.title + '\n' + note.content;
  navigator.clipboard.writeText(text).then(() => {
    showToast(i18n[state.lang]?.copied || 'Copied! ðŸ“‹');
  }).catch(() => {
    showToast('Copy failed â€” try long-press to select');
  });
}

function speakSimpleNote(id) {
  const notes = (state.simpleNotes && state.simpleNotes[state.currentProfile]) || [];
  const note = notes.find(n => n.id === id);
  if (!note) return;
  if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); return; }
  const text = note.title + '. ' + note.content;
  const utter = new SpeechSynthesisUtterance(text);
  const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
  utter.lang = langMap[state.lang] || 'en-US';
  window.speechSynthesis.speak(utter);
}

function filterHelp() {
  const query = document.getElementById('helpSearch').value.toLowerCase().trim();
  const items = document.querySelectorAll('.help-accordion, .help-tip-card');

  items.forEach(item => {
    if (!query) {
      item.style.display = '';
      return;
    }
    const keywords = (item.dataset.helpKeywords || '').toLowerCase();
    const text = item.textContent.toLowerCase();
    const match = keywords.includes(query) || text.includes(query);
    item.style.display = match ? '' : 'none';
  });

  // Show/hide section labels based on visible children
  document.querySelectorAll('.help-section-label').forEach(label => {
    if (!query) { label.style.display = ''; return; }
    let next = label.nextElementSibling;
    let hasVisible = false;
    while (next && !next.classList.contains('help-section-label')) {
      if (next.style.display !== 'none') hasVisible = true;
      next = next.nextElementSibling;
    }
    label.style.display = hasVisible ? '' : 'none';
  });
}

// ===== CHANGE PASSPHRASE =====
function showChangePassphraseModal() {
  const t = i18n[state.lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>ðŸ”‘ ${t.changePassphrase || 'Change Passphrase'}</h2>
    <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:16px;">${t.changePassDesc || 'All notes will be re-encrypted with the new passphrase.'}</p>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.currentPassphrase || 'Current Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpOldPass" placeholder="${t.passphrasePlaceholder || 'Enter current passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpOldPass', this)">Ø¹Ù€</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.newPassphrase || 'New Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpNewPass" placeholder="${t.newPassPlaceholder || 'Enter new passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpNewPass', this)">Ø¹Ù€</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.confirmNewPassphrase || 'Confirm New Passphrase'}</label>
      <div class="password-wrapper">
        <input type="password" id="cpConfirmPass" placeholder="${t.confirmPassphrasePlaceholder || 'Re-enter new passphrase'}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpConfirmPass', this)">Ø¹Ù€</button>
      </div>
    </div>
    <p id="cpError" style="color:var(--danger);font-size:0.85em;display:none;margin-bottom:10px;"></p>
    <div class="form-actions">
      <button class="btn" onclick="closeModal()">${t.cancel || 'Cancel'}</button>
      <button class="btn btn-accent" onclick="changePassphrase()">ðŸ” ${t.confirmChange || 'Change & Re-encrypt'}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function changePassphrase() {
  const t = i18n[state.lang];
  const oldPass = document.getElementById('cpOldPass').value;
  const newPass = document.getElementById('cpNewPass').value;
  const confirmPass = document.getElementById('cpConfirmPass').value;
  const errEl = document.getElementById('cpError');

  // Validate current passphrase
  if (!oldPass) {
    errEl.textContent = t.enterCurrent || 'Enter your current passphrase';
    errEl.style.display = 'block';
    return;
  }

  // Verify old passphrase can decrypt
  if (state.notes.length > 0) {
    try {
      const test = CryptoJS.AES.decrypt(state.notes[0].encrypted, oldPass);
      const result = test.toString(CryptoJS.enc.Utf8);
      if (!result) throw new Error();
      JSON.parse(result);
    } catch(e) {
      errEl.textContent = t.wrongPassphrase || 'âŒ Current passphrase is wrong';
      errEl.style.display = 'block';
      return;
    }
  }

  // Validate new passphrase
  if (!newPass) {
    errEl.textContent = t.enterNew || 'Enter a new passphrase';
    errEl.style.display = 'block';
    return;
  }

  if (newPass.length < 3) {
    errEl.textContent = t.passTooShort || 'Passphrase must be at least 3 characters';
    errEl.style.display = 'block';
    return;
  }

  if (newPass !== confirmPass) {
    errEl.textContent = t.passMismatch || "Passphrases don't match";
    errEl.style.display = 'block';
    return;
  }

  if (oldPass === newPass) {
    errEl.textContent = t.passSameAsOld || 'New passphrase must be different from current';
    errEl.style.display = 'block';
    return;
  }

  // Re-encrypt all notes
  try {
    const reEncrypted = state.notes.map(note => {
      const decrypted = CryptoJS.AES.decrypt(note.encrypted, oldPass);
      const data = decrypted.toString(CryptoJS.enc.Utf8);
      JSON.parse(data); // validate
      const newEncrypted = CryptoJS.AES.encrypt(data, newPass).toString();
      return { ...note, encrypted: newEncrypted };
    });

    state.notes = reEncrypted;
    state.notePassphrase = newPass;
    saveState();
    renderNotes();
    closeModal();
    showToast(t.passChanged || 'Passphrase changed! All notes re-encrypted ðŸ”');
  } catch(e) {
    errEl.textContent = t.reEncryptError || 'âŒ Error re-encrypting. Some notes may use a different passphrase.';
    errEl.style.display = 'block';
  }
}

// ===== TRY OTHER PASSPHRASE (recover locked notes) =====
function showTryOtherPassphraseModal() {
  const t = i18n[state.lang] || i18n.en;
  const labels = {
    en: { title: 'ðŸ”‘ Unlock Locked Notes', desc: 'Enter the passphrase used for the locked notes. If correct, they will be re-encrypted with your current passphrase.', label: 'Other Passphrase', placeholder: 'Enter the other passphrase', btn: 'ðŸ”“ Try & Recover' },
    fr: { title: 'ðŸ”‘ DÃ©verrouiller les notes', desc: 'Entrez le mot de passe utilisÃ© pour les notes verrouillÃ©es. Si correct, elles seront re-chiffrÃ©es avec votre mot de passe actuel.', label: 'Autre mot de passe', placeholder: 'Entrez l\'autre mot de passe', btn: 'ðŸ”“ Essayer & RÃ©cupÃ©rer' },
    ar: { title: 'ðŸ”‘ ÙØªØ­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©', desc: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµØ­ÙŠØ­Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ÙÙŠØ±Ù‡Ø§ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.', label: 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø®Ø±Ù‰', placeholder: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø®Ø±Ù‰', btn: 'ðŸ”“ Ø¬Ø±Ø¨ ÙˆØ§Ø³ØªØ¹Ø¯' }
  };
  const l = labels[state.lang] || labels.en;

  document.getElementById('modalContent').innerHTML = `
    <h2>${l.title}</h2>
    <p style="color:var(--text-secondary);font-size:0.85em;margin-bottom:16px;">${l.desc}</p>
    <div class="form-group">
      <label>${l.label}</label>
      <div class="password-wrapper">
        <input type="password" id="tryOtherPass" placeholder="${l.placeholder}">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('tryOtherPass', this)">Ø¹Ù€</button>
      </div>
      <small id="tryOtherPassError" style="color:var(--danger);display:none;"></small>
    </div>
    <div class="form-actions" style="margin-top:14px;">
      <button class="btn" onclick="closeModal()">${t.cancel || 'Cancel'}</button>
      <button class="btn btn-accent" onclick="tryRecoverWithOtherPass()">${l.btn}</button>
    </div>`;
  document.getElementById('modal').classList.add('show');
}

function tryRecoverWithOtherPass() {
  const otherPass = document.getElementById('tryOtherPass').value;
  const errEl = document.getElementById('tryOtherPassError');
  const failMsgs = { en: 'âŒ Wrong passphrase. Could not decrypt any locked notes.', fr: 'âŒ Mot de passe incorrect. Aucune note dÃ©chiffrÃ©e.', ar: 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©. Ù„Ù… ÙŠØªÙ… ÙÙƒ ØªØ´ÙÙŠØ± Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø©.' };
  const successMsgs = { en: ' note(s) recovered and re-encrypted ðŸ”', fr: ' note(s) rÃ©cupÃ©rÃ©e(s) et re-chiffrÃ©e(s) ðŸ”', ar: ' Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ´ÙÙŠØ±Ù‡Ø§ ðŸ”' };

  if (!otherPass) { errEl.textContent = 'Enter a passphrase'; errEl.style.display = 'block'; return; }
  if (otherPass === state.notePassphrase) { errEl.textContent = i18n[state.lang]?.passSameAsOld || 'That is your current passphrase'; errEl.style.display = 'block'; return; }

  let recovered = 0;
  state.notes = state.notes.map(note => {
    // Skip notes already decryptable with current passphrase
    try {
      const d = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
      JSON.parse(d.toString(CryptoJS.enc.Utf8));
      return note;
    } catch(e) {}

    // Try with the other passphrase
    try {
      const d = CryptoJS.AES.decrypt(note.encrypted, otherPass);
      const data = d.toString(CryptoJS.enc.Utf8);
      JSON.parse(data); // verify valid JSON
      // Re-encrypt with current passphrase
      const newEncrypted = CryptoJS.AES.encrypt(data, state.notePassphrase).toString();
      recovered++;
      return { ...note, encrypted: newEncrypted };
    } catch(e) {
      return note;
    }
  });

  if (recovered > 0) {
    saveState();
    renderNotes();
    closeModal();
    showToast(recovered + (successMsgs[state.lang] || successMsgs.en));
  } else {
    errEl.textContent = failMsgs[state.lang] || failMsgs.en;
    errEl.style.display = 'block';
  }
}

// ===== CHANGE PIN =====
function showChangePinModal() {
  const t = i18n[state.lang];
  document.getElementById('modalContent').innerHTML = `
    <h2>ðŸ”‘ ${t.changePin || 'Change PIN'}</h2>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.currentPin || 'Current PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpOldPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpOldPin', this)">Ø¹Ù€</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.newPin || 'New PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpNewPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpNewPin', this)">Ø¹Ù€</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>${t.confirmNewPin || 'Confirm New PIN'}</label>
      <div class="password-wrapper" style="max-width:160px;">
        <input type="password" id="cpConfirmPin" maxlength="4" inputmode="numeric" placeholder="0000">
        <button type="button" class="btn btn-icon toggle-pass" onclick="togglePasswordVisibility('cpConfirmPin', this)">Ø¹Ù€</button>
      </div>
    </div>
    <p id="cpPinError" style="color:var(--danger);font-size:0.85em;display:none;margin-bottom:10px;"></p>
    <div class="form-actions">
      <button class="btn" onclick="closeModal()">${t.cancel || 'Cancel'}</button>
      <button class="btn btn-accent" onclick="changePin()">ðŸ”’ ${t.confirmPinChange || 'Change PIN'}</button>
    </div>
  `;
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function changePin() {
  const t = i18n[state.lang];
  const oldPin = document.getElementById('cpOldPin').value;
  const newPin = document.getElementById('cpNewPin').value;
  const confirmPin = document.getElementById('cpConfirmPin').value;
  const errEl = document.getElementById('cpPinError');

  if (!oldPin || oldPin.length !== 4 || !/^\d{4}$/.test(oldPin)) {
    errEl.textContent = t.enterValidPin || 'Enter your current 4-digit PIN';
    errEl.style.display = 'block';
    return;
  }

  // Verify old PIN
  if (CryptoJS.SHA256(oldPin).toString() !== state.pin) {
    errEl.textContent = t.wrongPin || 'Current PIN is wrong';
    errEl.style.display = 'block';
    return;
  }

  if (!newPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
    errEl.textContent = t.enterNewPin || 'Enter a new 4-digit PIN';
    errEl.style.display = 'block';
    return;
  }

  if (newPin !== confirmPin) {
    errEl.textContent = t.pinMismatch || "PINs don't match";
    errEl.style.display = 'block';
    return;
  }

  if (oldPin === newPin) {
    errEl.textContent = t.pinSameAsOld || 'New PIN must be different from current';
    errEl.style.display = 'block';
    return;
  }

  state.pin = CryptoJS.SHA256(newPin).toString();
  saveState();
  closeModal();
  showToast(t.pinChanged || 'PIN changed! ðŸ”’');
}

// ===== ISLAMIC SHORTCUTS DRAWER =====
const builtInPhrases = [
  { arabic: 'Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù‡Ù Ù±Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ€Ù°Ù†Ù Ù±Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù', translit: 'Bismillah ir-Rahman ir-Raheem', meaning: { en: 'In the name of Allah, the Most Gracious, the Most Merciful', fr: 'Au nom d\'Allah, le Tout MisÃ©ricordieux, le TrÃ¨s MisÃ©ricordieux', ar: 'Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…' }, builtin: true },
  { arabic: 'Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡', translit: 'Alhamdulillah', meaning: { en: 'Praise be to Allah', fr: 'Louange Ã  Allah', ar: 'Ø§Ù„Ø«Ù†Ø§Ø¡ Ù„Ù„Ù‡' }, builtin: true },
  { arabic: 'Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡', translit: 'SubhanAllah', meaning: { en: 'Glory to Allah', fr: 'Gloire Ã  Allah', ar: 'ØªÙ†Ø²ÙŠÙ‡ Ø§Ù„Ù„Ù‡' }, builtin: true },
  { arabic: 'Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±', translit: 'Allahu Akbar', meaning: { en: 'Allah is the Greatest', fr: 'Allah est le Plus Grand', ar: 'Ø§Ù„Ù„Ù‡ Ù‡Ùˆ Ø§Ù„Ø£ÙƒØ¨Ø±' }, builtin: true },
  { arabic: 'Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡', translit: 'In Shaa Allah', meaning: { en: 'If Allah wills', fr: 'Si Allah le veut', ar: 'Ø¨Ù…Ø´ÙŠØ¦Ø© Ø§Ù„Ù„Ù‡' }, builtin: true },
  { arabic: 'Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡', translit: 'Ma Shaa Allah', meaning: { en: 'What Allah has willed', fr: 'Ce qu\'Allah a voulu', ar: 'Ù…Ø§ Ø£Ø±Ø§Ø¯Ù‡ Ø§Ù„Ù„Ù‡' }, builtin: true },
  { arabic: 'Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹', translit: 'JazakAllahu Khairan', meaning: { en: 'May Allah reward you with good', fr: 'Qu\'Allah vous rÃ©compense', ar: 'Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø£ÙØ¶Ù„ Ø§Ù„Ø¬Ø²Ø§Ø¡' }, builtin: true },
  { arabic: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…', translit: 'Assalamu Alaikum', meaning: { en: 'Peace be upon you', fr: 'La paix soit sur vous', ar: 'ØªØ­ÙŠØ© Ø§Ù„Ø³Ù„Ø§Ù…' }, builtin: true },
  { arabic: 'ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù…', translit: 'Wa Alaikum Assalam', meaning: { en: 'And upon you peace', fr: 'Et sur vous la paix', ar: 'Ø±Ø¯ ØªØ­ÙŠØ© Ø§Ù„Ø³Ù„Ø§Ù…' }, builtin: true },
  { arabic: 'ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…', translit: 'Sallallahu Alaihi Wasallam', meaning: { en: 'Peace and blessings be upon him', fr: 'Paix et bÃ©nÃ©dictions sur lui', ar: 'Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ' }, builtin: true },
  { arabic: 'Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡', translit: 'Astaghfirullah', meaning: { en: 'I seek Allah\'s forgiveness', fr: 'Je demande pardon Ã  Allah', ar: 'Ø·Ù„Ø¨ Ø§Ù„Ù…ØºÙØ±Ø© Ù…Ù† Ø§Ù„Ù„Ù‡' }, builtin: true },
  { arabic: 'Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡', translit: 'La ilaha illAllah', meaning: { en: 'There is no god but Allah', fr: 'Il n\'y a de dieu qu\'Allah', ar: 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ­ÙŠØ¯' }, builtin: true },
  { arabic: 'Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ', translit: 'Barakallahu Fik', meaning: { en: 'May Allah bless you', fr: 'Qu\'Allah vous bÃ©nisse', ar: 'Ø¯Ø¹Ø§Ø¡ Ø¨Ø§Ù„Ø¨Ø±ÙƒØ©' }, builtin: true },
  { arabic: 'Ø­Ø³Ø¨Ù†Ø§ Ø§Ù„Ù„Ù‡ ÙˆÙ†Ø¹Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', translit: 'Hasbunallahu wa ni\'mal Wakeel', meaning: { en: 'Allah is sufficient for us and the best Disposer of affairs', fr: 'Allah nous suffit, Il est le meilleur Garant', ar: 'Ø§Ù„ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡' }, builtin: true },
];

let shortcutsDrawerOpen = false;
let customFormOpen = false;

function getCustomShortcuts() {
  try {
    return JSON.parse(localStorage.getItem('tethkir_custom_shortcuts') || '[]');
  } catch(e) { return []; }
}

function saveCustomShortcuts(list) {
  localStorage.setItem('tethkir_custom_shortcuts', JSON.stringify(list));
}

function toggleShortcutsDrawer() {
  shortcutsDrawerOpen = !shortcutsDrawerOpen;
  document.getElementById('shortcutsDrawer').classList.toggle('open', shortcutsDrawerOpen);
  document.getElementById('shortcutsBackdrop').classList.toggle('open', shortcutsDrawerOpen);
  if (shortcutsDrawerOpen) renderShortcuts();
}

function toggleCustomForm() {
  customFormOpen = !customFormOpen;
  document.getElementById('customShortcutForm').classList.toggle('open', customFormOpen);
  if (customFormOpen) document.getElementById('scArabicInput').focus();
}

function saveCustomShortcut() {
  const arabic = document.getElementById('scArabicInput').value.trim();
  const translit = document.getElementById('scTranslitInput').value.trim();
  const meaning = document.getElementById('scMeaningInput').value.trim();
  if (!arabic) return;

  const customs = getCustomShortcuts();
  customs.push({
    id: Date.now().toString(36),
    arabic,
    translit: translit || '',
    meaning: { en: meaning || '', fr: meaning || '', ar: meaning || '' },
    builtin: false
  });
  saveCustomShortcuts(customs);

  // Clear form
  document.getElementById('scArabicInput').value = '';
  document.getElementById('scTranslitInput').value = '';
  document.getElementById('scMeaningInput').value = '';
  toggleCustomForm();
  renderShortcuts();
  showToast(i18n[state.lang]?.scSaved || 'Custom phrase saved! ðŸ¤²');
}

function deleteCustomShortcut(id) {
  const customs = getCustomShortcuts().filter(c => c.id !== id);
  saveCustomShortcuts(customs);
  renderShortcuts();
  showToast(i18n[state.lang]?.scDeleted || 'Phrase deleted');
}

function insertPhrase(arabic) {
  // Add space separator if preview already has text
  if (kbPreviewText.length > 0 && !kbPreviewText.endsWith(' ')) {
    kbPreviewText += ' ';
  }
  kbPreviewText += arabic;
  updateKbPreview();
  showToast(i18n[state.lang]?.scInserted || 'Phrase added to preview âœ…');
}

function renderShortcuts() {
  const container = document.getElementById('shortcutsList');
  const lang = state.lang;
  const customs = getCustomShortcuts();

  let html = '';

  // Custom phrases first
  if (customs.length > 0) {
    html += `<div class="shortcuts-divider" data-i18n="scCustomLabel">${i18n[lang]?.scCustomLabel || 'âœï¸ YOUR CUSTOM PHRASES'}</div>`;
    customs.forEach(p => {
      const meaningText = typeof p.meaning === 'object' ? (p.meaning[lang] || p.meaning.en || '') : (p.meaning || '');
      html += buildPhraseCard(p.arabic, p.translit, meaningText, p.id, false);
    });
  }

  // Built-in phrases
  html += `<div class="shortcuts-divider" data-i18n="scBuiltinLabel">${i18n[lang]?.scBuiltinLabel || 'ðŸ¤² ISLAMIC PHRASES'}</div>`;
  builtInPhrases.forEach(p => {
    const meaningText = p.meaning[lang] || p.meaning.en;
    html += buildPhraseCard(p.arabic, p.translit, meaningText, null, true);
  });

  container.innerHTML = html;
}

function buildPhraseCard(arabic, translit, meaning, id, isBuiltin) {
  const lang = state.lang;
  const deleteBtn = !isBuiltin ? `<button class="phrase-delete-btn visible" onclick="event.stopPropagation();deleteCustomShortcut('${id}')" title="Delete">ðŸ—‘ï¸</button>` : '';
  const insertHint = i18n[lang]?.scTapToInsert || 'Tap to add to preview';

  return `
    <div class="phrase-card" onclick="insertPhrase('${arabic.replace(/'/g, "\\'")}')">
      <div class="phrase-arabic">${arabic}</div>
      ${translit ? `<div class="phrase-translit">${translit}</div>` : ''}
      ${meaning ? `<div class="phrase-meaning">${meaning}</div>` : ''}
      <div class="phrase-card-footer">
        <span class="phrase-insert-hint">âžœ ${insertHint}</span>
        ${deleteBtn}
      </div>
    </div>`;
}

// ===== ARABIC VIRTUAL KEYBOARD =====
let kbOpen = false;
let kbPreviewText = '';
let lastFocusedInput = null;

// Track last focused input field (but not the keyboard preview)
document.addEventListener('focusin', (e) => {
  if (e.target.matches('input[type="text"], input[type="password"], textarea') && e.target.id !== 'kbPreview') {
    lastFocusedInput = e.target;
  }
});

function toggleKeyboard() {
  kbOpen = !kbOpen;
  document.getElementById('arabicKeyboard').classList.toggle('open', kbOpen);
  document.getElementById('kbToggleBtn').classList.toggle('active', kbOpen);
  document.body.classList.toggle('kb-open', kbOpen);
  document.getElementById('kbToggleBtn').textContent = kbOpen ? 'âŒ¨ï¸ â–¾' : 'âŒ¨ï¸';
}

function kbTypeChar(char) {
  const preview = document.getElementById('kbPreview');
  const start = preview.selectionStart || kbPreviewText.length;
  const end = preview.selectionEnd || kbPreviewText.length;
  kbPreviewText = kbPreviewText.slice(0, start) + char + kbPreviewText.slice(end);
  preview.value = kbPreviewText;
  preview.selectionStart = preview.selectionEnd = start + char.length;
}

function kbBackspace() {
  const preview = document.getElementById('kbPreview');
  const start = preview.selectionStart || kbPreviewText.length;
  const end = preview.selectionEnd || kbPreviewText.length;
  if (start === end && start > 0) {
    kbPreviewText = kbPreviewText.slice(0, start - 1) + kbPreviewText.slice(end);
    preview.value = kbPreviewText;
    preview.selectionStart = preview.selectionEnd = start - 1;
  } else if (start !== end) {
    kbPreviewText = kbPreviewText.slice(0, start) + kbPreviewText.slice(end);
    preview.value = kbPreviewText;
    preview.selectionStart = preview.selectionEnd = start;
  }
}

function kbEnter() {
  kbPasteToField();
}

function updateKbPreview() {
  document.getElementById('kbPreview').value = kbPreviewText || '';
}

function kbCopyPreview() {
  kbPreviewText = document.getElementById('kbPreview').value;
  if (!kbPreviewText) {
    showToast(i18n[state.lang]?.kbNothingToCopy || 'Nothing to copy');
    return;
  }
  // Select the text in preview for visual feedback
  const preview = document.getElementById('kbPreview');
  preview.select();
  // Try modern clipboard API, then fallback
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(kbPreviewText).then(() => {
      showToast(i18n[state.lang]?.kbCopied || 'Copied to clipboard!');
    }).catch(() => { kbCopyFallback(); });
  } else {
    kbCopyFallback();
  }
}

function kbCopyFallback() {
  try {
    document.execCommand('copy');
    showToast(i18n[state.lang]?.kbCopied || 'Copied to clipboard!');
  } catch(e) {
    showToast(i18n[state.lang]?.kbCopyFail || 'Select text in preview and use Ctrl+C');
  }
}

function kbPasteToField() {
  kbPreviewText = document.getElementById('kbPreview').value;
  if (!kbPreviewText) {
    showToast(i18n[state.lang]?.kbNothingToPaste || 'Nothing to paste â€” type something first');
    return;
  }
  if (!lastFocusedInput) {
    showToast(i18n[state.lang]?.kbNoField || 'Click on an input field first');
    return;
  }
  const input = lastFocusedInput;
  const start = input.selectionStart || input.value.length;
  const end = input.selectionEnd || input.value.length;
  const val = input.value;
  input.value = val.slice(0, start) + kbPreviewText + val.slice(end);
  input.selectionStart = input.selectionEnd = start + kbPreviewText.length;
  input.focus();
  input.dispatchEvent(new Event('input', { bubbles: true }));
  kbPreviewText = '';
  document.getElementById('kbPreview').value = '';
  showToast(i18n[state.lang]?.kbPasted || 'Inserted into field');
}

function kbClearPreview() {
  kbPreviewText = '';
  document.getElementById('kbPreview').value = '';
}

// Attach keyboard key events
document.getElementById('arabicKeyboard').addEventListener('click', (e) => {
  const key = e.target.closest('.kb-key');
  if (!key) return;

  // Visual feedback
  key.classList.add('pressed');
  setTimeout(() => key.classList.remove('pressed'), 150);

  const action = key.dataset.action;
  const char = key.dataset.char;

  if (action === 'backspace') {
    kbBackspace();
  } else if (action === 'enter') {
    kbEnter();
  } else if (char) {
    kbTypeChar(char);
  }
});

// Prevent keyboard clicks from stealing focus from inputs (but allow preview input)
document.getElementById('arabicKeyboard').addEventListener('mousedown', (e) => {
  if (e.target.closest('.kb-key') || e.target.closest('.kb-tool-btn')) {
    e.preventDefault();
  }
});

// ===== UPDATE NOTE COUNT HINT ON LOAD =====
function updateNoteCountHint() {
  const hint = document.getElementById('noteCountHint');
  const confirmGroup = document.getElementById('confirmPassGroup');
  const unlockBtn = document.getElementById('unlockBtn');
  const hasNotes = state.notes && state.notes.length > 0;

  if (hasNotes) {
    const count = state.notes.length;
    const msgs = {
      en: `ðŸ”’ You have ${count} encrypted note${count > 1 ? 's' : ''} saved. Enter a passphrase to unlock.`,
      fr: `ðŸ”’ Vous avez ${count} note${count > 1 ? 's' : ''} chiffrÃ©e${count > 1 ? 's' : ''}. Entrez un mot de passe pour dÃ©verrouiller.`,
      ar: `ðŸ”’ Ù„Ø¯ÙŠÙƒ ${count} Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø´ÙØ±Ø©. Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„ÙØªØ­.`
    };
    hint.textContent = msgs[state.lang] || msgs.en;
    hint.style.display = 'block';
    confirmGroup.style.display = 'none';
    unlockBtn.textContent = i18n[state.lang]?.unlock || 'ðŸ”“ Unlock';
  } else {
    hint.style.display = 'none';
    confirmGroup.style.display = 'block';
    const setLabels = { en: 'ðŸ” Set Passphrase & Start', fr: 'ðŸ” DÃ©finir & Commencer', ar: 'ðŸ” ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' };
    unlockBtn.textContent = setLabels[state.lang] || setLabels.en;
  }
}

// ===== TEXT-TO-SPEECH (Read Note Aloud) =====
let ttsUtterance = null;

function speakNote(noteId) {
  // If already speaking, stop
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    // If same note, just stop
    if (ttsUtterance && ttsUtterance._noteId === noteId) {
      ttsUtterance = null;
      return;
    }
  }

  const note = state.notes.find(n => n.id === noteId);
  if (!note || !state.notePassphrase) return;

  try {
    const decrypted = CryptoJS.AES.decrypt(note.encrypted, state.notePassphrase);
    const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    const text = data.title + '. ' + data.content;

    const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langMap[state.lang] || 'en-US';
    utterance.rate = 0.95;
    utterance._noteId = noteId;
    ttsUtterance = utterance;

    utterance.onend = () => { ttsUtterance = null; };
    utterance.onerror = () => { ttsUtterance = null; };

    speechSynthesis.speak(utterance);
  } catch(e) {
    showToast('Cannot read note â€” wrong passphrase?');
  }
}

// ===== SPEECH-TO-TEXT =====
let sttRecognition = null;
let sttActiveBtn = null;

function toggleSTT(inputId, btn) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    showToast('Speech recognition not supported in this browser');
    return;
  }

  // If already listening on this button, stop
  if (sttActiveBtn === btn && sttRecognition) {
    sttRecognition.stop();
    return;
  }

  // If listening on another button, stop that first
  if (sttRecognition) {
    sttRecognition.stop();
  }

  const input = document.getElementById(inputId);
  const recognition = new SR();

  // Map app language to speech lang
  const langMap = { en: 'en-US', fr: 'fr-FR', ar: 'ar-SA' };
  recognition.lang = langMap[state.lang] || 'en-US';
  recognition.continuous = false;
  recognition.interimResults = true;

  let finalText = '';

  recognition.onstart = () => {
    btn.classList.add('listening');
    sttActiveBtn = btn;
    sttRecognition = recognition;
  };

  recognition.onresult = (e) => {
    let interim = '';
    finalText = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        finalText += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Append to existing content
    const existing = input.dataset.sttBase || '';
    if (input.tagName === 'TEXTAREA') {
      input.value = existing + (existing ? ' ' : '') + (finalText || interim);
    } else {
      input.value = existing + (existing ? ' ' : '') + (finalText || interim);
    }
  };

  recognition.onend = () => {
    btn.classList.remove('listening');
    sttActiveBtn = null;
    sttRecognition = null;
    delete input.dataset.sttBase;
    input.focus();
  };

  recognition.onerror = (e) => {
    btn.classList.remove('listening');
    sttActiveBtn = null;
    sttRecognition = null;
    delete input.dataset.sttBase;
    if (e.error === 'not-allowed') {
      showToast('Microphone access denied â€” check browser permissions');
    } else if (e.error !== 'aborted') {
      showToast('Speech error: ' + e.error);
    }
  };

  // Save current input value as base to append to
  input.dataset.sttBase = input.value;
  recognition.start();
}

// ===== START =====
init();
updateNoteCountHint();

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
