<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚≠ê Kids Star Chart</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --yellow: #FFD700;
      --orange: #FF8C00;
      --pink: #FF6B9D;
      --purple: #9B59B6;
      --blue: #3498DB;
      --green: #2ECC71;
      --bg: #1a1a2e;
      --card: #16213e;
      --card2: #0f3460;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
    }
    /* Stars background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, white 0%, transparent 100%),
        radial-gradient(1px 1px at 30% 60%, white 0%, transparent 100%),
        radial-gradient(1px 1px at 50% 10%, white 0%, transparent 100%),
        radial-gradient(1px 1px at 70% 80%, white 0%, transparent 100%),
        radial-gradient(1px 1px at 90% 40%, white 0%, transparent 100%),
        radial-gradient(2px 2px at 20% 90%, rgba(255,215,0,0.6) 0%, transparent 100%),
        radial-gradient(2px 2px at 80% 20%, rgba(255,215,0,0.6) 0%, transparent 100%),
        radial-gradient(1px 1px at 60% 50%, white 0%, transparent 100%);
      pointer-events: none;
      z-index: 0;
    }

    header {
      text-align: center;
      padding: 40px 20px 20px;
      position: relative;
      z-index: 1;
    }
    header h1 {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(2rem, 6vw, 3.5rem);
      font-weight: 800;
      background: linear-gradient(135deg, var(--yellow), var(--orange), var(--pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { filter: drop-shadow(0 0 10px rgba(255,215,0,0.5)); }
      50% { filter: drop-shadow(0 0 25px rgba(255,140,0,0.8)); }
    }
    header p { color: rgba(255,255,255,0.6); font-size: 1rem; margin-top: 6px; }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Add Kid Form */
    .add-kid-card {
      background: linear-gradient(135deg, var(--card), var(--card2));
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255,215,0,0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .add-kid-card h2 {
      font-family: 'Baloo 2', cursive;
      font-size: 1.2rem;
      color: var(--yellow);
      margin-bottom: 14px;
    }
    .input-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .input-row input {
      flex: 1;
      min-width: 150px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid rgba(255,215,0,0.3);
      background: rgba(255,255,255,0.07);
      color: white;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-row input:focus { border-color: var(--yellow); }
    .input-row input::placeholder { color: rgba(255,255,255,0.35); }
    .emoji-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    .emoji-option {
      font-size: 1.5rem;
      cursor: pointer;
      padding: 6px;
      border-radius: 10px;
      border: 2px solid transparent;
      transition: all 0.2s;
      background: rgba(255,255,255,0.05);
    }
    .emoji-option:hover, .emoji-option.selected {
      border-color: var(--yellow);
      background: rgba(255,215,0,0.15);
      transform: scale(1.2);
    }
    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      font-family: 'Baloo 2', cursive;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      color: #1a1a2e;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,140,0,0.4); }
    .btn-danger {
      background: rgba(231,76,60,0.2);
      color: #e74c3c;
      border: 1px solid rgba(231,76,60,0.3);
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 8px;
    }
    .btn-danger:hover { background: rgba(231,76,60,0.4); }

    /* Kids Grid */
    .kids-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .kid-card {
      background: linear-gradient(135deg, var(--card), var(--card2));
      border-radius: 20px;
      padding: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      animation: slideIn 0.4s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .kid-card:hover { transform: translateY(-4px); }

    .kid-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .kid-name {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .kid-avatar {
      font-size: 2rem;
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .kid-name h3 {
      font-family: 'Baloo 2', cursive;
      font-size: 1.2rem;
      font-weight: 800;
    }

    /* Star counter */
    .star-count {
      text-align: center;
      margin: 12px 0;
    }
    .star-number {
      font-family: 'Baloo 2', cursive;
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .star-label { color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 2px; }

    /* Star display */
    .stars-display {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 12px 0;
      min-height: 32px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 8px;
    }
    .star-icon {
      font-size: 1.4rem;
      animation: starPop 0.3s ease;
    }
    @keyframes starPop {
      0% { transform: scale(0) rotate(-180deg); }
      70% { transform: scale(1.3) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* Action buttons */
    .star-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .btn-add-star {
      flex: 1;
      background: linear-gradient(135deg, #FFD700, #FF8C00);
      color: #1a1a2e;
      border: none;
      border-radius: 12px;
      padding: 10px;
      font-family: 'Baloo 2', cursive;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add-star:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(255,140,0,0.5); }
    .btn-remove-star {
      background: rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-remove-star:hover { background: rgba(231,76,60,0.2); color: #e74c3c; }

    /* Progress bar */
    .progress-wrap {
      margin-top: 10px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: rgba(255,255,255,0.45);
      margin-bottom: 5px;
    }
    .progress-bar {
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--yellow), var(--pink));
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    /* Confetti */
    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 9999;
      animation: confettiFall 1.2s ease forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* Firebase status */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.5);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e74c3c;
      transition: background 0.3s;
    }
    .status-dot.connected { background: #2ECC71; animation: blink 2s infinite; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .btn-tool {
      padding: 5px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.7);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-tool:hover { background: rgba(255,255,255,0.15); color: white; }
    .btn-tool.danger:hover { background: rgba(231,76,60,0.25); color: #e74c3c; border-color: rgba(231,76,60,0.4); }
    .btn-tool.spinning { animation: spin 0.6s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.3);
      font-size: 1rem;
    }
    .empty-state .big-emoji { font-size: 3rem; margin-bottom: 10px; }

    /* Config panel */
    .config-panel {
      background: linear-gradient(135deg, var(--card), var(--card2));
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255,107,157,0.3);
    }
    .config-panel h2 { font-family: 'Baloo 2', cursive; color: var(--pink); margin-bottom: 10px; }
    .config-panel p { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 14px; }
    .config-panel textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid rgba(255,107,157,0.3);
      background: rgba(0,0,0,0.3);
      color: white;
      font-family: monospace;
      font-size: 0.8rem;
      height: 80px;
      resize: vertical;
      outline: none;
    }
    .config-panel textarea:focus { border-color: var(--pink); }
  </style>
</head>
<body>

<header>
  <h1>‚≠ê Kids Star Chart</h1>
  <p>Reward your kids with stars for good behavior!</p>
</header>

<div class="container">

  <!-- Firebase Status -->
  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Not connected to Firebase</span>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="btn-tool" id="syncBtn" onclick="syncNow()" title="Sync data from Firebase" style="display:none;">üîÑ Sync</button>
      <button class="btn-tool danger" onclick="clearCache()" title="Clear local cache">üóëÔ∏è Clear Cache</button>
    </div>
  </div>

  <!-- Firebase Config (shown only if not configured) -->
  <div class="config-panel" id="configPanel">
    <h2>üî• Connect to Firebase</h2>
    <p>Paste your Firebase config JSON to sync data across devices. Or skip to use local storage only.</p>
    <textarea id="firebaseConfigInput" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="btn btn-primary" onclick="connectFirebase()">üî• Connect Firebase</button>
      <button class="btn" style="background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.6);" onclick="skipFirebase()">Skip (local only)</button>
    </div>
  </div>

  <!-- Add Kid Form -->
  <div class="add-kid-card" id="addKidCard" style="display:none;">
    <h2>‚ûï Add a Child</h2>
    <div class="input-row">
      <input type="text" id="kidNameInput" placeholder="Child's name (e.g. Adam)" maxlength="20"/>
      <button class="btn btn-primary" onclick="addKid()">Add ‚ú®</button>
    </div>
    <div class="emoji-picker" id="emojiPicker">
      <span class="emoji-option selected" data-emoji="üßí">üßí</span>
      <span class="emoji-option" data-emoji="üë¶">üë¶</span>
      <span class="emoji-option" data-emoji="üëß">üëß</span>
      <span class="emoji-option" data-emoji="ü¶Å">ü¶Å</span>
      <span class="emoji-option" data-emoji="üêª">üêª</span>
      <span class="emoji-option" data-emoji="üêº">üêº</span>
      <span class="emoji-option" data-emoji="ü¶ä">ü¶ä</span>
      <span class="emoji-option" data-emoji="üê∏">üê∏</span>
      <span class="emoji-option" data-emoji="ü¶ã">ü¶ã</span>
      <span class="emoji-option" data-emoji="üåü">üåü</span>
    </div>
  </div>

  <!-- Kids Grid -->
  <div class="kids-grid" id="kidsGrid">
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="big-emoji">üåü</div>
      <p>No kids yet! Add a child above to get started.</p>
    </div>
  </div>

</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  let db = null;
  let selectedEmoji = 'üßí';
  let unsubscribe = null;
  let kidsLocal = {}; // fallback local storage

  // Emoji picker
  document.querySelectorAll('.emoji-option').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedEmoji = el.dataset.emoji;
    });
  });

  // Connect Firebase
  window.connectFirebase = function() {
    const input = document.getElementById('firebaseConfigInput').value.trim();
    try {
      const config = JSON.parse(input);
      const app = initializeApp(config);
      db = getFirestore(app);
      document.getElementById('configPanel').style.display = 'none';
      document.getElementById('addKidCard').style.display = 'block';
      document.getElementById('statusDot').classList.add('connected');
      document.getElementById('statusText').textContent = 'Connected to Firebase ‚òÅÔ∏è';
      document.getElementById('syncBtn').style.display = 'inline-block';
      localStorage.setItem('fbConfig', input);
      listenToKids();
    } catch(e) {
      alert('‚ùå Invalid Firebase config JSON. Please check and try again.');
    }
  };

  window.skipFirebase = function() {
    document.getElementById('configPanel').style.display = 'none';
    document.getElementById('addKidCard').style.display = 'block';
    document.getElementById('statusText').textContent = 'Local mode (no sync)';
    const saved = localStorage.getItem('kidsLocal');
    if (saved) kidsLocal = JSON.parse(saved);
    renderLocalKids();
  };

  // Try auto-connect from saved config
  const savedConfig = localStorage.getItem('fbConfig');
  if (savedConfig) {
    document.getElementById('firebaseConfigInput').value = savedConfig;
    try {
      const config = JSON.parse(savedConfig);
      const app = initializeApp(config);
      db = getFirestore(app);
      document.getElementById('configPanel').style.display = 'none';
      document.getElementById('addKidCard').style.display = 'block';
      document.getElementById('statusDot').classList.add('connected');
      document.getElementById('statusText').textContent = 'Connected to Firebase ‚òÅÔ∏è';
      document.getElementById('syncBtn').style.display = 'inline-block';
      listenToKids();
    } catch(e) { /* ignore */ }
  }

  function listenToKids() {
    if (unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(collection(db, 'kids'), snapshot => {
      const grid = document.getElementById('kidsGrid');
      grid.innerHTML = '';
      if (snapshot.empty) {
        grid.innerHTML = '<div class="empty-state"><div class="big-emoji">üåü</div><p>No kids yet! Add a child above.</p></div>';
        return;
      }
      snapshot.forEach(docSnap => {
        const kid = { id: docSnap.id, ...docSnap.data() };
        grid.appendChild(buildKidCard(kid));
      });
    });
  }

  function renderLocalKids() {
    const grid = document.getElementById('kidsGrid');
    grid.innerHTML = '';
    const keys = Object.keys(kidsLocal);
    if (keys.length === 0) {
      grid.innerHTML = '<div class="empty-state"><div class="big-emoji">üåü</div><p>No kids yet! Add a child above.</p></div>';
      return;
    }
    keys.forEach(id => grid.appendChild(buildKidCard({ id, ...kidsLocal[id] })));
  }

  function buildKidCard(kid) {
    const stars = kid.stars || 0;
    const goal = kid.goal || 10;
    const pct = Math.min(100, Math.round((stars / goal) * 100));
    const starIcons = '‚≠ê'.repeat(Math.min(stars, 20)) + (stars > 20 ? ` +${stars-20}` : '');

    const card = document.createElement('div');
    card.className = 'kid-card';
    card.innerHTML = `
      <div class="kid-header">
        <div class="kid-name">
          <div class="kid-avatar">${kid.emoji || 'üßí'}</div>
          <div>
            <h3>${kid.name}</h3>
            <div style="font-size:0.78rem;color:rgba(255,255,255,0.4);">Goal: ${goal} ‚≠ê</div>
          </div>
        </div>
        <button class="btn-danger" onclick="removeKid('${kid.id}')">üóëÔ∏è</button>
      </div>
      <div class="star-count">
        <div class="star-number">${stars}</div>
        <div class="star-label">stars earned</div>
      </div>
      <div class="stars-display">${starIcons || '<span style="color:rgba(255,255,255,0.2);font-size:0.85rem;">No stars yet...</span>'}</div>
      <div class="progress-wrap">
        <div class="progress-label"><span>Progress to goal</span><span>${pct}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="star-actions">
        <button class="btn-add-star" onclick="addStar('${kid.id}', ${stars})">‚≠ê Give Star!</button>
        <button class="btn-remove-star" onclick="removeStar('${kid.id}', ${stars})">‚àí</button>
      </div>
    `;
    return card;
  }

  window.syncNow = async function() {
    if (!db) return;
    const btn = document.getElementById('syncBtn');
    btn.textContent = 'üîÑ';
    btn.classList.add('spinning');
    btn.disabled = true;
    // Force re-listen (triggers fresh snapshot)
    if (unsubscribe) unsubscribe();
    await new Promise(r => setTimeout(r, 600));
    listenToKids();
    btn.classList.remove('spinning');
    btn.textContent = 'üîÑ Sync';
    btn.disabled = false;
    // Show brief toast
    showToast('‚úÖ Synced from Firebase!');
  };

  window.clearCache = function() {
    if (!confirm('Clear all local cache? (Firebase data is safe, only local storage is cleared)')) return;
    localStorage.removeItem('kidsLocal');
    localStorage.removeItem('fbConfig');
    kidsLocal = {};
    showToast('üóëÔ∏è Cache cleared! Reloading...');
    setTimeout(() => location.reload(), 1000);
  };

  function showToast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
      background:#1a1a2e;border:1px solid rgba(255,215,0,0.4);color:white;
      padding:10px 20px;border-radius:12px;font-family:Nunito,sans-serif;
      font-size:0.9rem;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.5);
      animation:slideUp 0.3s ease;`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  window.addKid = async function() {
    const name = document.getElementById('kidNameInput').value.trim();
    if (!name) { alert('Please enter a name!'); return; }
    const id = Date.now().toString();
    const kid = { name, emoji: selectedEmoji, stars: 0, goal: 10 };
    if (db) {
      await setDoc(doc(db, 'kids', id), kid);
    } else {
      kidsLocal[id] = kid;
      localStorage.setItem('kidsLocal', JSON.stringify(kidsLocal));
      renderLocalKids();
    }
    document.getElementById('kidNameInput').value = '';
  };

  window.addStar = async function(id, current) {
    const newStars = current + 1;
    if (db) {
      await updateDoc(doc(db, 'kids', id), { stars: newStars });
    } else {
      kidsLocal[id].stars = newStars;
      localStorage.setItem('kidsLocal', JSON.stringify(kidsLocal));
      renderLocalKids();
    }
    launchConfetti();
    if (newStars % 10 === 0) setTimeout(() => alert(`üéâ Amazing! ${newStars} stars! Keep it up!`), 300);
  };

  window.removeStar = async function(id, current) {
    if (current <= 0) return;
    if (db) {
      await updateDoc(doc(db, 'kids', id), { stars: current - 1 });
    } else {
      kidsLocal[id].stars = current - 1;
      localStorage.setItem('kidsLocal', JSON.stringify(kidsLocal));
      renderLocalKids();
    }
  };

  window.removeKid = async function(id) {
    if (!confirm('Remove this child?')) return;
    if (db) {
      await deleteDoc(doc(db, 'kids', id));
    } else {
      delete kidsLocal[id];
      localStorage.setItem('kidsLocal', JSON.stringify(kidsLocal));
      renderLocalKids();
    }
  };

  function launchConfetti() {
    const colors = ['#FFD700','#FF6B9D','#3498DB','#2ECC71','#9B59B6','#FF8C00'];
    for (let i = 0; i < 30; i++) {
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = '-20px';
      el.style.background = colors[Math.floor(Math.random() * colors.length)];
      el.style.animationDuration = (0.8 + Math.random() * 0.8) + 's';
      el.style.animationDelay = Math.random() * 0.3 + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }
  }
</script>
</body>
</html>
